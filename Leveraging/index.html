
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://faisalmemon.github.io/the-road-to-zero/Leveraging/">
      
      
        <link rel="prev" href="../InspectingMobileSafari/">
      
      
        <link rel="next" href="../Defense/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.2">
    
    
      
        <title>Leveraging Research - The Road to Zero</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.f56500e0.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#leveraging-research" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="The Road to Zero" class="md-header__button md-logo" aria-label="The Road to Zero" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            The Road to Zero
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Leveraging Research
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/faisalmemon/the-road-to-zero/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="The Road to Zero" class="md-nav__button md-logo" aria-label="The Road to Zero" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    The Road to Zero
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/faisalmemon/the-road-to-zero/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Author/" class="md-nav__link">
        About
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../ZeroDay/" class="md-nav__link">
        Zero Day
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Hammer/" class="md-nav__link">
        The Hammer
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Mach/" class="md-nav__link">
        Mach Programming
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../KernelDebugging/" class="md-nav__link">
        Kernel Debugging
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../JailbreakSetup/" class="md-nav__link">
        Jailbreak Setup
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../InspectingMobileSafari/" class="md-nav__link">
        Inspecting Mobile Safari
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Leveraging Research
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Leveraging Research
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#security-bulletins" class="md-nav__link">
    Security Bulletins
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bug-clustering" class="md-nav__link">
    Bug Clustering
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#keeping-to-a-promising-track" class="md-nav__link">
    Keeping to a promising track
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#studying-from-weakness" class="md-nav__link">
    Studying from Weakness
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#case-study-cve-2020-9934" class="md-nav__link">
    Case study CVE-2020-9934
  </a>
  
    <nav class="md-nav" aria-label="Case study CVE-2020-9934">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#digression-lab-machine-setup" class="md-nav__link">
    Digression: Lab machine setup
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#studying-brctl" class="md-nav__link">
    Studying brctl
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Defense/" class="md-nav__link">
        iOS Defense Mechanisms
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../AttackSurface/" class="md-nav__link">
        Attack Surface
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../KernelBugHunting/" class="md-nav__link">
        Kernel Bug Hunting
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Bibliography/" class="md-nav__link">
        Bibliography
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#security-bulletins" class="md-nav__link">
    Security Bulletins
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#bug-clustering" class="md-nav__link">
    Bug Clustering
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#keeping-to-a-promising-track" class="md-nav__link">
    Keeping to a promising track
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#studying-from-weakness" class="md-nav__link">
    Studying from Weakness
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#case-study-cve-2020-9934" class="md-nav__link">
    Case study CVE-2020-9934
  </a>
  
    <nav class="md-nav" aria-label="Case study CVE-2020-9934">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#digression-lab-machine-setup" class="md-nav__link">
    Digression: Lab machine setup
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#studying-brctl" class="md-nav__link">
    Studying brctl
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  



<h1 id="leveraging-research">Leveraging Research</h1>
<h2 id="security-bulletins">Security Bulletins</h2>
<p>One strategy for learning and exploration is to stick on an old version of iOS for which we have a Jailbreak.  Then look at each security bulletin from Apple to see what vulnerabilities have been fixed.  Using the CVE number, it is easy to google for write-ups for these.  For example, search for "CVE-2020â€“9934 poc" meaning "proof of concept for CVE-2020-9934".  We should note, however, that only a minority of CVEs have an associated write-up.</p>
<p>A list of security bulletins can be reached from <a href="../Bibliography/#IVH">iOS Version History</a>.  Apple documents them in links of the form <a href="../Bibliography/#S136">HT211288</a>.  This particular example lists the vulnerability
<div class="highlight"><pre><span></span><code>CVE-2020-9934: Matt Shockley (linkedin.com/in/shocktop)
</code></pre></div>
amongst many others for iOS 13.6 (iOS 13.6 produced an extremely long security bulletin).</p>
<p>If we are lucky the newer exploit is applicable to our older iOS version.</p>
<h2 id="bug-clustering">Bug Clustering</h2>
<p>Even if a new CVE is not applicable to our old iOS version, it can generate research ideas worth exploring.  When security bugs are found, often they are clustered, and perhaps only the instance of the bug in a Proof-of-Concept reported by the security researcher is addressed.  The adjacent bugs are sometimes ignored.</p>
<p>Given that security bugs can be "clustered", a confirmed fix of any security bug can offer good research opportunities in neighbouring code or functionality.</p>
<h2 id="keeping-to-a-promising-track">Keeping to a promising track</h2>
<p>No doubt, it takes a lot of perserverence to find a vulnerability.  We need to give ourselves the best chance of getting rewarded with a result because otherwise our motivation levels can wane.  If we think of bug hunting as a game, the best games are where the goal is reachable with some effort, but not beyond our abilities.</p>
<p>Furthermore we need to keep things in balance.  Consider the example of programming in a new domain.  Randomly diving in, making elementary errors, and then constantly hitting the Stack Overflow website for answers is not productive.  At the opposite extreme, studying all the books in the domain area means we have knowledge but little resiliance.  We only know what we are taught.  And this material is easily forgotten due to a lack of practical reinforcement.</p>
<p>For hacking to be a journey, we need to be willing just to try and experiment, and explore what we can.  Then back that up with formal reading, or exercises which build a specific skill, such as reverse engineering or Return-Oriented Programming.  But our experiments cannot be too random.  This is where following similar footsteps of others can help out.</p>
<h2 id="studying-from-weakness">Studying from Weakness</h2>
<p>Another way of looking at things is to study the CWE.  The <a href="../Bibliography/#CWE">Common Weakness Enumeration</a> goes through the classes of security errors that our made.  In the same way that learning design patterns gives us the mental langauge to observe and identify design issues and solutions in software, the CWE helps sharpen our eye for mistakes we want to exploit.</p>
<p>We don't want to study a piece of code blindly and miss vulnerabilities.  It would be like propecting for gold, but not knowing what unprocessed natural gold deposits look like.</p>
<h2 id="case-study-cve-2020-9934">Case study CVE-2020-9934</h2>
<p>The vulnerability, recorded as CVE-2020-9934, as found by Matt Shockley, and recorded in his <a href="https://medium.com/@mattshockl/cve-2020-9934-bypassing-the-os-x-transparency-consent-and-control-tcc-framework-for-4e14806f1de8">write-up</a> is a good example of how we can learn from weaknesses found by others.</p>
<p>In brief, this vulnerability is that the Trust, Consent, and Control Framework (TCC) can be subverted through the use of maliciously supplied environmental variables.</p>
<p>The weakness may be classified as <a href="https://cwe.mitre.org/data/definitions/20.html">CWE-20: Improper Input Validation</a>.  This in turn is related to the Common Attack Pattern <a href="http://capec.mitre.org/data/definitions/13.html">CAPEC-13: Subverting Environment Variable Values</a>.</p>
<p>We assume the reader has gone through this write-up.  Here we do a meta analysis; we look at the <em>thinking</em> that possibly went into the attack.</p>
<p>We see that TCC is valuable because we want to attack sensitive resources without triggering User Interface pop-up dialogs asking for permission.</p>
<p>TCC is controlled by entitlements.  Which entitlement?  Looking at the framework</p>
<div class="highlight"><pre><span></span><code>codesign -d --entitlements - \
/System/Library/PrivateFrameworks/TCC.framework/Resources/tccd

Executable=/System/Library/PrivateFrameworks/TCC.framework/Versions/A/Resources/tccd
[Dict]
    [Key] com.apple.private.tcc.manager
    [Value]
        [Bool] true
    [Key] com.apple.rootless.storage.TCC
    [Value]
        [Bool] true
    [Key] com.apple.fileprovider.acl-read
    [Value]
        [Bool] true
    [Key] com.apple.private.security.storage.TCC
    [Value]
        [Bool] true
    [Key] com.apple.private.system-extensions.tcc
    [Value]
        [Bool] true
    [Key] com.apple.private.kernel.global-proc-info
    [Value]
        [Bool] true
    [Key] com.apple.private.notificationcenterui.tcc
    [Value]
        [Bool] true
    [Key] com.apple.private.responsibility.set-arbitrary
    [Value]
        [Bool] true
    [Key] com.apple.private.coreservices.canmaplsdatabase
    [Value]
        [Bool] true
    [Key] com.apple.private.tcc.allow
    [Value]
        [Array]
            [String] kTCCServiceSystemPolicyAllFiles
</code></pre></div>
<p>The entitlement of interest is <code>com.apple.private.tcc.manager</code>.</p>
<p>The attacker merely went straight for the <code>tccd</code> daemon.  This is the logical first choice.</p>
<p>If this vulnerability is part of a cluster of bugs, we can find other potentially vulnerable daemons via a look up against the <a href="../Bibliography/#ED">Entitlements Cross-Reference</a>.  The specific query would be <a href="http://newosxbook.com/ent.jl?ent=com.apple.private.tcc.manager&amp;osVer=OSX">http://newosxbook.com/ent.jl?ent=com.apple.private.tcc.manager&amp;osVer=OSX</a>.</p>
<p>The full search results are <a href="../tcc_manager_daemons.txt">tcc_manager_daemons.txt</a>.</p>
<p>We can search to occurences of "HOME" using:
<div class="highlight"><pre><span></span><code>for item in $(cat tcc_manager_daemons.txt)
do
    strings $item 2&gt;/dev/null | grep -l HOME --label $item 
done
</code></pre></div></p>
<p>to yield:
<div class="highlight"><pre><span></span><code>/System/Library/PrivateFrameworks/CloudDocsDaemon.framework/XPCServices/ContainerMetadataExtractor.xpc/Contents/MacOS/ContainerMetadataExtractor
/System/Library/PrivateFrameworks/CloudKitDaemon.framework/Support/cloudd
/System/Library/PrivateFrameworks/SyncedDefaults.framework/Support/syncdefaultsd
/System/Library/PrivateFrameworks/TCC.framework/Versions/A/Resources/tccd
/usr/bin/brctl
/usr/libexec/fmfd
/usr/libexec/pkd
</code></pre></div></p>
<p>All of these programs and daemons look interesting.  They are all privileged.  Some are obscure and lesser used functionality.  For example <code>brctl</code> appears to be a low level manipulation and diagnostics tool for iCloud.</p>
<p>When exploring data-sensitive commands, it is best we establish a safe lab environment.  This is because we don't want to delete or damage our own production data.</p>
<h3 id="digression-lab-machine-setup">Digression: Lab machine setup</h3>
<p>When we do static analysis we should use an "orange" environment.  This is a separate environment where we run tools against software to inspect them.</p>
<p>When we do dynamic analysis we should use a "red" environment.  This is a separate environment where code is executed.</p>
<p>A typical way to do things is to use an Intel-based Mac.  Install it with a special Apple ID used only for security research.  Potentially this could be a paid for Apple developer account that can be used to code sign binaries.</p>
<p>Then create a Virtual Machine on the Mac and install it with a different Apple ID which is not connected with a paid developer account.  This whole machine should be snapshot-ed so experiments can be done and then the configuration reverted.</p>
<h3 id="studying-brctl">Studying <code>brctl</code></h3>
<p>In a red environment we can play around with the <code>brctl</code> command.
If we create a file and directory structure:
<div class="highlight"><pre><span></span><code>ParentFolder/sampleText.txt
</code></pre></div>
and this lives under the iCloud Drive of user <code>redtestsecure</code> we have
<div class="highlight"><pre><span></span><code>/Users/redtestsecure/Library/Mobile Documents/com~apple~CloudDocs/
</code></pre></div>
as the root directory of <code>ParentFolder</code>.</p>
<p>To throw away the local file <code>sampleText.txt</code> so as to tell iCloud that it would need to re-download the file (in contrast to propagating the deletion of the file to the cloud) we would run the command
<div class="highlight"><pre><span></span><code>brctl evict ./sampleText.txt
</code></pre></div>
Immediately the cloud download icon would appear on the Finder GUI for this file.</p>
<p>At this point we are ready to do some hacking.  We know there is at least some chance of a vulnerability through the HOME environmental variable since there was a prior bug using this approach.  We also know that this program is privileged so would definately produce valuable results if there was an exploit.  Access to sensitive data is called out for bug bounties on the Apple Bug bounty program.</p>
<p>The next steps would be to learn more about the utility, and then study the program's internals via reverse engineering.</p>
<p>Whilst we have not turned up an actual exploit so far, we have shared some insights for how a hacker would think about attacking, in this case, macOS.  Once we had an exploit then it might be possible to cross-leverage our knowledge to attack iOS.  Both systems use TCC.</p>
<p>Going back to a theme raised at the beginning of our book, we could profit by having two projects on-going.  One project is hacking the system.  That is something destructive.  The other project is writing some application or software.  That is something constructive.</p>
<p>So at this point, a good idea would be to develop an iCloud drive management program alongside our hacking research.  Apple don't provide any user interface to force synchronization of our files.  It happens "by magic" without any user side control knobs.</p>
<p>This means that even if <code>brctl</code> does not turn up any good hacks, we might end up with a tool we could share or sell as part of the effort.  It is easy to see that this dual-approach would help keep us motivated along this journey.  We could switch between software engineering and hacking to maintain our interest.</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.12658920.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.5cf534bf.min.js"></script>
      
    
  </body>
</html>