
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="https://faisalmemon.github.io/the-road-to-zero/Mach/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-7.3.6">
    
    
      
        <title>Mach - The Road to Zero</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.a57b2b03.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#mach-programming" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="The Road to Zero" class="md-header__button md-logo" aria-label="The Road to Zero" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            The Road to Zero
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Mach
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/faisalmemon/the-road-to-zero/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="The Road to Zero" class="md-nav__button md-logo" aria-label="The Road to Zero" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    The Road to Zero
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/faisalmemon/the-road-to-zero/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Author/" class="md-nav__link">
        About
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Introduction/" class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../ZeroDay/" class="md-nav__link">
        Zero Day
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Hammer/" class="md-nav__link">
        The Hammer
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Mach
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Mach
      </a>
      
        


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#motivation" class="md-nav__link">
    Motivation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mach-fundamental-abstractions" class="md-nav__link">
    Mach Fundamental Abstractions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-learn-mach-programming" class="md-nav__link">
    How to learn Mach programming
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#memory-allocation" class="md-nav__link">
    Memory Allocation
  </a>
  
    <nav class="md-nav" aria-label="Memory Allocation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#memory-allocation-discussion" class="md-nav__link">
    Memory Allocation discussion
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#copy-on-write-memory" class="md-nav__link">
    Copy-on-Write Memory
  </a>
  
    <nav class="md-nav" aria-label="Copy-on-Write Memory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#copy-on-write-discussion" class="md-nav__link">
    Copy-on-Write Discussion
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-steps" class="md-nav__link">
    Further steps
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../KernelDebugging/" class="md-nav__link">
        Kernel Debugging
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../BootingDevelopmentKernel/" class="md-nav__link">
        Booting a Development Kernel
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../JailbreakSetup/" class="md-nav__link">
        Jailbreak Setup
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Bibliography/" class="md-nav__link">
        Bibliography
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#motivation" class="md-nav__link">
    Motivation
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mach-fundamental-abstractions" class="md-nav__link">
    Mach Fundamental Abstractions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#how-to-learn-mach-programming" class="md-nav__link">
    How to learn Mach programming
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#memory-allocation" class="md-nav__link">
    Memory Allocation
  </a>
  
    <nav class="md-nav" aria-label="Memory Allocation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#memory-allocation-discussion" class="md-nav__link">
    Memory Allocation discussion
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#copy-on-write-memory" class="md-nav__link">
    Copy-on-Write Memory
  </a>
  
    <nav class="md-nav" aria-label="Copy-on-Write Memory">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#copy-on-write-discussion" class="md-nav__link">
    Copy-on-Write Discussion
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#further-steps" class="md-nav__link">
    Further steps
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/faisalmemon/the-road-to-zero/edit/master/docs/Mach.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="mach-programming">Mach Programming</h1>
<h2 id="motivation">Motivation</h2>
<p>The Operating Systems we know as iOS\index{OS!iOS}, macOS\index{OS!macOS}, tvOS\index{OS!tvOS}, etc. are really different flavors of the Darwin\index{OS!Darwin} Operating System.  The same code base but compiled with different macro preprocessor flags.</p>
<p>The kernel of Darwin is XNU.  The fundamental interface to XNU is via the Mach programming interface.  At its core, XNU is based upon Mach messages.</p>
<p>The reason why we want to do Mach programming is because it is an interface available from user mode that can affect, leak or subvert the XNU kernel since they share the same data abstractions and programming methodology.  Furthermore the fundamental abstractions are available as Open Source so can be inspected and understood easily.</p>
<p>One way to think about Mach is to consider it a fundamental building block that can be used to build out an Operating System personality.</p>
<p>Apple have created a UNIX personality for Darwin using Mach as an enabling technology.  That is why there seems to be two competing interfaces in Darwin, the Mach programming interface, and the UNIX syscall interface.</p>
<p>It is straightforward to learn the UNIX syscall interface, because it follows the same paradigm as Linux.  There are therefore many books and example programs written against the UNIX syscall interface.  The details will vary but the approach is the same.</p>
<p>The Mach programming interface is somewhat esoteric.  Apple seem to like to pretend that it does not exist.  Even experienced iOS programmers will know  little to nothing about it.  However, time and again, this interface will be used to build exploits, so it is something we shall learn.</p>
<p>The original idea with Mach was to extend UNIX with new capabilities to tackle the emergence of multiprocessor systems and distributed computing more naturally.  The solution was to add a new set of messaging primitives.  [@machsyscalls]</p>
<p>When correctly coded, Mach based solutions can be elegant.  When incorrectly coded, Mach based code offers an expansive attack surface.  We shall study different techniques that abuse the Mach messaging system, such as Type Confusion.  Furthermore, Mach based attacks can be Data oriented attacks, which side-step the traditional mitigations in the Operating System (such as stack overflow protection and control flow integrity).</p>
<h2 id="mach-fundamental-abstractions">Mach Fundamental Abstractions</h2>
<p>Mach [@machconcepts] is built upon the following abstractions:</p>
<table>
<thead>
<tr>
<th>Entry</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>task</code></td>
<td>An execution environment.</td>
</tr>
<tr>
<td><code>thread</code></td>
<td>The basic unit of execution.</td>
</tr>
<tr>
<td><code>port</code></td>
<td>A communication channel.</td>
</tr>
<tr>
<td><code>message</code></td>
<td>A typed collection of data used for communication between threads.</td>
</tr>
</tbody>
</table>
<p>In the original formulation, tasks could be on the same machine, on different processors in the machine, or on different machines.  Such tasks become active entities when they host one or more threads.  And threads can communicate with each other using well-defined interfaces that are invariant to whether the recipient is on the same machine or on a different machine.</p>
<p>In reality, due to the irrepressible properties of distributed communication, latency and reliability cannot be ignored.  Therefore, such a uniform communication abstraction cannot work out satisfactorily in real systems.  However, within a CPU with threads from the same task, or tasks in a parent-child relationship, the inherently well design message passing abstraction comes into its own.  This is where the XNU kernel does its work and shines.</p>
<h2 id="how-to-learn-mach-programming">How to learn Mach programming</h2>
<p>Mach is not so easy to learn.  There are few modern programs on GitHub to look at.  One way into the topic is to study the NEXTSTEP\index{trademark!NEXTSTEP} documentation, [@machconcepts].  Despite its age, it is a well structured explanation of the concepts.  Another source of documentation are the header files on macOS.</p>
<p>We can find the header file directory with:</p>
<pre><code># find /Applications/Xcode.app -type d -iname mach
/Applications/Xcode.app/Contents/Developer/Platforms/AppleTVOS.pl
atform/Developer/SDKs/AppleTVOS.sdk/usr/include/mach
/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.pla
tform/Developer/SDKs/iPhoneOS.sdk/usr/include/mach
.
.
.
</code></pre>
<p>Rather than duplicate or replace the NEXTSTEP documentation, we assume the reader will read all of that documentation, but for the practical work elements, refer to this book.  This book then acts as a modernization of the original materials.  As mentioned in the Introduction, this book is largely a tutorial guide to get us along the path to being able to find 0-day vulnerabilities.</p>
<h2 id="memory-allocation">Memory Allocation</h2>
<p>Here we follow along the [@machconcepts] documentation but with modernized code examples.  These are available at [@trtzgithub] in the subdirectory <code>source/mach-vm-alloc</code></p>
<p>Here is code that demonstrates how to allocate memory with Mach, how to duplicate memory, and then how to free memory.</p>
<pre><code class="language-c">int vm_example()
{
    union data_area {
        char                *indexed;
        vm_address_t        handle;
    } data1, data2;

    vm_size_t               i;
    vm_size_t               min;
    mach_msg_type_number_t  data_cnt;
    mach_port_t             self;
    char                    *error = NULL;
    kern_return_t           rv = KERN_SUCCESS;

    printf(&quot;\nSTART: vm_example()\n&quot;);

    self = mach_task_self();

    printf(&quot;mach_task_self is 0x%x\n&quot;, self);

    rv = vm_allocate(self,
                     &amp;data1.handle,
                     vm_page_size,
                     TRUE);
    if (rv != KERN_SUCCESS) {
        error = &quot;Could not vm_allocate&quot;;
        goto vm_example_error_return;
    }

    for (i = 0; (i &lt; vm_page_size); i++) {
        data1.indexed[i] = i;
    }
    printf(&quot;Filled space allocated with some data.\n&quot;);
    printf(&quot;Doing vm_read....\n&quot;);
    rv = vm_read(self,
                 data1.handle,
                 vm_page_size,
                 &amp;data2.handle,
                 &amp;data_cnt);
    if(rv != KERN_SUCCESS) {
        error = &quot;Could not vm_read&quot;;
        goto vm_example_error_return;
    }
    printf(&quot;Successful vm_read.\n&quot;);

    if (vm_page_size != data_cnt) {
        error = &quot;vmread: Number of bytes read not equal to number
 available and requested.&quot;;
        goto vm_example_logic_error_return;
    }
    min = (vm_page_size &lt; data_cnt) ? vm_page_size : data_cnt;

    for (i = 0; (i &lt; min); i++) {
        if (data1.indexed[i] != data2.indexed[i]) {
            error = &quot;Data not read correctly&quot;;
            goto vm_example_logic_error_return;
        }
    }
    printf(&quot;Checked data successfully.\n&quot;);

    rv = vm_deallocate(self,
                       data1.handle,
                       vm_page_size);
    if (rv != KERN_SUCCESS) {
        error = &quot;Could not vm_deallocate&quot;;
        goto vm_example_error_return;
    }

    rv = vm_deallocate(self,
                       data2.handle,
                       data_cnt);
    if (rv != KERN_SUCCESS) {
        error = &quot;Could not vm_deallocate&quot;;
        goto vm_example_error_return;
    }

    printf(&quot;END: vm_example()\n&quot;);
    return 0;

vm_example_error_return:
    printf(&quot;%s: %s\n&quot;, error, mach_error_string(rv));
    return -1;

vm_example_logic_error_return:
    printf(&quot;%s\n&quot;, error);
    return -1;
}
</code></pre>
<h3 id="memory-allocation-discussion">Memory Allocation discussion</h3>
<p>In our code example, there are two stylistic points to note:</p>
<ol>
<li>
<p>We use a union to clearly characterise that Mach calls accept a handle, which is a <code>vm_address_t</code> but is clearly also just a raw pointer, <code>char *</code>, so we create a union comprising these two types depending on whether we are issuing Mach calls or doing normal C-based pointer arithmetic.  The union avoids us having to use type casts.</p>
</li>
<li>
<p>We use a <code>goto</code> idiom to handle errors.  All our <code>goto</code> statements go forwards (so don't generate loops in our code) and just handle the error cases.  This makes such exception handling clean without too much code repetition.  That is useful because nearly all our function calls can return an error to be checked.</p>
</li>
</ol>
<p>In our code we make the following observations:</p>
<ol>
<li>
<p>We need to have the port of the task before any of the system calls can be made because any message port the system returns is namespaced to port of the task it relates to. <code>mach_task_self()</code> provides us this.  It is not actually a function call, it is a #define which provides us our thread-specific task value.  The value is typically a small integer.</p>
</li>
<li>
<p><code>vm_allocate()</code> allocates memory.  It is logical to ask for a page sized amount of memory because this is the unit of memory upon which virtual protection and management is done.  This will be 16 KiB.</p>
</li>
<li>
<p><code>vm_read()</code> actually also allocates memory as <code>vm_allocate()</code> does.  The function names do not have a nomenclature that tells us this, so it is worthwhile checking the function meaning each time until we are familiar with them.</p>
</li>
<li>
<p><code>vm_deallocate()</code> deallocates our memory; we did a <code>vm_allocate()</code> and a <code>vm_read()</code> allocation so there are two pages of memory to free up.</p>
</li>
<li>
<p>It is a good practice to check return values against <code>!= KERN_SUCCESS</code> and let <code>mach_error_string</code> handle the different possible error return values, since there are many error values possible.</p>
</li>
</ol>
<p>This <code>vm_example()</code> code merely needs to be hooked into our App code when it launches, in the <code>main()</code> function to operate.  It does feel heavyweight for what it does.</p>
<h2 id="copy-on-write-memory">Copy-on-Write Memory</h2>
<p>The following example shows how Mach will Copy-on-Write pages of memory which are shared.</p>
<pre><code class="language-c">enum copy_on_write_constants {
    COPY_ON_WRITE = 0,
    PARENT_CHANGED = 1,
    CHILD_CHANGED = 2,
};

enum lock_constants {
    NO_ONE_WAIT = 0,
    PARENT_WAIT = 1,
    CHILD_WAIT = 2
};

char *lock_status[] = {
    &quot;NO_ONE_WAIT 0&quot;,
    &quot;PARENT_WAIT 1&quot;,
    &quot;CHILD_WAIT 2&quot;
};

char *cow_status[] = {
    &quot;COPY_ON_WRITE 0&quot; ,
    &quot;PARENT_CHANGED 1&quot;,
    &quot;CHILD_CHANGED 2&quot;
};

int vm_copy_on_write_example()
{
    union data_area {
        char                *indexed;
        vm_address_t        handle;
    } lock, mem;

    mach_port_t             self;
    char                    *error = NULL;
    kern_return_t           rv = KERN_SUCCESS;
    pid_t                   pid;
    const int               MAXDATA = 100;

    printf(&quot;\nSTART: vm_copy_on_write_example()\n&quot;);

    self = mach_task_self();

    rv = vm_allocate(self,
                     &amp;lock.handle,
                     sizeof(int),
                     TRUE);
    if (rv != KERN_SUCCESS) {
        error = &quot;Could not vm_allocate&quot;;
        goto vm_cow_error_return;
    }

    rv = vm_inherit(self,
                    lock.handle,
                    sizeof(int),
                    VM_INHERIT_SHARE);
    if (rv != KERN_SUCCESS) {
        error = &quot;Could not vm_inherit&quot;;
        goto vm_cow_error_return;
    }

    *lock.indexed = NO_ONE_WAIT;

    rv = vm_allocate(self,
                     &amp;mem.handle,
                     sizeof(int) * MAXDATA,
                     TRUE);
    if (rv != KERN_SUCCESS) {
        error = &quot;Could not vm_allocate&quot;;
        goto vm_cow_error_return;
    }

    mem.indexed[0] = COPY_ON_WRITE;
    printf(&quot;value of lock before fork: %s\n&quot;,
           lock_status[*lock.indexed]);
    pid = fork();

    if (pid) {
        printf(&quot;PARENT: copied memory = %s\n&quot;,
               cow_status[mem.indexed[0]]);
        printf(&quot;PARENT: changing to %s\n&quot;,
               cow_status[PARENT_CHANGED]);
        mem.indexed[0] = PARENT_CHANGED;
        printf(&quot;\n&quot;);
        printf(&quot;PARENT: lock = %s\n&quot;,
               lock_status[*lock.indexed]);
        printf(&quot;PARENT: changing lock to %s\n&quot;,
               lock_status[PARENT_WAIT]);
        printf(&quot;\n&quot;);
        *lock.indexed = PARENT_WAIT;

        while (*lock.indexed == PARENT_WAIT) {
            /* wait for child to change the value */
            ;
        }

        printf(&quot;PARENT: copied memory = %s\n&quot;,
               cow_status[mem.indexed[0]]);
        printf(&quot;PARENT: lock = %s\n&quot;,
               lock_status[*lock.indexed]);
        printf(&quot;PARENT: Finished.\n&quot;);
        *lock.indexed = PARENT_WAIT;
        exit(-1);
    }

    while (*lock.indexed != PARENT_WAIT) {
        /* wait for parent to change lock */
        ;
    }

    printf(&quot;CHILD: copied memory = %s\n&quot;,
           cow_status[mem.indexed[0]]);
    printf(&quot;CHILD: changing to %s\n&quot;,
           cow_status[CHILD_CHANGED]);
    mem.indexed[0] = CHILD_CHANGED;
    printf(&quot;\n&quot;);
    printf(&quot;CHILD: lock = %s\n&quot;,
           lock_status[*lock.indexed]);
    printf(&quot;CHILD: changing lock to %s\n&quot;,
           lock_status[CHILD_WAIT]);
    printf(&quot;\n&quot;);

    *lock.indexed = CHILD_WAIT;
    while (*lock.indexed == CHILD_WAIT) {
        /* wait for parent to change lock */
        ;
    }

    rv = vm_deallocate(mach_task_self(),
                       lock.handle,
                       sizeof(int));
    if (rv != KERN_SUCCESS) {
        error = &quot;vm_deallocate failed&quot;;
        goto vm_cow_error_return;
    }

    rv = vm_deallocate(mach_task_self(),
                       mem.handle,
                       sizeof(int) * MAXDATA);
    if (rv != KERN_SUCCESS) {
        error = &quot;vm_deallocate failed&quot;;
        goto vm_cow_error_return;
    }

    printf(&quot;CHILD: Finished.\n&quot;);
    printf(&quot;END: vm_copy_on_write_example()\n&quot;);

    return 0;

vm_cow_error_return:
    printf(&quot;%s: %s\n&quot;, error, mach_error_string(rv));
    return -1;
}
</code></pre>
<p>This program produces the following output:</p>
<pre><code>START: vm_copy_on_write_example()
value of lock before fork: NO_ONE_WAIT 0
PARENT: copied memory = COPY_ON_WRITE 0
PARENT: changing to PARENT_CHANGED 1

PARENT: lock = NO_ONE_WAIT 0
PARENT: changing lock to PARENT_WAIT 1

CHILD: copied memory = COPY_ON_WRITE 0
CHILD: changing to CHILD_CHANGED 2

CHILD: lock = PARENT_WAIT 1
CHILD: changing lock to CHILD_WAIT 2

PARENT: copied memory = PARENT_CHANGED 1
PARENT: lock = CHILD_WAIT 2
PARENT: Finished.
CHILD: Finished.
END: vm_copy_on_write_example()
</code></pre>
<h3 id="copy-on-write-discussion">Copy-on-Write Discussion</h3>
<p>As we can see the <code>vm_inherit()</code> routine will provide both the child and parent access to the same memory until it is modified.  After that, the child and parent have separate memory pages representing their own copy of the data values which can now be different.</p>
<p>This program uses a very primitive form of task coordination: busy while loops.  A realistic example would use the <code>pthread</code> library instead for signalling and coordination.</p>
<h2 id="further-steps">Further steps</h2>
<p>We now leave the Mach programming introduction.  There aren't really any big example programs that use Mach so it is hard to get an appreciation of how to program with it.  The main Mach program is the XNU kernel itself.  So our next steps on our learning journey is to understand how to debug and probe the XNU kernel.  From this we can get live experience with how Mach works.  We shall see how the system interacts with Mach and how security (Mandatory Access Control (MAC)) is woven into the system at this lowest level.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="../Hammer/" class="md-footer__link md-footer__link--prev" aria-label="Previous: The Hammer" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              The Hammer
            </div>
          </div>
        </a>
      
      
        
        <a href="../KernelDebugging/" class="md-footer__link md-footer__link--next" aria-label="Next: Kernel Debugging" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Kernel Debugging
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../assets/javascripts/workers/search.fcfe8b6d.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.b1047164.min.js"></script>
      
    
  </body>
</html>