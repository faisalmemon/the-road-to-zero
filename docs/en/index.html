<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="By Mr. Faisal Memon" />
  <title>The Road to Zero, First Edition</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    div.csl-bib-body { }
    div.csl-entry {
      clear: both;
    }
    .hanging div.csl-entry {
      margin-left:2em;
      text-indent:-2em;
    }
    div.csl-left-margin {
      min-width:2em;
      float:left;
    }
    div.csl-right-inline {
      margin-left:2em;
      padding-left:1em;
    }
    div.csl-indent {
      margin-left: 2em;
    }
  </style>
  <link rel="stylesheet" href="style/gitHubStyle.css" />
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  
</head>
<body>
<header id="title-block-header">
<h1 class="title">The Road to Zero, First Edition</h1>
<p class="author">By Mr. Faisal Memon</p>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#disclaimer">Disclaimer</a></li>
<li><a href="#preface">Preface</a></li>
<li><a href="#acknowledgements">Acknowledgements</a></li>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#zero-day">Zero Day</a>
<ul>
<li><a href="#what-is-a-zero-day">What is a Zero Day?</a></li>
<li><a href="#bug-bounty-programmes">Bug Bounty Programmes</a></li>
<li><a href="#market-dynamics">Market Dynamics</a></li>
<li><a href="#market-evolution">Market Evolution</a></li>
<li><a href="#monetary-rewards">Monetary Rewards</a></li>
<li><a href="#ethics">Ethics</a></li>
<li><a href="#arent-security-bugs-just-bugs">Aren’t security bugs just bugs?</a></li>
<li><a href="#burn-out">Burn Out</a>
<ul>
<li><a href="#looking-after-the-body">Looking after the body</a></li>
<li><a href="#optimizing-the-mind">Optimizing the mind</a></li>
<li><a href="#smoothing-the-ups-and-downs">Smoothing the ups and downs</a></li>
<li><a href="#using-version-control-to-contain-complexity">Using version control to contain complexity</a></li>
</ul></li>
<li><a href="#resources">Resources</a></li>
</ul></li>
<li><a href="#the-hammer">The Hammer</a>
<ul>
<li><a href="#getting-exploits">Getting Exploits</a></li>
<li><a href="#copyin_leak-exploit-45649"><code>copyin_leak</code> Exploit 45649</a></li>
<li><a href="#copyin_leak-write-up"><code>copyin_leak</code> write-up</a></li>
<li><a href="#the-road-ahead">The road ahead</a>
<ul>
<li><a href="#the-knowledge-we-require">The knowledge we require</a></li>
<li><a href="#engineering-sensibilities">Engineering sensibilities</a></li>
<li><a href="#the-learning-pathway">The learning pathway</a></li>
<li><a href="#deconstructing-our-world">Deconstructing our world</a></li>
<li><a href="#learning-from-exploits">Learning from Exploits</a></li>
<li><a href="#the-hacker-mindset">The hacker mindset</a></li>
<li><a href="#research-goals">Research goals</a></li>
</ul></li>
</ul></li>
<li><a href="#mach-programming">Mach Programming</a>
<ul>
<li><a href="#motivation">Motivation</a></li>
<li><a href="#mach-fundamental-abstractions">Mach Fundamental Abstractions</a></li>
<li><a href="#how-to-learn-mach-programming">How to learn Mach programming</a></li>
<li><a href="#memory-allocation">Memory Allocation</a>
<ul>
<li><a href="#memory-allocation-discussion">Memory Allocation discussion</a></li>
</ul></li>
<li><a href="#copy-on-write-memory">Copy-on-write Memory</a></li>
</ul></li>
<li><a href="#bibliography">Bibliography</a></li>
</ul>
</nav>
<h1 id="disclaimer">Disclaimer</h1>
<p>Copyright Faisal Memon 2021. All Rights Reserved.</p>
<p>This publication is provided “as is” without warranty of any kind, either express or implied, including, but not limited to, the implied warranties of merchantability, fitness for a particular purpose, or non-infringement.</p>
<p>This publication could include technical inaccuracies or typographical errors. Changes are periodically added to the information herein. These changes will be incorporated in new editions of the publication.</p>
<p>Apple makes no explicit or implied endorsement of this work. Materials in this book have been determined from public information sources and binaries, or materials provided by the Apple Software Development Kits.</p>
<p>Positions held by the author, as an employee or contractor, at past or future companies and institutions makes no explicit or implied endorsement of this work by those entities.</p>
<p>Every effort has been made to identify trademark terms in this text. If there is an error or omission, please contact the author. We have thus far recognized the following trademarks:</p>
<p>Darwin, NEXTSTEP, NeXT, UNIX, iOS, iPad, iPhone, macOS, tvOS, watchOS.</p>
<h1 id="preface">Preface</h1>
<p>This book has come about because having written a book on iOS Crash Dump Analysis, I found that most of my audience were security-focussed engineers.</p>
<p>I share the same passion. I have been studying various “Crack Me” challenges. I thought I was doing the correct preparation for vulnerability analysis.</p>
<p>When I looked at successful exploits, mostly on Google Project Zero <span class="citation" data-cites="gpz">(Google 2021)</span>, I found there was a technique gap. Not only do you need to apply standard techniques, you need to apply them on unfamiliar APIs, such as <code>IOSurface</code> and <code>XPC</code>. So I naturally looked at Crack Me challenges using those APIs. I wasn’t able to find any.</p>
<p>What I am attempting to do is to document my journey in acquiring the skills to find Zero Day Vulnerabilities on iOS in the form of a book. That is so that future engineers will have a book to take them along the same journey.</p>
<p>So the nature of this book is mostly a tutorial but with appropriate theory explanations or system knowledge explained along the way.</p>
<p>I take the view that when you are exploring new things, cost barriers are magnified because you are not sure at the time whether you will stick with it or enjoy it. Paying a lot of money for golf clubs is a straightforward choice if you’ve already fallen in love with the game. So I am going to work on the basis the reader has modest resources to hand (compared to the professionals in this area). I assume you have an iDevice, a Mac, an Xcode developer account, and maybe software, free or licensed at modest cost.</p>
<p>There is one last element I intend to add to the mix. The Hacker Mentality. This is the attitude of mind where an innocent piece of information can be viewed through a hacker’s lens. That offers the foothold for us to commence experimentation and discovery that then later will result in new vulnerabilities.</p>
<p>If I am successful, I hope this book will become the handbook of vulnerability craftsmanship in the same way that Code Complete <span class="citation" data-cites="codecomplete2">(McConnell 2004)</span> became the handbook of software craftsmanship.</p>
<p>One thing in particular that attracts me to iOS is that its one of the hardest platforms to circumvent. It may turn out I don’t reach the high bar needed to make progress on this platform. But if it was going to be easy, what would be the point in trying?</p>
<h1 id="acknowledgements">Acknowledgements</h1>
<p>I’d like to acknowledge the help and support of my colleagues for writing this book.</p>
<p>I am indebted to the support of my Chinese-language translator, TBC, for helping bring the Chinese edition of the book into fruition.</p>
<p>Putting together this work was only possible because it was built upon generously provided open source tools, in particular <code>pandoc</code> which made writing the text of the book a pleasure.</p>
<p>Lastly, I’d like to thank my supportive family whilst I was locked in my study, and largely absent. Thank you Junghyun, and Christopher.</p>
<h1 id="introduction">Introduction</h1>
<p>This is a book about Zero Day Vulnerabilities.</p>
<p>It is called “The Road to Zero” because it is primarily a tutorial guide to take you along the path needed to find your own vulnerabilities.</p>
<p>The focus of our book is iOS. In fact, when we talk about iOS we often mean the family of Operating Systems from Apple that are based around the same underpinnings. It would be more accurate to say this book focusses on Darwin, the common UNIX and NeXT technology stack from which macOS, iOS, tvOS, watchOS are derived.</p>
<p>Likewise when we refer to a device, we say iDevice because there are lots of different Apple produced products in different device classes, such as various models of iPhone, or iPad.</p>
<h1 id="zero-day">Zero Day</h1>
<h2 id="what-is-a-zero-day">What is a Zero Day?</h2>
<p>A Zero Day Vulnerability is a security vulnerability which is not yet known to the vendor responsible for the platform that has the vulnerability. Once notified, the “day” value increases each day regardless of the action the vendor does. So a 300-Day vulnerability is one that has been reported to the vendor 300 days ago. It might have been patched on day 30. It might have been patched on day 90. It might never be patched. Even if it has been patched, a vulnerability disclosed 300 days ago is still a 300-Day vulnerability.</p>
<p>As soon as a piece of software (it could also be firmware, a configuration file, resource file, etc.) is written the opportunity for a vulnerability arises. It could be that no one ever discovers the problem. Of the set of vulnerabilities that exist, some are found by humans (or their tools). At that point there is an asymmetry between those that know about the problem and those that do not know about the problem. Such knowledge can be valuable. That knowledge is sometimes traded, sold, or shared. Other times it is kept secret. It is only when the vendor is told about the vulnerability, that the bug is no longer a Zero Day Vulnerability. The date of disclosure then governs the “day” of the vulnerability.</p>
<h2 id="bug-bounty-programmes">Bug Bounty Programmes</h2>
<p>In order to encourage disclosure of vulnerabilities, vendors sometimes have a bug bounty program. They can reward researchers with money, or a promise to contribute to a charity, or with fame by acknowledging them as finding the vulnerability. Since researchers sometimes hoard vulnerabilities so that can do further research unlocked by them, platform owners have responded by giving vetted researchers enhanced access. In particular, Apple has introduced the Security Research Device programme.</p>
<h2 id="market-dynamics">Market Dynamics</h2>
<p>Sometimes multiple groups of engineers working separately find the same Zero Day. Sometimes a researcher suspects a bunch of related Zero Days, but only fully documents one. Likewise, sometimes the vendor only strictly fixes the vulnerability reported, and leaves adjacent issues as untreated. That in turn creates a dynamic in the market where recent bug fix releases are scanned for security fixes by researchers, so that adjacent issues can be explored.</p>
<p>As the stock of vulnerabilities has increased over time, organisations have sought to organize and catalog such findings. This gives insights on the kinds of things that can go wrong. Vendors will improve their game by adding mitigations, which in turn will be researched for weaknesses. So it is a cat-and-mouse game, getting ever more sophisticated.</p>
<p>If we consider “The Road to Zero” in dollar terms, where the dollar amount is the equipment cost, human time cost, etc. to achieve a 0-day, we can think of this book as a stepping stone. Firstly there is the cost to acquiring basic skills. Then there is the cost to acquiring similar skills but on iOS (Darwin) code bases. This book reduces that cost. Finally, there is the cost of finding original 0-days in iOS itself. We effectively make that final step cheaper because our skills have improved via the earlier steps.</p>
<h2 id="market-evolution">Market Evolution</h2>
<p>The market dynamics for iOS 0-day vulnerabilities has changed over time due to the changing nature of the Threat Model that Apple face, and the changing role iPhones and other devices have in our lives. Originally the iPhone had no third party apps. There were two main threats the system had to model. First were the Jailbreak community who wanted to customise the iPhone experience and add their own apps. Second were those that wanted to Carrier-unlock their phone. The phone price would typically be subsidized by the telecommunications operator via a subscription to their network over a period of time before you were allowed to buy a subscription to another operator. With such a threat model, a simple layer of defense was needed. Apple introduced the iPhone App Store, together with sandboxed apps, requiring code-signing for installation for all third party apps. In those days, a vulnerability alone was enough to defeat the security of the phone. So finding and exploiting a 0-day was “most of the game.”</p>
<p>Over the ensuing years, Apple would increase the depth of their defenses with new security measures, but bug hunters could keep up. However, the nature of the market changed. As there became more apps, and everyday work flows became connected to, and supported by, mobile phone apps, the value of the information in your phone drew the interest of government entities, criminals, and law-enforcement, as well as “friends” and family. Now the threat model is diverse and profound. The phone must resist attack when in physical possession of an attacker (such as a phone stolen after a crime). It must resist attack wirelessly when in a hostile network environment, such as an international conference hosting a politicaly sensitive agenda, or an innocent trip to a coffee shop. It must resist attack from a curious partner, grandparent or child.</p>
<p>Since iDevices now have many layers of security, it is not one 0-day alone that unlock deeper access to the system. There are chains of vulnerabilities that need to be exploited to fully attack the system. Each subsystem has become a complex entity. So the market is now one of specialization. One person might be expert in WebKit vulnerabilities. One person might be expert in PDF file format weaknesses. One person might now how to construct “gadgets” to achieve a desired control flow path. There are companies that buy up individual vulnerabilities and assemble them. They might leverage toolkits from others for post-exploitation, etc.</p>
<p>No one person is an industry. We are small players in a complex dynamic market. So it is important to understand what our goals are, what skills we have or desire, and how we see ourselves in this bigger picture.</p>
<h2 id="monetary-rewards">Monetary Rewards</h2>
<p>As the skill requirements have increased, together with increased specialization, the monetary cost of “doing business” has increased. This places security researchers in a novel “taxation” dynamic <span class="citation" data-cites="offensiveworklovehate">(Dullien 2021)</span>. Apple will improve their security. Offensive security companies will need more money to crack into the iDevices as their exploit chains will become longer and more esoteric. They will need to buy in exploits, research material, and hire from a small pool of talent to do the equivalent in-house. Such companies will demand higher fees for their tools, and their solutions will have shorter lifetimes. Law enforcement, military and government entities will need to pay more for such tools. The pressure release value is at the political level. Either politicians agree to allowing strong protections in consumer devices, iPhone chiefly among them. This means taxation on the population (or a re-allocation of funds) to pay the offensive companies more money, and more often, for valuable access to mobile phone information. Or on the other hand, politicians can espouse back-doors into consumer devices. This lowers the “taxation” but increases malicious activity from adversaries.</p>
<p>This explains our current surreal state of affairs. A vulnerabilty can be worth millions, because it is a tax on millions on users that require confidentiality, security and privacy.</p>
<h2 id="ethics">Ethics</h2>
<p>There are a lot of ethical consideration surrounding Zero Day Vulnerabilities (hereafter we shall say 0-day). The consensus is that you should not openly discuss or explain vulnerabilities until the bug is 90 days since disclosure (i.e. a 90-day). So we don’t place 0-days in this text. But we create software modules of our own, reachable from a non-compromised device. These modules emulate closely the properties of an exposed subsystem so we can discuss, explore and compromise “our own code.” We also discuss past vulnerabilities that have been patched by Apple.</p>
<p>Will this book lead to a proliferation of 0-days? My opinion is that the malicious actors already have the tools and knowledge they need. It is the wider engineering community that need to up-skill in this area. Most of these people will not be malicious. They will enhance and improve the security of systems.</p>
<p>In truth, we often tell ourselves stories that make us comfortable with what we are doing, particularly if our pay-cheque aligns with that. The best of intentions can result in adverse outcomes, as well as the converse. For example, a researcher working on their PhD might see a bug class, but just have time to explore one fully, writing up a Proof of Concept (POC), which is duly responsibly disclosed, and patched, before being published as a finding by the researcher. Another engineer might read the write-up, look at the binary diff related to the fix, notice associated vulnerabilities, and produce a variant POC and sell that to a market place for significant money. At that point, the vulnerability could be combined with others and militarized. The question is then who made that weapon, and would it have come to existence anyway? Such a weapon could be used to save lives, lose lives, start conflict or avoid conflict depending on the circumstances politically.</p>
<h2 id="arent-security-bugs-just-bugs">Aren’t security bugs just bugs?</h2>
<p>To take the opposite tack, we can ask ourselves, “Aren’t security bugs just bugs?” In other words, why dwell on 0-days as something special. They are just bugs that can turn out to affect users when exploitable. But lots of things can affect users.</p>
<p>To move forwards with the debate we need to be honest with ourselves. We need to understand our own perspective and agenda. If your goal is to learn how to find and discover 0-days, the process of discovery itself is the joy we seek. If that bug gets an associated vulnerability number, known as a CVE number, then it is a recognition of achievement, much the same as any other professional recognition.</p>
<p>We do have to acknowledge the larger context. Platform owners know that in a large system, there will be bugs, and a subset of those will affect security. The vendor will know that part of their responsibility is patching the bugs when they have been reported. Their wider responsibility is to have processes that avoid the same issue appearing in the future, and avoid the same bug classes appearing. They may change their audit procedure, hire staff to search for bugs, provide training on secure programming practices, perform threat modelling sessions, etc. One fruitful area is applying mitigation layers. The platform may have checks against stack overflows, or malicious changes to control flow integrity, etc. These will be discussed later. In practice, these are powerful weapons.</p>
<p>The ultimate perspective is that of an end-user. Users want to go about their business with the minimal amount of cost, and inconvenience, whilst having a rich and enjoyable user experience. A secure system which is so cumbersome that there are few users does little to help society.</p>
<p>Users need psychological safety, and trust in their systems. A small drop of poison in a large reservoir wouldn’t kill a person, but who would drink water from that reservoir? Security delivers safety and trust.</p>
<p>So security bugs are important, but not special. They are important because over time platform vendors will develop mitigation layers to sweep away the exploitability of 0-days. And the platform vendors that do this in a way that minimises the cost and inconvenience to users will win over the greater number of users. This means that end users will live in a digital world that provides security and trust. And trust is essential to our modern day living.</p>
<p>When we use public transit systems, we trust the safety of the transport system. When we stop by a coffee shop and order a drink, we assume the water in the drink is safe. Wealth is created by a division of labor with individuals doing specialist roles. Such a society can only function when those services are trustworthy. Computing services, such as mobile phone systems and apps are a key service that technologists contribute to the wider society.</p>
<p>Going back to the example of public transit. When sitting on a train, we can often see a couple of people drinking coffee. But we can see plausibly a majority looking at their mobile phone screens. We need the train to be safe, the coffee to be safe, and the mobile computing experience to be safe!</p>
<h2 id="burn-out">Burn Out</h2>
<p>We haven’t even started yet, and so why are we bringing up the topic of burn out?</p>
<p>When you start training your mind to think like a machine thinks, or start working through the details of a subsystem in great deal, it can be both engaging and exhausting. After a period of youthful exuberance can be a down hill descent of despair when you can nearly solve something, but cannot quite get it done.</p>
<p>As ever, there is a way to hack around such problems!</p>
<h3 id="looking-after-the-body">Looking after the body</h3>
<p>First, the boring stuff. Solid, regular and good-quality sleep. Three good meals a day. 30 minutes exercise a day - a good walk for example. These are the basics for maintaining your health. At least for now, humans are not machines, and humans need this basic level of care.</p>
<h3 id="optimizing-the-mind">Optimizing the mind</h3>
<p>Second, the mind hack. That first hour of the day, maybe the first half hour is the golden time. Save the heaviest and most difficult mental task to only that dream slot. Leave the manual, boring and tedious investigation work to the end of your work day. Everything else sits in-between those two things.</p>
<h3 id="smoothing-the-ups-and-downs">Smoothing the ups and downs</h3>
<p>Third, the multi-tasking hack. If security research is the only thing you are doing, then yes you have focus but you are going to have ups and downs. The way around that is to have two activities that vary in importance over a period of months but are a constant presence. One good parallel activity is software engineering. You could be writing a security tool, for example, or something unrelated. Software engineering is in some ways the opposite of vulnerability research. It is building abstractions, adding layers, and working in a problem domain instead of the machine domain. It feels very constructive and creative. Sometimes you make great progress on your software, and other times you make progress on your vulnerability research. Since time away from one task does not stop your mind from advancing it in your mind in the background, the net effect is that when you’re done with vulnerability research, the software engineering seems to go great due to pent up ideas you’ve been working on in the background. The converse applies also, so that after a period of development on your software project, new ideas appear to help advance your security research.</p>
<h3 id="using-version-control-to-contain-complexity">Using version control to contain complexity</h3>
<p>The fourth hack is facilitated by the git version control system. Everything you do must be recorded and tracked with git (or another version control system). Because with git, you can make small incremental improvements (git commits), and then build on those. This provides head space you need to achieve complex things. You just keep incrementally developing your ideas, code, and experiments. Do not try and keep complexity in your mind for a long period. Just keep dumping them into text files, code, etc., into a git repository. Then at the end of each day, you will feel that you made progress, even if there is no big result. That will save your sanity.</p>
<h2 id="resources">Resources</h2>
<p>To complement the book, there is a website of resources which is intended to be used alongside the printed material so example projects can be setup and run by yourself and experimented with. All references in this book are collected into the Bibliography Chapter at the end of the book. There you will find URLs to resources, for example.</p>
<p>The GitHub website supporting the book is at <span class="citation" data-cites="trtzgithub">(Memon 2021)</span></p>
<h1 id="the-hammer">The Hammer</h1>
<p>When studying past exploits it can feel like your brain has been hit by a hammer. It is because most exploit discussions work on the basis that you have had an apprenticeship on all the underlying techniques, and that only that final layer needs explanation.</p>
<p>This approach is understandable from the writer’s perspective. If you are a researcher you will naturally seek out underlying technologies, documentation and reading materials as part of your research journey. The writer’s audience will be such researchers. So the writer will not dwell on the supporting techniques and technologies.</p>
<p>Since iOS and macOS use many niche technologies, or use standard techniques with some Apple ecosystem unique twists, it is not so easy to do your background reading.</p>
<p>In this chapter we shall look at an exploit write-up. Our purpose is not to understand the exploit as such, but to survey the techniques and technologies at play. It will provide us the motivation to explore such items in subsequent chapters knowing that this knowledge will then help us circle back and understand the originally presented exploit.</p>
<h2 id="getting-exploits">Getting Exploits</h2>
<p>Exploits can be downloaded from the Exploit Database <span class="citation" data-cites="exploitdb">(Security 2021)</span>. This is a valuable resource and one we shall often refer to. The exploit database has a search tool, <code>searchsploit</code>. If we install <code>searchsploit</code> from <span class="citation" data-cites="exploitdb">(Security 2021)</span> and configure our <code>~/.searchsploit_rc</code> file then we can easily look up exploits.</p>
<p>This is a search for items matching <code>ios</code> and <code>dos</code>:</p>
<pre><code>searchsploit ios dos | less
------------------------------- ---------------------------------
 Exploit Title                 |  Path
------------------------------- ---------------------------------
Apple iOS - Kernel Stack Memor | ios/dos/45649.txt
Apple iOS 1.1.2 - Remote Denia | hardware/dos/4978.html
Apple iOS 1.1.4/2.0 / iPod 1.1 | hardware/dos/32341.html
Apple iOS 11.2.5 / watchOS 4.2 | multiple/dos/44215.m
Apple iOS 4.0.3 - DPAP Server  | ios/dos/5151.pl
Apple iOS 5.1.1 Safari Browser | ios/dos/18931.rb
Apple iOS &lt; 10.3.2 - Notificat | ios/dos/42014.txt
Apple iOS Kernel - Use-After-F | ios/dos/45652.c
Apple iOS Mobile Safari - Memo | ios/dos/31057.html
Apple iOS Safari - &#39;decodeURI&#39; | hardware/dos/15794.php
Apple iOS Safari - &#39;decodeURIC | hardware/dos/15796.php
Apple iOS Safari - &#39;JS .&#39; Remo | hardware/dos/15805.php
Apple iOS Safari - Bad &#39;VML&#39; R | ios/dos/11890.txt
Apple iOS Safari - body alink  | hardware/dos/15792.php
Apple iOS Safari - Remote Deni | ios/dos/11891.txt
Apple iOS/macOS - Kernel Memor | multiple/dos/45651.c
Apple iOS/macOS - Sandbox Esca | multiple/dos/45648.txt
Apple iOS/macOS - Sandbox Esca | multiple/dos/45650.txt
Apple Mac OSX - IOSCSIPeripher | osx/dos/39376.c</code></pre>
<p>Exploits can be searched for, downloaded, and then explored. Each exploit has a number associated with it, known as the <code>EDB-ID</code>.</p>
<h2 id="copyin_leak-exploit-45649"><code>copyin_leak</code> Exploit 45649</h2>
<p>This program allows a user program to get the kernel to expose memory values it should not be able to see. In that sense it is an information disclosure “leak.” The kernel routine used to do this is <code>copyin</code> hence it has been called a <code>copyin_leak</code>.</p>
<p>The following command places a local copy of the exploit write-up in our local directory, known as the mirror <code>(-m)</code> command.</p>
<pre><code># searchsploit -m 45649
  Exploit: Apple iOS - Kernel Stack Memory Disclosure due to
 Failure to Check copyin Return Value
      URL: https://www.exploit-db.com/exploits/45649
     Path:
 /Users/faisalm/dev/exploitdb/exploits/ios/dos/45649.txt
File Type: ASCII text, with CRLF line terminators

Copied to: /Users/faisalm/dev/scratch/45649.txt</code></pre>
<p>From looking at the text file, we find we can download the actual Proof of Concept (POC) from a Git Hub web address. This provides us an app to run on simulator or on an iDevice.</p>
<p>This POC has been tested on</p>
<pre><code>iPod touch (7th generation)
iOS 13.5 (17F75)</code></pre>
<p>and</p>
<pre><code>iPod touch (7th generation) simulator
iOS 14.4 (18D46)</code></pre>
<h2 id="copyin_leak-write-up"><code>copyin_leak</code> write-up</h2>
<p>Here is the verbatim text for the write-up of this leak. The purpose for including it is to show the “level” at which exploit research is aimed at. The main aim of this book is to bring ourselves up to the same level so we can appreciate this piece of research, and then move forwards onto exploring and finding our own vulnerabilities.</p>
<blockquote>
<p>Here’s a code snippet from sleh.c with the second level exception handler for undefined instruction exceptions:</p>
</blockquote>
<pre><code> static void
 handle_uncategorized(arm_saved_state_t *state, boolean_t
 instrLen2)
 {
   exception_type_t       exception = EXC_BAD_INSTRUCTION;
   mach_exception_data_type_t   codes[2] = {EXC_ARM_UNDEFINED};
   mach_msg_type_number_t     numcodes = 2;
   uint32_t          instr;   &lt;------ (a)

   if (instrLen2) {
     uint16_t  instr16;
     COPYIN(get_saved_state_pc(state), (char *)&amp;instr16,
 sizeof(instr16));

     instr = instr16;
   } else {
     COPYIN(get_saved_state_pc(state), (char *)&amp;instr,
 sizeof(instr));  &lt;------- (b)
   }

 ....

  else {
   codes[1] = instr;   &lt;------ (c)
  }
 }

 exception_triage(exception, codes, numcodes);  &lt;-------- (d)</code></pre>
<blockquote>
<p>At (a) the uint32_t instr is declared uninitialized on the stack. At (b) the code tries to copyin the bytes of the exception-causing instruction from userspace note that the COPYIN macro doesn’t itself check the return value of copyin, it just calls it. At (c) instr is assigned to codes[1], which at (d) is passed to exception_triage.</p>
</blockquote>
<blockquote>
<p>that codes array will eventually end up being sent in an exception mach message.</p>
</blockquote>
<blockquote>
<p>The bug is that we can force copyin to fail by unmapping the page containing the undefined instruction while it’s being handled. (I tried to do this with XO memory but the kernel seems to be able to copyin that just fine.)</p>
</blockquote>
<blockquote>
<p>This PoC has an undefined instruction (0xdeadbeef) on its own page and spins up a thread to keep switching the protection of that page between VM_PROT_NONE and VM_PROT_READ|VM_PROT_EXECUTE.</p>
</blockquote>
<blockquote>
<p>We then keep spinning up threads which try to execute that undefined instruction.</p>
</blockquote>
<blockquote>
<p>If the race windows align the thread executes the undefined instruction but when the sleh code tries to copyin the page is unmapped, the copying fails and the exception message we get has stale stack memory.</p>
</blockquote>
<blockquote>
<p>This PoC just demonstrates that you do get values which aren’t 0xdeadbeef in there for the EXC_ARM_UNDEFINED type. You’d have to do a bit more fiddling to work out how to get something specific there.</p>
</blockquote>
<blockquote>
<p>Note that there are lots of other unchecked COPYIN’s in sleh.c (eg when userspace tries to access a system register not allowed for EL0) and these seem to have the same issue.</p>
</blockquote>
<blockquote>
<p>tested on iPod Touch 6g running 11.3.1, but looking at the kernelcache it seems to still be there in iOS 12.</p>
</blockquote>
<blockquote>
<p>Proof of Concept: https://github.com/offensive-security/exploitdb-bin-sploits/raw/m aster/bin-sploits/45649.zip</p>
</blockquote>
<p>That’s the end of the write-up. It covers a lot of ground. In terms of technologies and techniques we have in the solution:</p>
<ul>
<li>Mach
<ul>
<li>Mach Messages</li>
<li>Mach Exceptions</li>
</ul></li>
<li>OS
<ul>
<li>userspace and kernelspace</li>
<li>copyin</li>
<li>virtual memory</li>
<li>exception handling</li>
<li>Open Source XNU kernel</li>
</ul></li>
<li>Programming
<ul>
<li>C and Assembly languages</li>
<li>threads</li>
<li>stacks</li>
<li>race conditions and brute forcing</li>
<li>error handling or its absence</li>
</ul></li>
</ul>
<p>Now we just need to make sense of it all.</p>
<h2 id="the-road-ahead">The road ahead</h2>
<p>Having learnt where we can find Exploits, looking at our first exploit, and then seeing what technologies it relies upon, we can now chart out the road ahead.</p>
<h3 id="the-knowledge-we-require">The knowledge we require</h3>
<p>No one book can cover all the required topics in depth. But with the appropriate hacker mindset, a small subset of a large number of technologies can be learnt within the confines of one book.</p>
<p>After practice, a hacker mentality can zoom our attention to the most “interesting” aspects of a given technology. We should aim to have a T-shaped skill profile; shallow knowledge in many areas, but in-depth for certain pieces of those technologies. This is in contrast to a standard engineering T-shaped knowledge base where the in-depth knowledge is confined to one or two technologies.</p>
<h3 id="engineering-sensibilities">Engineering sensibilities</h3>
<p>If we are a professional software engineer, and look at Proof of Concept exploits the code structure and organisation often chafes at our engineering sensibilities. Compiler warning are ignored, variable names are terse or badly named. Functions are badly formed, with strange names, and dispersed business logic. Hardcoded values are rampant.</p>
<p>But the programs do “clever” things and use techniques often advanced programmers are unaware of. This is really a reflection of the patchwork of in-depth skills a hacker will acquire. Brilliance in some aspects, and beginner in others. Of course, hackers can also be skilled software engineers, system administrators, or have another profession. Such skills can be complementary but are not foundational. Hacker skills are not built on top of a layer of great system administration skills, nor software engineering skills.</p>
<h3 id="the-learning-pathway">The learning pathway</h3>
<p>There is a meta skill that underpins security research. That is, reading.</p>
<p>We have a goal to reach but don’t know half of the technologies needed. So we just do an internet search, pull down freely available learning material, and then skim through the contents.</p>
<p>The canonical texts are usually the best. In the first iteration it is usually a matter of downloading a manual of hundreds of pages. Then pressing Page-Down repeatedly and skimming through. Maybe 10 seconds per page. We are building up a mental model from the lowest level detail in a particular topic. At that point we have awareness of what we don’t know but enough knowledge to know a good search query to get into such a topic in more depth.</p>
<h3 id="deconstructing-our-world">Deconstructing our world</h3>
<p>Looking at canonical materials (that is, the text that most fully describes the content with a minimal amount of simplification) allows hackers to see systems as they really are, rather than an abstraction of what they are.</p>
<p>Software engineering is really the construction of layers of abstraction to get to a point of understanding of the task most naturally in the problem space we are working with. Researchers need to think about computers in the way they actually work, with all the abstractions stripped bare.</p>
<p>For example, when programmers see a virtual function in C++, they know that they need to look at what class is being messaged to understand what function the method will invoke. When hackers see a virtual function, they see that there must be a Virtual Function Table where the control flow is switched to the function that is desired. If the strategy in the mind of the researcher is to re-direct program control, then inspecting the code for virtual functions can be a goal.</p>
<p>Furthermore, reading a C++ manual which tells about how late binding works (as explained above with Virtual Function tables) allows those with a hacker mentality to make a mental note of the implied trust relationship in that code at such points. The Virtual Function Table if subverted will change the operation of the program.</p>
<h3 id="learning-from-exploits">Learning from Exploits</h3>
<p>Looking at existing exploits teaches what are the kinds of things about technologies we have that need to be learnt. That is so we don’t waste effort on non-critical knowledge. Granted all knowledge is valuable, but time is always going to be finite. So a trade-off is needed between learning knowledge in case it might be useful versus learning only what is needed for the job in hand.</p>
<h3 id="the-hacker-mindset">The hacker mindset</h3>
<p>Our path in learning and discovery is aided by a hacker mindset. This is closely connected to human psychology. What do humans do, and what opportunities are indirectly afforded through such human nature? There are formal ways of thinking to encourage a hacker mindset. We shall explore this in later chapters.</p>
<h3 id="research-goals">Research goals</h3>
<p>Looking at security exploits, we can ask what was the researcher aiming for which resulted in the fruits of the researcher. Research is not effective unless there is a strategic path that is being pursued. We shall explore this aspect of security research and show how this can amplify our efforts.</p>
<h1 id="mach-programming">Mach Programming</h1>
<h2 id="motivation">Motivation</h2>
<p>The reason why we want to do Mach programming is because it is an interface available from user mode (otherwise known as userland) that can reach the internals of kernel mode through the System Call Interface (syscall interface). The operating system, marketed as iOS or macOS, etc., is the really the Darwin operating system. Darwin is a UNIX operating system. It offers two personalities to the programmer; its UNIX personality and its Mach personality. The kernel of Darwin is XNU, and XNU natively speaks Mach because Mach Inter-Process Communication is central to the way in which it internally operates.</p>
<p>It is straightforward to learn the UNIX syscall interface, because it follows the same paradigm as Linux. There are therefore many books and example programs written against the UNIX syscall interface. The details will vary but the approach is the same.</p>
<p>The Mach programming interface is somewhat esoteric. Apple seem to like to pretend that it does not exist. Even experienced iOS programmers will know little to nothing about it. However, time and again, this interface will be used to build exploits, so it is something we shall learn.</p>
<p>The original idea with Mach was to extend UNIX with new capabilities to tackle the emergence of multiprocessor systems and distributed computing more naturally. The solution was to add a new set of messaging primitives. <span class="citation" data-cites="machsyscalls">(Walmer and Thompson 1988)</span></p>
<p>When correctly coded, Mach based solutions can be elegant. When incorrectly coded, Mach based code offers an expansive attack surface. We shall study different techniques that abuse the Mach messaging system, such as Type Confusion. Furthermore, Mach based attacks can be Data oriented attacks, which side-step the traditional mitigations in the Operating System (such as stack overflow protection and control flow integrity).</p>
<h2 id="mach-fundamental-abstractions">Mach Fundamental Abstractions</h2>
<p>Mach <span class="citation" data-cites="machconcepts">(NeXT Software 1995)</span> is built upon the following abstractions:</p>
<table>
<thead>
<tr class="header">
<th>Entry</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>task</code></td>
<td>An execution environment.</td>
</tr>
<tr class="even">
<td><code>thread</code></td>
<td>The basic unit of execution.</td>
</tr>
<tr class="odd">
<td><code>port</code></td>
<td>A communication channel.</td>
</tr>
<tr class="even">
<td><code>message</code></td>
<td>A typed collection of data used for communication between threads</td>
</tr>
</tbody>
</table>
<p>In the original formulation, tasks could be on the same machine, on different processors in the machine, or on different machines. Such tasks become active entities when they host one or more threads. And threads can communicate with each other using well-defined interfaces that are invariant to whether the recipient is on the same machine or on a different machine.</p>
<p>In reality, due to the inescapable nature of distributed communication, latency and reliability cannot be ignored. Therefore, the uniform communication abstraction never works out satisfactorily in real systems. However, within a CPU with threads from the same task, or tasks in a parent-child relationship, the inherently well design message passing abstraction comes into its own. This is where the XNU kernel does its work.</p>
<h2 id="how-to-learn-mach-programming">How to learn Mach programming</h2>
<p>Mach is not so easy to learn. There are few modern programs on GitHub to look at. One way into the topic is to study the NEXTSTEP documentation, <span class="citation" data-cites="machconcepts">(NeXT Software 1995)</span>. Despite its age, it is a well structured explanation of the concepts. Another source of documentation are the header files on macOS.</p>
<p>We can find the header file directory with:</p>
<pre><code># find /Applications/Xcode.app -type d -iname mach
/Applications/Xcode.app/Contents/Developer/Platforms/AppleTVOS.pl
atform/Developer/SDKs/AppleTVOS.sdk/usr/include/mach
/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.pla
tform/Developer/SDKs/iPhoneOS.sdk/usr/include/mach
.
.
.</code></pre>
<p>Rather than duplicate or replace the NEXTSTEP documentation, we assume the reader will read that documentation, but for the practical work elements, refer to this book. This book then acts as a modernization of the original materials. As mentioned in the Introduction, this book is largely a tutorial guide to get us along the path to being able to find 0-day vulnerabilities.</p>
<h2 id="memory-allocation">Memory Allocation</h2>
<p>Here we follow along the <span class="citation" data-cites="machconcepts">(NeXT Software 1995)</span> documentation but with modernized code examples. These are available at <span class="citation" data-cites="trtzgithub">(Memon 2021)</span> in the subdirectory <code>source/mach-vm-alloc</code></p>
<p>Here is code that demonstrates how to allocate memory with Mach, how to duplicate memory, and then how to free memory.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> vm_example<span class="op">()</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">union</span> data_area <span class="op">{</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span>                <span class="op">*</span>indexed<span class="op">;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>        vm_address_t        handle<span class="op">;</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> data1<span class="op">,</span> data2<span class="op">;</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    vm_size_t               i<span class="op">;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    vm_size_t               min<span class="op">;</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    mach_msg_type_number_t  data_cnt<span class="op">;</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    mach_port_t             self<span class="op">;</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span>                    <span class="op">*</span>error <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    kern_return_t           rv <span class="op">=</span> KERN_SUCCESS<span class="op">;</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">START: vm_example()</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    self <span class="op">=</span> mach_task_self<span class="op">();</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;mach_task_self is 0x%x</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> self<span class="op">);</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>    rv <span class="op">=</span> vm_allocate<span class="op">(</span>self<span class="op">,</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>                     <span class="op">&amp;</span>data1<span class="op">.</span>handle<span class="op">,</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>                     vm_page_size<span class="op">,</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>                     TRUE<span class="op">);</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>rv <span class="op">!=</span> KERN_SUCCESS<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>        error <span class="op">=</span> <span class="st">&quot;Could not vm_allocate&quot;</span><span class="op">;</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">goto</span> vm_example_error_return<span class="op">;</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="op">(</span>i <span class="op">&lt;</span> vm_page_size<span class="op">);</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>        data1<span class="op">.</span>indexed<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;Filled space allocated with some data.</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;Doing vm_read....</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>    rv <span class="op">=</span> vm_read<span class="op">(</span>self<span class="op">,</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>                 data1<span class="op">.</span>handle<span class="op">,</span></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>                 vm_page_size<span class="op">,</span></span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>                 <span class="op">&amp;</span>data2<span class="op">.</span>handle<span class="op">,</span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>                 <span class="op">&amp;</span>data_cnt<span class="op">);</span></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span><span class="op">(</span>rv <span class="op">!=</span> KERN_SUCCESS<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>        error <span class="op">=</span> <span class="st">&quot;Could not vm_read&quot;</span><span class="op">;</span></span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">goto</span> vm_example_error_return<span class="op">;</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;Successful vm_read.</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>vm_page_size <span class="op">!=</span> data_cnt<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>        error <span class="op">=</span> <span class="st">&quot;vmread: Number of bytes read not equal to number</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a> available and requested<span class="op">.</span><span class="st">&quot;;</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">goto</span> vm_example_logic_error_return<span class="op">;</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>    min <span class="op">=</span> <span class="op">(</span>vm_page_size <span class="op">&lt;</span> data_cnt<span class="op">)</span> <span class="op">?</span> vm_page_size <span class="op">:</span> data_cnt<span class="op">;</span></span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="op">(</span>i <span class="op">&lt;</span> min<span class="op">);</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>data1<span class="op">.</span>indexed<span class="op">[</span>i<span class="op">]</span> <span class="op">!=</span> data2<span class="op">.</span>indexed<span class="op">[</span>i<span class="op">])</span> <span class="op">{</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>            error <span class="op">=</span> <span class="st">&quot;Data not read correctly&quot;</span><span class="op">;</span></span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">goto</span> vm_example_logic_error_return<span class="op">;</span></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;Checked data successfully.</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>    rv <span class="op">=</span> vm_deallocate<span class="op">(</span>self<span class="op">,</span></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>                       data1<span class="op">.</span>handle<span class="op">,</span></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>                       vm_page_size<span class="op">);</span></span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>rv <span class="op">!=</span> KERN_SUCCESS<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>        error <span class="op">=</span> <span class="st">&quot;Could not vm_deallocate&quot;</span><span class="op">;</span></span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">goto</span> vm_example_error_return<span class="op">;</span></span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>    rv <span class="op">=</span> vm_deallocate<span class="op">(</span>self<span class="op">,</span></span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>                       data2<span class="op">.</span>handle<span class="op">,</span></span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>                       data_cnt<span class="op">);</span></span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>rv <span class="op">!=</span> KERN_SUCCESS<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>        error <span class="op">=</span> <span class="st">&quot;Could not vm_deallocate&quot;</span><span class="op">;</span></span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">goto</span> vm_example_error_return<span class="op">;</span></span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;END: vm_example()</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>vm_example_error_return<span class="op">:</span></span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;%s: %s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> error<span class="op">,</span> mach_error_string<span class="op">(</span>rv<span class="op">));</span></span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a>vm_example_logic_error_return<span class="op">:</span></span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> error<span class="op">);</span></span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="memory-allocation-discussion">Memory Allocation discussion</h3>
<p>In our code example, there are two stylistic points to note:</p>
<ol type="1">
<li><p>We use a union to clearly characterise that Mach calls accept a handle, which is a <code>vm_address_t</code> but is clearly also just a raw pointer, <code>char *</code>, so we create a union comprising these two types depending on whether we are issuing Mach calls or doing normal C-based pointer arithmetic. The union avoids us having to use type casts.</p></li>
<li><p>We use a <code>goto</code> idiom to handle errors. All our <code>goto</code> statements go forwards (so don’t generate loops in our code) and just handle the error cases. This makes such exception handling clean without too much code repetition. That is useful because nearly all our function calls can return an error to be checked.</p></li>
</ol>
<p>In our code we make the following observations:</p>
<ol type="1">
<li><p>We need to have the port of the task before any of the system calls can be made because any message port the system returns is namespaced to port of the task it relates to. <code>mach_task_self()</code> provides us this. It is not actually a function call, it is a #define which provides us our thread-specific task value. The value is typically a small integer.</p></li>
<li><p><code>vm_allocate()</code> allocates memory. It is logical to ask for a page sized amount of memory because this is the unit of memory upon which virtual protection and management is done. This will be 16 KiB.</p></li>
<li><p><code>vm_read()</code> actually also allocates memory as <code>vm_allocate()</code> does. The function names do not have a nomenclature that tells us this, so it is worthwhile checking the function meaning each time until we are familiar with them.</p></li>
<li><p><code>vm_deallocate()</code> deallocates our memory; we did a <code>vm_allocate()</code> and a <code>vm_read()</code> allocation so there are two pages of memory to free up.</p></li>
<li><p>It is a good practice to check return values against <code>!= KERN_SUCCESS</code> and let <code>mach_error_string</code> handle the different possible error return values, since there are many error values possible.</p></li>
</ol>
<p>This <code>vm_example()</code> code merely needs to be hooked into our App code when it launches, in the <code>main()</code> function to operate. It does feel heavyweight for what it does.</p>
<h2 id="copy-on-write-memory">Copy-on-write Memory</h2>
<p>The following example shows how Mach will Copy-on-Write pages of memory which are shared.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> copy_on_write_constants <span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    COPY_ON_WRITE <span class="op">=</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    PARENT_CHANGED <span class="op">=</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    CHILD_CHANGED <span class="op">=</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> lock_constants <span class="op">{</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    NO_ONE_WAIT <span class="op">=</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    PARENT_WAIT <span class="op">=</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    CHILD_WAIT <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> <span class="op">*</span>lock_status<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;NO_ONE_WAIT 0&quot;</span><span class="op">,</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;PARENT_WAIT 1&quot;</span><span class="op">,</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;CHILD_WAIT 2&quot;</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> <span class="op">*</span>cow_status<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;COPY_ON_WRITE 0&quot;</span> <span class="op">,</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;PARENT_CHANGED 1&quot;</span><span class="op">,</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;CHILD_CHANGED 2&quot;</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> vm_copy_on_write_example<span class="op">()</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">union</span> data_area <span class="op">{</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>        <span class="dt">char</span>                <span class="op">*</span>indexed<span class="op">;</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>        vm_address_t        handle<span class="op">;</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> lock<span class="op">,</span> mem<span class="op">;</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>    mach_port_t             self<span class="op">;</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span>                    <span class="op">*</span>error <span class="op">=</span> NULL<span class="op">;</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>    kern_return_t           rv <span class="op">=</span> KERN_SUCCESS<span class="op">;</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    pid_t                   pid<span class="op">;</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    <span class="dt">const</span> <span class="dt">int</span>               MAXDATA <span class="op">=</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">START: vm_copy_on_write_example()</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    self <span class="op">=</span> mach_task_self<span class="op">();</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>    rv <span class="op">=</span> vm_allocate<span class="op">(</span>self<span class="op">,</span> <span class="op">&amp;</span>lock<span class="op">.</span>handle<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">int</span><span class="op">),</span> TRUE<span class="op">);</span></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>rv <span class="op">!=</span> KERN_SUCCESS<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>        error <span class="op">=</span> <span class="st">&quot;Could not vm_allocate&quot;</span><span class="op">;</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">goto</span> vm_cow_error_return<span class="op">;</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>    rv <span class="op">=</span> vm_inherit<span class="op">(</span>self<span class="op">,</span> lock<span class="op">.</span>handle<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">int</span><span class="op">),</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a> VM_INHERIT_SHARE<span class="op">);</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>rv <span class="op">!=</span> KERN_SUCCESS<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>        error <span class="op">=</span> <span class="st">&quot;Could not vm_inherit&quot;</span><span class="op">;</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">goto</span> vm_cow_error_return<span class="op">;</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>lock<span class="op">.</span>indexed <span class="op">=</span> NO_ONE_WAIT<span class="op">;</span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>    rv <span class="op">=</span> vm_allocate<span class="op">(</span>self<span class="op">,</span> <span class="op">&amp;</span>mem<span class="op">.</span>handle<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">int</span><span class="op">)</span> <span class="op">*</span> MAXDATA<span class="op">,</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a> TRUE<span class="op">);</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>rv <span class="op">!=</span> KERN_SUCCESS<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>        error <span class="op">=</span> <span class="st">&quot;Could not vm_allocate&quot;</span><span class="op">;</span></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">goto</span> vm_cow_error_return<span class="op">;</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>    mem<span class="op">.</span>indexed<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> COPY_ON_WRITE<span class="op">;</span></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;value of lock before fork: %s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a> lock_status<span class="op">[*</span>lock<span class="op">.</span>indexed<span class="op">]);</span></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>    pid <span class="op">=</span> fork<span class="op">();</span></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>pid<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;PARENT: copied memory = %s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a> cow_status<span class="op">[</span>mem<span class="op">.</span>indexed<span class="op">[</span><span class="dv">0</span><span class="op">]]);</span></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;PARENT: changing to %s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a> cow_status<span class="op">[</span>PARENT_CHANGED<span class="op">]);</span></span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>        mem<span class="op">.</span>indexed<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> PARENT_CHANGED<span class="op">;</span></span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;PARENT: lock = %s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a> lock_status<span class="op">[*</span>lock<span class="op">.</span>indexed<span class="op">]);</span></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;PARENT: changing lock to %s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a> lock_status<span class="op">[</span>PARENT_WAIT<span class="op">]);</span></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>        <span class="op">*</span>lock<span class="op">.</span>indexed <span class="op">=</span> PARENT_WAIT<span class="op">;</span></span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="op">(*</span>lock<span class="op">.</span>indexed <span class="op">==</span> PARENT_WAIT<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>            <span class="co">/* wait for child to change the value */</span></span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>            <span class="op">;</span></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;PARENT: copied memory = %s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a> cow_status<span class="op">[</span>mem<span class="op">.</span>indexed<span class="op">[</span><span class="dv">0</span><span class="op">]]);</span></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;PARENT: lock = %s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a> lock_status<span class="op">[*</span>lock<span class="op">.</span>indexed<span class="op">]);</span></span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>        printf<span class="op">(</span><span class="st">&quot;PARENT: Finished.</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>        <span class="op">*</span>lock<span class="op">.</span>indexed <span class="op">=</span> PARENT_WAIT<span class="op">;</span></span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>        exit<span class="op">(-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(*</span>lock<span class="op">.</span>indexed <span class="op">!=</span> PARENT_WAIT<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* wait for parent to change lock */</span></span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>        <span class="op">;</span></span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;CHILD: copied memory = %s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a> cow_status<span class="op">[</span>mem<span class="op">.</span>indexed<span class="op">[</span><span class="dv">0</span><span class="op">]]);</span></span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;CHILD: changing to %s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> cow_status<span class="op">[</span>CHILD_CHANGED<span class="op">]);</span></span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a>    mem<span class="op">.</span>indexed<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> CHILD_CHANGED<span class="op">;</span></span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;CHILD: lock = %s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> lock_status<span class="op">[*</span>lock<span class="op">.</span>indexed<span class="op">]);</span></span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;CHILD: changing lock to %s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a> lock_status<span class="op">[</span>CHILD_WAIT<span class="op">]);</span></span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>lock<span class="op">.</span>indexed <span class="op">=</span> CHILD_WAIT<span class="op">;</span></span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(*</span>lock<span class="op">.</span>indexed <span class="op">==</span> CHILD_WAIT<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a>        <span class="co">/* wait for parent to change lock */</span></span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a>        <span class="op">;</span></span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a>    rv <span class="op">=</span> vm_deallocate<span class="op">(</span>mach_task_self<span class="op">(),</span> lock<span class="op">.</span>handle<span class="op">,</span></span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">int</span><span class="op">));</span></span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>rv <span class="op">!=</span> KERN_SUCCESS<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a>        error <span class="op">=</span> <span class="st">&quot;vm_deallocate failed&quot;</span><span class="op">;</span></span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">goto</span> vm_cow_error_return<span class="op">;</span></span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a>    rv <span class="op">=</span> vm_deallocate<span class="op">(</span>mach_task_self<span class="op">(),</span> mem<span class="op">.</span>handle<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">int</span><span class="op">)</span></span>
<span id="cb8-126"><a href="#cb8-126" aria-hidden="true" tabindex="-1"></a> <span class="op">*</span> MAXDATA<span class="op">);</span></span>
<span id="cb8-127"><a href="#cb8-127" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>rv <span class="op">!=</span> KERN_SUCCESS<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-128"><a href="#cb8-128" aria-hidden="true" tabindex="-1"></a>        error <span class="op">=</span> <span class="st">&quot;vm_deallocate failed&quot;</span><span class="op">;</span></span>
<span id="cb8-129"><a href="#cb8-129" aria-hidden="true" tabindex="-1"></a>        <span class="cf">goto</span> vm_cow_error_return<span class="op">;</span></span>
<span id="cb8-130"><a href="#cb8-130" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-131"><a href="#cb8-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-132"><a href="#cb8-132" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;CHILD: Finished.</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;END: vm_copy_on_write_example()</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb8-134"><a href="#cb8-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-135"><a href="#cb8-135" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb8-136"><a href="#cb8-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-137"><a href="#cb8-137" aria-hidden="true" tabindex="-1"></a>vm_cow_error_return<span class="op">:</span></span>
<span id="cb8-138"><a href="#cb8-138" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;%s: %s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> error<span class="op">,</span> mach_error_string<span class="op">(</span>rv<span class="op">));</span></span>
<span id="cb8-139"><a href="#cb8-139" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb8-140"><a href="#cb8-140" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This program produces the following output:</p>
<pre><code>START: vm_copy_on_write_example()
value of lock before fork: NO_ONE_WAIT 0
PARENT: copied memory = COPY_ON_WRITE 0
PARENT: changing to PARENT_CHANGED 1

PARENT: lock = NO_ONE_WAIT 0
PARENT: changing lock to PARENT_WAIT 1

CHILD: copied memory = COPY_ON_WRITE 0
CHILD: changing to CHILD_CHANGED 2

CHILD: lock = PARENT_WAIT 1
CHILD: changing lock to CHILD_WAIT 2

PARENT: copied memory = PARENT_CHANGED 1
PARENT: lock = CHILD_WAIT 2
PARENT: Finished.
CHILD: Finished.
END: vm_copy_on_write_example()</code></pre>
<p>As we can see the <code>vm_inherit()</code> routine will provide both the child and parent access to the same memory until it is modified. After that, the child and parent have separate memory pages representing their own copy of the data values which can now be different.</p>
<p>This program uses a very primitive form of task coordination: busy while loops. A realistic example would use the <code>pthread</code> library instead for signalling and coordination.</p>
<h1 class="unnumbered" id="bibliography">Bibliography</h1>
<div id="refs" class="references csl-bib-body hanging-indent" role="doc-bibliography">
<div id="ref-offensiveworklovehate" class="csl-entry" role="doc-biblioentry">
Dullien, Thomas. 2021. <span>“OffensiveCon20 - Halvar Flake - Keynote - Why i Love Offensive Work, Why i Don’t Love Offensive Work.”</span> <a href="https://www.youtube.com/watch?v=8QRnOpjmneo">https://www.youtube.com/watch?v=8QRnOpjmneo</a>.
</div>
<div id="ref-gpz" class="csl-entry" role="doc-biblioentry">
Google. 2021. <span>“Google Project Zero.”</span> <a href="https://googleprojectzero.blogspot.com/p/about-project-zero.html">https://googleprojectzero.blogspot.com/p/about-project-zero.html</a>.
</div>
<div id="ref-codecomplete2" class="csl-entry" role="doc-biblioentry">
McConnell, Steve. 2004. <em>Code Complete</em>. Second Edition. 1st Series 0735619670. Microsoft Press.
</div>
<div id="ref-trtzgithub" class="csl-entry" role="doc-biblioentry">
Memon, Faisal. 2021. <span>“The Road to Zero Book GitHub Resources.”</span> <a href="https://github.com/faisalmemon/the-road-to-zero">https://github.com/faisalmemon/the-road-to-zero</a>.
</div>
<div id="ref-machconcepts" class="csl-entry" role="doc-biblioentry">
NeXT Software, Inc. 1995. <span>“Mach Concepts.”</span> NeXT Computer, Inc. <a href="https://www.nextop.de/NeXTstep_3.3_Developer_Documentation/OperatingSystem/Part1_Mach/01_Concepts/Concepts.htmld/">https://www.nextop.de/NeXTstep_3.3_Developer_Documentation/OperatingSystem/Part1_Mach/01_Concepts/Concepts.htmld/</a>.
</div>
<div id="ref-exploitdb" class="csl-entry" role="doc-biblioentry">
Security, Offensive. 2021. <span>“Exploit Database Git Repository.”</span> <a href="https://github.com/offensive-security/exploitdb">https://github.com/offensive-security/exploitdb</a>.
</div>
<div id="ref-machsyscalls" class="csl-entry" role="doc-biblioentry">
Walmer, Linda R., and Mary R. Thompson. 1988. <span>“A Programmer’s Guide to the Mach System Calls.”</span> Carnegie-Mellon University.
</div>
</div>
</body>
</html>
