<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<!-- Created with LatinByrd III -->
<!-- File: /Apps/NextDev/DevTools/14_MachO/MachO.rtf -->
<!-- Date: Sun Jun 28 19:51:33 1998 -->
<head>
<title>MachO</title>
</head>

<body bgcolor="#FFFFFF" text="#000000" link="#0000FF" alink="#FF00FF" vlink="#FF0000">

<basefont size=3>

<p><font face="Times" size="-1">Copyright</font> <font size="-1">&copy;</font><font face="Times" size="-1">1995 by NeXT Computer, Inc.&nbsp; All Rights Reserved.</font>

<p><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=6></td>

<td><font face="Helvetica" size="+3" color="#FF00FF"><b>14</b></font></td></tr>

</table>

<p><br><br>

<p><font face="Times" size="+3"><i>Mach Object Files</i></font>

<p><br><br><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">This chapter describes the format of Mach object files.&nbsp; This format is used by default, rather than the UNIX 4.3BSD <b>a.out </b>format, for object files on NEXTSTEP computers.</font>

<p><font face="Times">The current Mach object format is still evolving at Carnegie Mellon, and enhancements in NEXTSTEP are part of this evolving process.&nbsp; These enhancements refine the design and clean up some implementation details.&nbsp; The concepts of the original design are still present, but names have been changed for consistency.</font>

<p><font face="Times">The Mach object file format has two components:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">A static header containing information common to all files</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">A variable number of load commands that provide information about the structure of the file</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The load commands provide the following types of information:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">The layout of the run-time memory image</font></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">The symbol table information</font></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">The initial thread execution state</font></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">The names of any referenced shared libraries</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The layout of the file is determined by the file type:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">For types MH_EXECUTE and MH_FVMLIB the segments are padded out and aligned on a segment alignment boundary for efficient demand paging.&nbsp; Both these file types also have the headers included as part of their first segment.</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">The type MH_OBJECT is a compact format (the &quot;.o&quot; format).&nbsp; It's intended only as output of the assembler and input (or possibly output) of the link editor.&nbsp; All sections are in one unnamed segment with no padding.</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">The type MH_PRELOAD is an executable format intended for files that aren't executed under the kernel (such as PROMs, standalone programs, and kernels).</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">The type MH_CORE is for core files.</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The structures of a Mach object file are defined in the header file <b>mach-o/loader.h</b>, and are described below.&nbsp; The structures and what they're used for are described first, followed by a list of what structures make up Mach object files.</font></td></tr>

</table>

<p><br><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=6></td>

<td><font face="Helvetica" size="+2"><b>The Mach Header</b></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The Mach header appears at the beginning of the object file.&nbsp; Only information that's truly general to the file is contained in the Mach header.&nbsp; Other information is put in the load commands that follow.</font>

<p><font face="Times">The format of the Mach header is:</font></td></tr>

</table>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">struct mach_header {</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; magic;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* Mach magic number identifier */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">cpu_type_t&nbsp;&nbsp;&nbsp;&nbsp; cputype;&nbsp;&nbsp;&nbsp; /* cpu specifier */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">cpu_subtype_t&nbsp; cpusubtype; /* machine specifier */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; filetype;&nbsp;&nbsp; /* type of file */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; ncmds;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* number of load commands */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; sizeofcmds; /* size of all load commands */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; flags;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* flags */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">};</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The value for the <b>magic</b> field of the <b>mach_header</b> structure is:</font></td></tr>

</table>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define MH_MAGIC&nbsp;&nbsp;&nbsp; 0xfeedface&nbsp; /* the Mach magic number */</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The values for the <b>cputype</b> and <b>cpusubtype</b> fields are defined as follows in the header file <b>sys/machine.h</b>:</font></td></tr>

</table>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define CPU_TYPE_MC680x0&nbsp;&nbsp;&nbsp;&nbsp; ((cpu_type_t) 6)</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define CPU_SUBTYPE_MC68030&nbsp; ((cpu_subtype_t) 1)</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define CPU_SUBTYPE_MC68040&nbsp; ((cpu_subtype_t) 2)</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The values for the <b>filetype</b> field are defined as follows in the header file <b>sys/loader.h</b>:</font></td></tr>

</table>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define MH_OBJECT&nbsp;&nbsp; 0x1&nbsp;&nbsp;&nbsp; /* relocatable object file */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define MH_EXECUTE&nbsp; 0x2&nbsp;&nbsp;&nbsp; /* executable object file */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define MH_FVMLIB&nbsp;&nbsp; 0x3&nbsp;&nbsp;&nbsp; /* fixed vm shared library file */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define MH_CORE&nbsp;&nbsp;&nbsp;&nbsp; 0x4&nbsp;&nbsp;&nbsp; /* core file */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define MH_PRELOAD&nbsp; 0x5&nbsp;&nbsp;&nbsp; /* preloaded executable file */</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The <b>ncmds</b> field contains the number of <b>load_command</b> structures that follow the Mach header.&nbsp; The <b>load_command </b>structures directly follow the Mach header in the object file.</font>

<p><font face="Times">The <b>sizeofcmds</b> field contains the total size in bytes of all of the load commands that follow it.</font>

<p><font face="Times">The following constants are used for the <b>flags</b> field:</font></td></tr>

</table>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define MH_NOUNDEFS&nbsp; 0x1&nbsp; /* object file has no undefined references;</font><br>
<img src="../../Images/sp.gif" width=327 height=1><font face="Courier" size="-1">can be executed */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define MH_INCRLINK&nbsp; 0x2&nbsp; /* object file is the output of an</font><br>
<img src="../../Images/sp.gif" width=327 height=1><font face="Courier" size="-1">incremental link against a base file;</font><br>
<img src="../../Images/sp.gif" width=327 height=1><font face="Courier" size="-1">can't be link-edited again */</font>

<p><br><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=6></td>

<td><font face="Helvetica" size="+2"><b>The Load Commands</b></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The load commands appear directly after the Mach header.&nbsp; They are variable in size.&nbsp; The number of load commands and the total size of the commands are given in the <b>ncmds</b> and <b>sizeofcmds</b> fields of the <b>mach_header</b> structure.</font>

<p><font face="Times">All load commands must have as their first two fields <b>cmd</b> and <b>cmdsize</b>:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">The <b>cmd</b> field contains a constant for that command type.&nbsp; Each command type has a specific structure corresponding to it.</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">The <b>cmdsize</b> field is the size in bytes of the particular <b>load_command</b> structure plus anything that follows it that's a part of the load command (for example, <b>section</b> structures or strings).&nbsp; To advance to the next load command, the value of the <b>cmdsize</b> field can be added to the offset or pointer of the current load command.</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The value of the <b>cmdsize</b> field must be a multiple of <b>sizeof(long)</b>.&nbsp; This is the maximum alignment of any load command.&nbsp; The padded bytes must be zero-filled.&nbsp; Because the file will be memory mapped, all tables in the object file must also follow these rules; otherwise the pointers to these tables are not guaranteed to work.&nbsp; With all padding zero-filled, like objects will compare byte for byte.</font>

<p><font face="Times">The following structure is the minimum form of a load command:</font></td></tr>

</table>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">struct load_command {</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; cmd;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* type of load command */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; cmdsize;&nbsp; /* total size of command in bytes */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">};</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">Constants for the <b>cmd</b> field of the <b>load_command</b> structure are:</font></td></tr>

</table>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define LC_SEGMENT&nbsp;&nbsp;&nbsp;&nbsp; 0x1&nbsp;&nbsp; /* file segment to be mapped */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define LC_SYMTAB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0x2&nbsp;&nbsp; /* link-edit stab symbol table info</font><br>
<img src="../../Images/sp.gif" width=348 height=1><font face="Courier" size="-1">(obsolete) */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define LC_SYMSEG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0x3&nbsp;&nbsp; /* link-edit gdb symbol table info */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define LC_THREAD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0x4&nbsp;&nbsp; /* thread */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define LC_UNIXTHREAD&nbsp; 0x5&nbsp;&nbsp; /* UNIX thread (includes a stack) */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define LC_LOADFVMLIB&nbsp; 0x6&nbsp;&nbsp; /* load a fixed VM shared library */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define LC_IDFVMLIB&nbsp;&nbsp;&nbsp; 0x7&nbsp;&nbsp; /* fixed VM shared library id */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define LC_IDENT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0x8&nbsp;&nbsp; /* object identification information</font><br>
<img src="../../Images/sp.gif" width=348 height=1><font face="Courier" size="-1">(obsolete) */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define LC_FVMFILE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0x9&nbsp;&nbsp; /* fixed VM file inclusion */</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">A variable-length string in a load command is represented by an <b>lc_str</b> union.&nbsp; The string is stored just after the <b>load_command </b>structure, and the offset is from the start of the <b>load_command</b> structure.&nbsp; The size of the string is reflected in the <b>cmdsize</b> field of the load command.&nbsp; Any padded bytes to bring the <b>cmdsize</b> field to a multiple of <b>sizeof(long)</b> must be zero-filled.</font></td></tr>

</table>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">union lc_str {</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; offset;&nbsp;&nbsp; /* offset to the string */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">char&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *ptr;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* pointer to the string */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">};</font>

<p><br><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Helvetica" size="+1"><b>The LC_SEGMENT Load Command</b></font>

<p><font face="Times">The LC_SEGMENT load command indicates that a part of this file is to be mapped into the task's address space.&nbsp; The size of this segment in memory, <b>vmsize</b>, can be equal to or larger than the amount to map from this file, <b>filesize</b>.&nbsp; The file, starting at <b>fileoff</b>, is mapped to the beginning of the segment in memory at <b>vmaddr</b>.&nbsp; The rest of the memory of the segment, if any, is allocated zero-fill on demand.</font></td></tr>

</table>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">struct segment_command {</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; cmd;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* LC_SEGMENT */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; cmdsize;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* includes size of section</font><br>
<img src="../../Images/sp.gif" width=376 height=1><font face="Courier" size="-1">structures */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">char&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; segname[16];&nbsp; /* segment's name */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; vmaddr;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* segment's memory address */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; vmsize;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* segment's memory size */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; fileoff;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* segment's file offset */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; filesize;&nbsp;&nbsp;&nbsp;&nbsp; /* amount to map from file */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">vm_prot_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; maxprot;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* maximum VM protection */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">vm_prot_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; initprot;&nbsp;&nbsp;&nbsp;&nbsp; /* initial VM protection */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; nsects;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* number of sections */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; flags;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* flags */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">};</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The segment's maximum virtual memory protection and initial virtual memory protection are specified by the <b>maxprot</b> and <b>initprot</b> fields.&nbsp; The values for these fields are set to some combination of the constants defined in the header file <b>vm/vm_prot.h</b>:</font></td></tr>

</table>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define VM_PROT_NONE&nbsp;&nbsp;&nbsp; ((vm_prot_t) 0x00)</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define VM_PROT_READ&nbsp;&nbsp;&nbsp; ((vm_prot_t) 0x01)&nbsp; /* read permission */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define VM_PROT_WRITE&nbsp;&nbsp; ((vm_prot_t) 0x02)&nbsp; /* write permission */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define VM_PROT_EXECUTE ((vm_prot_t) 0x04)&nbsp; /* execute permission */</font>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">/* The default protection for newly created virtual memory */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define VM_PROT_DEFAULT&nbsp; \</font><br>
<img src="../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">(VM_PROT_READ | VM_PROT_WRITE | VM_PROT_EXECUTE)</font>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">/* Maximum privileges possible, for parameter checking. */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define VM_PROT_ALL&nbsp; \</font><br>
<img src="../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">(VM_PROT_READ | VM_PROT_WRITE | VM_PROT_EXECUTE)</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">A segment's address and virtual memory protection are set at link edit time.</font>

<p><font face="Times">The following constants can be used for the <b>flags</b> field of the <b>segment_command</b> structure:</font></td></tr>

</table>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define SG_HIGHVM&nbsp;&nbsp; 0x1</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define SG_FVMLIB&nbsp;&nbsp; 0x2</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define SG_NORELOC&nbsp; 0x3</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">SG_HIGHVM indicates that the file contents for this segment occupy the high part of the virtual memory space; the low part is zero-filled (for stacks in core files).&nbsp; SG_FVMLIB indicates that the segment is the virtual memory that's allocated by a fixed virtual memory library for overlap checking in the link editor.&nbsp; SG_NORELOC indicates that the segment has nothing that was relocated in it and nothing relocated to it (that is, it may be safely replaced without relocation).</font>

<p><font face="Times">A segment is made up of zero or more sections.&nbsp; If the segment contains sections, the section structures directly follow the segment command and their size is reflected in the <b>cmdsize</b> field.</font>

<p><font face="Times">If sections have the same section name and are going into the same segment, they're combined by the link editor.&nbsp; The resulting section is aligned to the maximum alignment of the combined sections and is the new section's alignment.&nbsp; The combined sections are aligned to their original alignment in the combined section.&nbsp; Any padded bytes used to get the specified alignment are zero-filled.</font>

<p><font face="Times">Only non-MH_OBJECT files have all their segments with the proper sections in each padded to the specified segment alignment.&nbsp; The default segment alignment for the link editor is the page size.&nbsp; The first segment of an executable or shared library always contains the Mach header and load commands of the object file before its first section.&nbsp; The zero-filled sections are always last in their segment, allowing the zeroed segment padding to be mapped into memory where zero-filled sections might be.</font></td></tr>

</table>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">struct section {</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">char&nbsp; sectname[16];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* section's name */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">char&nbsp; segname[16];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* segment the section is in */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; addr;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* section's memory address */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; size;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* section's size in bytes */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; offset;&nbsp;&nbsp;&nbsp;&nbsp; /* section's file offset */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; align;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* section's alignment */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; reloff;&nbsp;&nbsp;&nbsp;&nbsp; /* file offset of relocation entries */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; nreloc;&nbsp;&nbsp;&nbsp;&nbsp; /* number of relocation entries */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; flags;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* flags */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; reserved1;&nbsp; /* reserved */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; reserved2;&nbsp; /* reserved */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">};</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">Flags currently defined for the <b>flags</b> field of a <b>section</b> structure are the following:</font></td></tr>

</table>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define S_ZEROFILL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0x1&nbsp; /* zero-filled on demand */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define S_CSTRING_LITERALS 0x2&nbsp; /* section has only literal C</font><br>
<img src="../../Images/sp.gif" width=369 height=1><font face="Courier" size="-1">strings */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define S_4BYTE_LITERALS&nbsp;&nbsp; 0x2&nbsp; /* section has only 4-byte literals */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define S_8BYTE_LITERALS&nbsp;&nbsp; 0x2&nbsp; /* section has only 8-byte literals */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define S_LITERAL_POINTERS 0x2&nbsp; /* section has only pointers to</font><br>
<img src="../../Images/sp.gif" width=369 height=1><font face="Courier" size="-1">literals */</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">S_ZEROFILL is used for the uninitialized data sections; sections with literal flags cause the link editor to coalesce redundant literals into sections and perform the proper relocation, resulting in a smaller file.</font>

<p><font face="Times">The format of the relocation entries referenced by the <b>reloff</b> and <b>nreloc</b> fields is described in the header file <b>reloc.h</b>.</font>

<p><font face="Times">Although the names of segments and sections in them are mostly meaningless to the link editor, there are a few things to support traditional UNIX executables that will require the link editor and assembler to use some agreed-upon names.</font>

<p><font face="Times">The link editor will allocate common symbols at the end of the <b>__common</b> section in the <b>__DATA</b> segment, creating the section and segment if needed.&nbsp; The <b>__common</b> section must be a zero-fill section (marked with S_ZEROFILL).</font>

<p><font face="Times">The default <b>maxprot</b> and <b>initprot</b> (maximum and initial virtual memory protection) will always be read, write, and execute.&nbsp; If there's a <b>__TEXT</b> or <b>__LINKEDIT</b> segment its <b>initprot</b> won't be writable by default.</font>

<p><font face="Times">The following are constants for the conventional segment and section names:</font></td></tr>

</table>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define SEG_PAGEZERO&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#34;__PAGEZERO&#34;&nbsp; /* pagezero segment; has no</font><br>
<img src="../../Images/sp.gif" width=425 height=1><font face="Courier" size="-1">protections; catches NULL</font><br>
<img src="../../Images/sp.gif" width=425 height=1><font face="Courier" size="-1">references for MH_EXECUTE</font><br>
<img src="../../Images/sp.gif" width=425 height=1><font face="Courier" size="-1">files */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define SEG_TEXT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#34;__TEXT&#34; /* traditional UNIX text segment */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define SECT_TEXT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#34;__text&#34; /* real text part of the text</font><br>
<img src="../../Images/sp.gif" width=390 height=1><font face="Courier" size="-1">section; no headers and</font><br>
<img src="../../Images/sp.gif" width=390 height=1><font face="Courier" size="-1">padding */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define SECT_FVMLIB_INIT0 &#34;__fvmlib_init0&#34;&nbsp; /* fvmlib initialization</font><br>
<img src="../../Images/sp.gif" width=453 height=1><font face="Courier" size="-1">section */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define SECT_FVMLIB_INIT1 &#34;__fvmlib_init1&#34;&nbsp; /* the section following</font><br>
<img src="../../Images/sp.gif" width=453 height=1><font face="Courier" size="-1">the fvmlib</font><br>
<img src="../../Images/sp.gif" width=453 height=1><font face="Courier" size="-1">initialization</font><br>
<img src="../../Images/sp.gif" width=453 height=1><font face="Courier" size="-1">section */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define SEG_DATA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#34;__DATA&#34; /* traditional UNIX data segment */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define SECT_DATA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#34;__data&#34; /* real initialized data section;</font><br>
<img src="../../Images/sp.gif" width=390 height=1><font face="Courier" size="-1">no padding, no bss overlap */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define SECT_BSS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#34;__bss&#34;&nbsp; /* real uninitialized data</font><br>
<img src="../../Images/sp.gif" width=390 height=1><font face="Courier" size="-1">section; no padding */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define SECT_COMMON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#34;__common&#34; /* the section common symbols</font><br>
<img src="../../Images/sp.gif" width=404 height=1><font face="Courier" size="-1">are allocated in by the link</font><br>
<img src="../../Images/sp.gif" width=404 height=1><font face="Courier" size="-1">editor */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define SEG_OBJC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#34;__OBJC&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* run-time segment */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define SECT_OBJC_SYMBOLS &#34;__symbol_table&#34;&nbsp; /* symbol table */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define SECT_OBJC_MODULES &#34;__module_info&#34;&nbsp;&nbsp; /* (obsolete!) */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define SECT_OBJC_STRINGS &#34;__selector_strs&#34; /* string table */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define SECT_OBJC_REFS&nbsp;&nbsp;&nbsp; &#34;__selector_refs&#34; /* string table */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define SEG_ICON&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#34;__ICON&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* NeXT icon segment */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define SECT_ICON_HEADER&nbsp; &#34;__header&#34;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* icon headers */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define SECT_ICON_TIFF&nbsp;&nbsp;&nbsp; &#34;__tiff&#34;&nbsp;&nbsp;&nbsp; /* icons in TIFF format */</font>

<p><br><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Helvetica" size="+1"><b>The LC_SYMTAB Load Command</b></font>

<p><font face="Times">The LC_SYMTAB command specifies the location and size of the symbol table information created by the compiler used for link editing and debugging.&nbsp; This UNIX 4.3BSD <b>stab</b>-style symbol table information is defined in the header files <b>nlist.h</b> and <b>stabs.h</b>:</font></td></tr>

</table>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">struct symtab_command {</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; cmd;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* LC_SYMTAB */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; cmdsize;&nbsp; /* sizeof(struct symtab_command) */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; symoff;&nbsp;&nbsp; /* symbol table offset */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; nsyms;&nbsp;&nbsp;&nbsp; /* number of symbol table entries */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; stroff;&nbsp;&nbsp; /* string table offset */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; strsize;&nbsp; /* string table size in bytes */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">};</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The LC_SYMTAB command contains the offsets for both the symbol table entries and the string table used by those entries. This format is different from the UNIX 4.3BSD <b>a.out</b> format:&nbsp; The string table offset and size are explicitly defined, and the symbol table and string tables are located at the end of the file (not after the LC_SYMTAB command).</font>

<p><font face="Times">The format of a symbol table entry is defined in the header file <b>nlist.h</b>:</font></td></tr>

</table>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">struct nlist {</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">union {</font><br>
<img src="../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">char&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *n_name;&nbsp;&nbsp; /* for use when in-core */</font><br>
<img src="../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">long&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; n_strx;&nbsp;&nbsp; /* index into file string table */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">} n_un;</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned char&nbsp; n_type;&nbsp;&nbsp; /* type flag; see below */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned char&nbsp; n_sect;&nbsp;&nbsp; /* section number or NO_SECT */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">short&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; n_desc;&nbsp;&nbsp; /* see the header file stab.h */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; n_value;&nbsp; /* value of this symbol table entry</font><br>
<img src="../../Images/sp.gif" width=348 height=1><font face="Courier" size="-1">(or stab offset) */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">};</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">Symbols with an index into the string table of zero (<b>n_un.n_strx</b> == 0) are defined to have a null (&#34;&#34;) name.&nbsp; Therefore, all string indexes to non-null names must not have a zero string length.</font>

<p><font face="Times">In the file, a symbol's <b>n_un.n_strx</b> field gives an index into the string table.&nbsp; An <b>n_strx</b> value of 0 indicates that no name is associated with a particular symbol table entry.&nbsp; The field <b>n_un.n_name</b> can be used to refer to the symbol name only if the program sets this up using <b>n_strx</b> and appropriate data from the string table.</font>

<p><font face="Times">The flag values that distinguish symbol types are defined in the header file <b>nlist.h</b>.&nbsp; The <b>n_type</b> field actually contains three fields, and if declared as such would be:</font></td></tr>

</table>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">unsigned char&nbsp; N_STAB:3,</font><br>
<img src="../../Images/sp.gif" width=229 height=1><font face="Courier" size="-1">N_TYPE:4,</font><br>
<img src="../../Images/sp.gif" width=229 height=1><font face="Courier" size="-1">N_EXT:1;</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">These fields are used by specifying the following masks:</font></td></tr>

</table>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define N_STAB&nbsp; 0xe0&nbsp; /* if any bits are set, this is a symbolic</font><br>
<img src="../../Images/sp.gif" width=299 height=1><font face="Courier" size="-1">debugging entry */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define N_TYPE&nbsp; 0x1e&nbsp; /* mask for the type bits */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define N_EXT&nbsp;&nbsp; 0x01&nbsp; /* external symbol bit; set for external</font><br>
<img src="../../Images/sp.gif" width=299 height=1><font face="Courier" size="-1">symbols */</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">Some of the N_STAB bits will be set if and only if the entry is a symbolic debugging entry (an <b>stab</b>)--in this case, the values for the N_TYPE bits of the <b>n_type</b> field (the entire field) are as shown in the header file <b>stab.h</b>.&nbsp; Normal values for the N_TYPE bits of the <b>n_type</b> field are:</font></td></tr>

</table>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define N_UNDF&nbsp; 0x0&nbsp;&nbsp; /* undefined; n_sect == NO_SECT */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define N_ABS&nbsp;&nbsp; 0x2&nbsp;&nbsp; /* absolute; n_sect == NO_SECT */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define N_SECT&nbsp; 0xe&nbsp;&nbsp; /* defined in section number n_sect */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define N_INDR&nbsp; 0xa&nbsp;&nbsp; /* indirect */</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">If the type is N_SECT, the <b>n_sect</b> field contains an ordinal of the section the symbol is defined in.&nbsp; The sections are numbered from 1 and refer to sections in the order in which they appear in the load commands for the file they're in.&nbsp; Therefore the same ordinal may refer to different sections in different files.&nbsp; This is the most common type of symbol.</font>

<p><font face="Times">If the type is N_INDR, the symbol is defined to be the same as another symbol.&nbsp; In this case the <b>n_value</b> field is an index into the string table of the other symbol's name.&nbsp; When the other symbol is defined, they both take on the defined type and value.</font>

<p><font face="Times">The <b>n_value</b> field for all symbol table entries (including N_STABs) gets updated by the link editor based on the value of the <b>n_sect</b> field and where the section's <b>n_sect</b> references get relocated.&nbsp; If the value of the <b>n_sect</b> field is NO_SECT, its <b>n_value </b>field isn't relocated by the link editor.</font></td></tr>

</table>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define NO_SECT&nbsp;&nbsp;&nbsp;&nbsp; 0&nbsp;&nbsp; /* the symbol isn't in any section */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define MAX_SECT&nbsp; 255&nbsp;&nbsp; /* 1 through 255 inclusive */</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">Common symbols are represented by undefined (N_UNDF) external (N_EXT) types whose values (<b>n_value</b>) are nonzero.&nbsp; In this case the value of the <b>n_value</b> field is the size in bytes of the common symbol, and the value of the <b>n_sect</b> field is NO_SECT.</font>

<p><br><br><br>

<p><font face="Helvetica" size="+1"><b>The LC_THREAD and LC_UNIXTHREAD Load Commands</b></font>

<p><font face="Times">Thread commands contain machine-specific data structures suitable for use in the thread state primitives.&nbsp; The machine-specific data structures follow the <b>struct thread_command</b> or <b>struct unixthread_command</b> as follows:&nbsp; Each flavor of machine-specific data structure is preceded by an unsigned long constant for the flavor of that data structure and an unsigned long that's the count of longs of the size of the state data structure, and then the state data structure follows that.&nbsp; This triple may be repeated for many flavors.</font>

<p><font face="Times">The constants for the <b>flavor</b>, <b>count</b>, and <b>state</b> data structure definitions are expected to be in the header file <b>machine/thread_status.h</b>; these machine-specific data structure sizes must be multiples of <b>sizeof(long)</b>.&nbsp; The <b>cmdsize</b> reflects the total size of the <b>thread_command</b> structure and all of the sizes of the constants for the <b>flavor</b>, <b>count</b>, and <b>state</b> data structures.</font></td></tr>

</table>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">struct thread_command {</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; cmd;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* LC_THREAD or LC_UNIXTHREAD */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; cmdsize;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* sizeof(struct thread_command) */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">/* unsigned long&nbsp; flavor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; flavor of thread state */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">/* unsigned long&nbsp; count&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; count of longs in thread state */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">/* struct XXX_thread_state state&nbsp;&nbsp; flavor's thread state */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">/* . . . */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">};</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The LC_UNIXTHREAD command specifies an initial thread execution state for a UNIX process.&nbsp; For an executable object that's a UNIX process, there's one <b>unixthread_command</b> created by the link editor.&nbsp; A stack is created based on the UNIX rlimit for the stack.&nbsp; This stack will contain the command arguments and environment variables when the program is executed. The entry point is placed in the program counter in the thread state.&nbsp; The stack address is placed in the stack pointer by the kernel when this program is executed.&nbsp; The stack is created as a zero-fill on demand region when the object is launched.&nbsp; Then the command line and environment arguments are placed on the stack and the stack pointer in the thread state is modified.</font>

<p><br><br><br>

<p><font face="Helvetica" size="+1"><b>The LC_LOADFVMLIB and LC_IDFVMLIB Commands</b></font>

<p><font face="Times">A fixed virtual shared library has the file type MH_FVMLIB in the Mach header, and contains the <b>fvmlib_command </b>LC_IDFVMLIB to identify the library.&nbsp; An object that uses a fixed virtual shared library contains the <b>fvmlib_command </b>LC_LOADFVMLIB for each library it uses:</font></td></tr>

</table>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">struct fvmlib_command {</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; cmd;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* LC_IDFVMLIB or LC_LOADFVMLIB */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; cmdsize;&nbsp; /* includes pathname string */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">struct fvmlib&nbsp; fvmlib;&nbsp;&nbsp; /* the library identification */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">};</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">Fixed virtual memory shared libraries are identified by the target pathname (the name of the library as found for execution) and the minor version number:</font></td></tr>

</table>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">struct fvmlib {</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">union lc_str&nbsp;&nbsp; name;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* library's target pathname */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; minor_version;&nbsp; /* library's minor version</font><br>
<img src="../../Images/sp.gif" width=390 height=1><font face="Courier" size="-1">number */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">};</font>

<p><br><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Helvetica" size="+1"><b>The LC_LOADFVMFILE Command</b></font>

<p><font face="Times">The LC_LOADFVMFILE command contains a reference to a file to be loaded at the specified virtual address:</font></td></tr>

</table>

<p><img src="../../Images/sp.gif" width=127 height=1><font face="Courier" size="-1">struct fvmfile_command {</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; cmd;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* LC_FVMFILE */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; cmdsize&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* includes pathname string */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">union lc_str&nbsp;&nbsp; name;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* files pathname */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned long&nbsp; header_addr;&nbsp;&nbsp;&nbsp; /* files virtual address */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">};</font>

<p><br><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=6></td>

<td><font face="Helvetica" size="+2"><b>Relocation Information</b></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The value of a byte in a section that isn't a portion of a reference to an undefined external symbol is exactly the value that will appear in memory when the file is executed.&nbsp; If a byte in a section involves a reference to an undefined external symbol, as indicated by the relocation information, the value stored in the file is an offset from the associated external symbol.&nbsp; When the file is processed by the link editor and the external symbol becomes defined, the value of the symbol will be added to the bytes in the file.</font>

<p><font face="Times">If relocation information is present, it amounts to eight bytes for each relocatable entry.&nbsp; The structure of a relocation entry as given in the header file <b>reloc.h</b> is as follows:</font></td></tr>

</table>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">struct relocation_info {</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r_address;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* offset in the section to what is</font><br>
<img src="../../Images/sp.gif" width=362 height=1><font face="Courier" size="-1">being relocated */</font><br>
<img src="../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned&nbsp; r_symbolnum:24,&nbsp; /* symbol index if r_extern == 1 or</font><br>
<img src="../../Images/sp.gif" width=362 height=1><font face="Courier" size="-1">section ordinal if r_extern == 0 */</font><br>
<img src="../../Images/sp.gif" width=222 height=1><font face="Courier" size="-1">r_pcrel:1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* was relocated pc-relative already */</font><br>
<img src="../../Images/sp.gif" width=222 height=1><font face="Courier" size="-1">r_length:2,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 0=byte, 1=word, 2=long */</font><br>
<img src="../../Images/sp.gif" width=222 height=1><font face="Courier" size="-1">r_extern:1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* doesn't include value of symbol</font><br>
<img src="../../Images/sp.gif" width=362 height=1><font face="Courier" size="-1">referenced */</font><br>
<img src="../../Images/sp.gif" width=222 height=1><font face="Courier" size="-1">r_reserved:4;&nbsp;&nbsp;&nbsp; /* reserved */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">};</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define R_ABS&nbsp; 0&nbsp;&nbsp; /* absolute relocation type for Mach-O files */</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The <b>r_address</b> is an offset rather than an address.&nbsp; For Mach-O object files this offset is from the start of the section the relocation entry is for.</font>

<p><font face="Times">If <b>r_extern</b> is 0, <b>r_symbolnum</b> is an ordinal representing the section that contains the symbol being relocated.&nbsp; These ordinals refer to the sections in the object file in the order in which their section structures appear in the headers of the object file they're in.&nbsp; The first section has the ordinal 1, the second has the ordinal 2, and so on.&nbsp; Therefore the same ordinal in two different object files could refer to two different sections.&nbsp; Furthermore, the ordinals could change when combined by the link editor.&nbsp; The value R_ABS is used for relocation entries of absolute symbols that need no further relocation.</font>

<p><font face="Times">To make scattered loading by the link editor work correctly, &quot;local&quot; relocation entries can't be used when the item to be relocated is the value of a symbol plus an offset (where the resulting expression is outside the block the link editor is moving, blocks are divided at symbol addresses).&nbsp; If the item is a symbol value plus offset, the link editor needs to know more than just the section in which the symbol was defined.&nbsp; What is needed is the actual value of the symbol without the offset, so the link editor can do the relocation correctly based on where the value of the symbol got relocated to, not the value of the expression (with the offset added to the symbol value).&nbsp; For Release 2.0, no &quot;local&quot; relocation entries are ever used when there is a nonzero offset added to a symbol.&nbsp; The &quot;external&quot; and &quot;local&quot; relocation entries remain unchanged.</font>

<p><font face="Times">It's assumed that a section will never be bigger than 2**24</font> <img src="../../Images/c2D.gif" width=8 height=4> <font face="Times">1 (0x00ffffff or 16,777,215) bytes.&nbsp; This assumption allows the <b>r_address</b> (which is really an offset) to fit into 24 bits, and for the high bit of the <b>r_address</b> field in the <b>relocation_info</b> structure to indicate that it's really a <b>scattered_relocation_info</b> structure.&nbsp; Since these are only used in places where &quot;local&quot; relocation entries are used and not where &quot;external&quot; relocation entries are used, the <b>r_extern</b> field has been removed.</font></td></tr>

</table>

<p><img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define R_SCATTERED 0x80000000 /* mask to be applied to r_address</font><br>
<img src="../../Images/sp.gif" width=362 height=1><font face="Courier" size="-1">field of a relocation_info struct</font><br>
<img src="../../Images/sp.gif" width=362 height=1><font face="Courier" size="-1">to tell that it is really a</font><br>
<img src="../../Images/sp.gif" width=362 height=1><font face="Courier" size="-1">scattered_relocation_info struct */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">struct scattered_relocation_info {</font><br>
<img src="../../Images/sp.gif" width=138 height=1><font face="Courier" size="-1">unsigned int r_scattered:1,&nbsp; /* 1=scattered, 0=non-scattered */</font><br>
<img src="../../Images/sp.gif" width=229 height=1><font face="Courier" size="-1">r_pcrel:1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* was relocated pc relative already */</font><br>
<img src="../../Images/sp.gif" width=229 height=1><font face="Courier" size="-1">r_length:2,&nbsp;&nbsp;&nbsp;&nbsp; /* 0=byte, 1=word, 2=long */</font><br>
<img src="../../Images/sp.gif" width=229 height=1><font face="Courier" size="-1">r_reserved:4,&nbsp;&nbsp; /* reserved */</font><br>
<img src="../../Images/sp.gif" width=229 height=1><font face="Courier" size="-1">r_address:24;&nbsp;&nbsp; /* offset in the section to what is</font><br>
<img src="../../Images/sp.gif" width=362 height=1><font face="Courier" size="-1">being relocated */</font><br>
<img src="../../Images/sp.gif" width=138 height=1><font face="Courier" size="-1">long&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; r_value;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* the value the item to be relocated</font><br>
<img src="../../Images/sp.gif" width=362 height=1><font face="Courier" size="-1">refers to (with no offset added) */</font><br>
<img src="../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">};</font>

<p><br><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=6></td>

<td><font face="Helvetica" size="+2"><b>The Makeup of Executable Object Files</b></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">A typical executable (that is, with the filetype MH_EXECUTE) Mach-O object file produced by the link editor would contain the following components, in the order shown here:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">A Mach header</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">An LC_SEGMENT load command for the <b>__PAGEZERO</b> segment</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">An LC_SEGMENT load command for the <b>__TEXT</b> segment, followed by section headers for the sections in that segment. These section headers could include <b>__text</b>, <b>__fvmlib_init0</b>, <b>__fvmlib_init1</b>, <b>__const</b>, <b>__string</b>, <b>__literal8</b>, and <b>__literal4</b>.</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">An LC_SEGMENT load command for the <b>__DATA</b> segment, followed by the section headers for the sections in that segment.&nbsp; These section headers could include <b>__data</b>, <b>__bss</b>, and <b>__common</b>.</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">An LC_SEGMENT load command for the <b>__OBJC</b> segment, followed by the section headers for the sections in that segment.&nbsp; These section headers could include <b>__class</b>, <b>__meta_class</b>, <b>__cat_inst_meth</b>, <b>__els_meth</b>, <b>__inst_meth</b>, <b>__message_refs</b>, <b>__symbols</b>, <b>__category</b>, <b>__class_vars</b>, <b>__module_info</b>, and <b>__selector_strs</b>.</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">An LC_SEGMENT load command for the <b>__LINKEDIT</b> segment</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">An LC_SYMTAB load command</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">An LC_UNIXTHREAD load command</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">An LC_LOADFMVLIB load command for each shared library it uses</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">The <b>__TEXT</b> segment rounded out to the segment alignment</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">The <b>__DATA</b> segment rounded out to the segment alignment</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">The <b>__OBJC</b> segment rounded out to the segment alignment</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">All the relocation entries, if saved (normally not saved)</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">All the <b>stab</b> symbol and string tables, if not stripped</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">You can use the <b>otool</b> command to print the contents of object files and libraries that are in Mach-O format or in UNIX 4.3BSD <b>a.out</b> format.&nbsp; Various options allow you to specify certain portions of the Mach-O file.&nbsp; For example:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=124></td>

<td nowrap><font face="Times"><b>-h</b></font></td>

<td><font face="Times">Print the Mach header</font></td></tr>

<tr valign=top>

<td width=124></td>

<td nowrap><font face="Times"><b>-l</b></font></td>

<td><font face="Times">Print the load commands</font></td></tr>

<tr valign=top>

<td width=124></td>

<td nowrap><font face="Times"><b>-t</b></font></td>

<td><font face="Times">Print the contents of the <b>__text</b> section</font><br>
<img src="../../Images/sp.gif" width=6 height=1><font face="Times">(used with the <b>-v</b> flag, this disassembles the text;</font><br>
<img src="../../Images/sp.gif" width=9 height=1><font face="Times">with the <b>-V</b> flag it also symbolically disassembles the operands)</font></td></tr>

<tr valign=top>

<td width=124></td>

<td nowrap><font face="Times"><b>-d</b></font></td>

<td><font face="Times">Print the contents of the <b>__data</b> section</font></td></tr>

<tr valign=top>

<td width=124></td>

<td nowrap><font face="Times"><b>-r</b></font></td>

<td><font face="Times">Print the relocation entries</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">Complete documentation for the <b>otool</b> command is contained in a UNIX manual page, which you can access through the Digital Librarian.</font>

<p><font face="Times">Additional information related to the Mach-O file format is contained in section 1 (commands), section 3 (subroutines), and section 5 (file formats and conventions) of the UNIX manual pages.&nbsp; You can use the following list and the Digital Librarian to find the documentation you need:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=124></td>

<td nowrap><font face="Times"><b>atom</b>(1)</font></td>

<td><font face="Times">Converts an object file from <b>a.out</b> to Mach-O format</font></td></tr>

<tr valign=top>

<td width=124></td>

<td nowrap><font face="Times"><b>gdb</b>(1)</font></td>

<td><font face="Times">Debugs using the GNU debugger</font></td></tr>

<tr valign=top>

<td width=124></td>

<td nowrap><font face="Times"><b>ld</b>(1)</font></td>

<td><font face="Times">Links using the link editor</font></td></tr>

<tr valign=top>

<td width=124></td>

<td nowrap><font face="Times"><b>nm</b>(1)</font></td>

<td><font face="Times">Prints a symbol table</font></td></tr>

<tr valign=top>

<td width=124></td>

<td nowrap><font face="Times"><b>otool</b>(1)</font></td>

<td><font face="Times">Prints parts of an object file or library</font></td></tr>

<tr valign=top>

<td width=124></td>

<td nowrap><font face="Times"><b>size</b>(1)</font></td>

<td><font face="Times">Prints the size of an object file</font></td></tr>

<tr valign=top>

<td width=124></td>

<td nowrap><font face="Times"><b>strip</b>(1)</font></td>

<td><font face="Times">Removes symbols and relocation bits</font></td></tr>

<tr valign=top>

<td width=124></td>

<td nowrap><font face="Times"><b>getmachheaders</b>(3)</font></td>

<td><font face="Times">Gets the Mach headers for an executable</font></td></tr>

<tr valign=top>

<td width=124></td>

<td nowrap><font face="Times"><b>getsectbyname</b>(3)</font></td>

<td><font face="Times">Gets the section information for a section</font></td></tr>

<tr valign=top>

<td width=124></td>

<td nowrap><font face="Times"><b>getsegbyname</b>(3)</font></td>

<td><font face="Times">Gets the segment command for a segment</font></td></tr>

<tr valign=top>

<td width=124></td>

<td nowrap><font face="Times"><b>nlist</b>(3)</font></td>

<td><font face="Times">Gets entries from a name list</font></td></tr>

<tr valign=top>

<td width=124></td>

<td nowrap><font face="Times"><b>Mach-O</b>(5)</font></td>

<td><font face="Times">Describes Mach-O assembler and link editor output</font></td></tr>

<tr valign=top>

<td width=124></td>

<td nowrap><font face="Times"><b>stab</b>(5)</font></td>

<td><font face="Times">Describes symbol table types</font></td></tr>

</table>



<p>

</body>
</html>
