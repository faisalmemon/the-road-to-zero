<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<!-- Created with LatinByrd III -->
<!-- File: /Apps/NextDev/OperatingSystem/Part1_Mach/02_Messages/Messages.rtf -->
<!-- Date: Sun Jun 28 20:09:21 1998 -->
<head>
<title>Messages</title>
</head>

<body bgcolor="#FFFFFF" text="#000000" link="#0000FF" alink="#FF00FF" vlink="#FF0000">

<basefont size=3>

<p><font face="Times" size="-1">Copyright</font> <font size="-1">&copy;</font><font face="Times" size="-1">1995 by NeXT Computer, Inc.&nbsp; All Rights Reserved.</font>

<p><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=6></td>

<td><font face="Helvetica" size="+3" color="#FF00FF"><b>2</b></font></td></tr>

</table>

<p><br><br>

<p><font face="Times" size="+3"><i>Using Mach Messages</i></font>

<p><br><br><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">This chapter describes how to use Mach messages for interprocess communication (IPC).&nbsp; Programs can either send and receive Mach messages directly, or they can use remote procedure calls (RPCs) generated by MiG (Mach Interface Generator).&nbsp; MiG-generated RPCs appear to be simple function calls but actually involve messages.&nbsp; Many kernel functions, such as <b>host_info()</b>, are really RPCs.</font>

<p><font face="Times">This chapter first describes the structure of all messages.&nbsp; It then discusses how to set up messages for direct sending.&nbsp; Finally, it discusses how to use MiG to build a <i>Mach server</i>--a program that provides services to clients by using remote procedure calls.&nbsp; This chapter assumes that you understand the concepts of ports, port sets, and messages, which are described in Chapter 1, &quot;Mach Concepts.&quot;</font>

<p><font face="Times">You should usually use MiG to generate messages.&nbsp; MiG-generated code is easier for clients to use, and using MiG is a good way to define an interface that's separate from the implementation.&nbsp; However, you might want to build messages by hand if the messages are very simple or if you want fine control over communication details.</font>

<p><font face="Helvetica"><b>Note:</b></font>&nbsp; <font face="Times">Tasks can also communicate with each other using Distributed Objects.&nbsp; See the <i>NeXTSTEP General Reference</i> for information on Distributed Objects.</font></td></tr>

</table>

<p><br><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=6></td>

<td><font face="Helvetica" size="+2"><b>Message Structure</b></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">A message consists of a fixed header often followed by the message body.&nbsp; The body consists of alternating type descriptors and data items.&nbsp; Here's a typical message structure:</font></td></tr>

</table>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">typedef struct {</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">msg_header_t Head;</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">msg_type_t&nbsp;&nbsp; aType;</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; a;</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">msg_type_t&nbsp;&nbsp; bType;</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; b;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">} Request;</font>

<p><br><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Helvetica" size="+1"><b>Message Header</b></font>

<p><font face="Times">The C type definition for the message header is as follows (from the header file <b>mach/message.h</b>):</font></td></tr>

</table>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">typedef struct {</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">unsigned int msg_unused : 24,</font><br>
<img src="../../../Images/sp.gif" width=271 height=1><font face="Courier" size="-1">msg_simple : 8;</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">unsigned int msg_size;</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; msg_type;</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">port_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; msg_local_port;</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">port_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; msg_remote_port;</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; msg_id;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">} msg_header_t;</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The <b>msg_simple</b> field indicates whether the message is <i>simple</i> or <i>nonsimple</i>; the message is simple if its body contains neither ports nor out-of-line data (pointers).</font>

<p><font face="Times">The <b>msg_size</b> field specifies the size of the message to be sent, or the maximum size of the message that can be received. When a message is received, Mach sets <b>msg_size</b> to the size of the received message.&nbsp; The size includes the header and in-line data and is given in bytes.</font>

<p><font face="Times">The <b>msg_type</b> field specifies the general type of the message.&nbsp; For hand-built messages, it's MSG_TYPE_NORMAL; MiG-generated servers use the type MSG_TYPE_RPC.&nbsp; Other values for the <b>msg_type</b> field are defined in the header files <b>mach/message.h</b> and <b>mach/msg_type.h</b>.</font>

<p><font face="Times">The <b>msg_local_port</b> and <b>msg_remote_port</b> fields name the ports on which a message is to be received or sent.&nbsp; Before a message is sent, <b>msg_local_port</b> must be set to the port to which a reply, if any, should be sent; <b>msg_remote_port</b> must specify the port to which the message is being sent.&nbsp; Before a message is received, <b>msg_local_port</b> must be set to the port or port set to receive on.&nbsp; When a message is received, Mach sets <b>msg_local_port</b> to the port the message is received on, and <b>msg_remote_port</b> to the port any reply should be sent to (the sender's <b>msg_local_port</b>).</font>

<p><font face="Times">The <b>msg_id</b> field can be used to identify the meaning of the message to the intended recipient.&nbsp; For example, a program that can send two kinds of messages should set the <b>msg_id</b> field to indicate to the receiver which kind of message is being sent.&nbsp; MiG automatically generates values for the <b>msg_id</b> field.</font>

<p><br><br><br>

<p><font face="Helvetica" size="+1"><b>Message Body</b></font>

<p><font face="Times">The body of a message consists of an array of type descriptors and data.&nbsp; Each type descriptor contains the following structure:</font></td></tr>

</table>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">typedef struct&nbsp; {</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">unsigned int</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">msg_type_name : MSG_TYPE_BYTE, /* Type of data */</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">msg_type_size : 8,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* Number of bits per item */</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">msg_type_number : 12,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* Number of items */</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">msg_type_inline : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* If true, data follows; else</font><br>
<img src="../../../Images/sp.gif" width=418 height=1><font face="Courier" size="-1">a ptr to data follows */</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">msg_type_longform : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* Name, size, number follow */</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">msg_type_deallocate : 1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* Deallocate port rights or</font><br>
<img src="../../../Images/sp.gif" width=418 height=1><font face="Courier" size="-1">memory */</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">msg_type_unused : 1;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">} msg_type_t;</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The <b>msg_type_name</b> field describes the basic type of data comprising this object.&nbsp; The system-defined data types include:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">Ports, including combinations of send and receive rights.</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">Port and port set names.&nbsp; This is the same language data type as port rights, but the message only carries a task's name for a port and doesn't cause any transferral of rights.</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">Simple data types, such as integers, characters, and floating-point values.</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The <b>msg_type_size</b> field indicates the size in bits of the basic object named in the <b>msg_type_name</b> field.</font>

<p><font face="Times">The <b>msg_type_number</b> field indicates the number of items of the basic data type present after the type descriptor.</font>

<p><font face="Times">The <b>msg_type_inline</b> field indicates that the actual data is included after the type descriptor; otherwise, the word following the descriptor is a pointer to the data to be sent.</font>

<p><font face="Times">The <b>msg_type_longform</b> field indicates that the name, size, and number fields were too long to fit into the <b>msg_type_t </b>structure.&nbsp; These fields instead follow the <b>msg_type_t</b> structure, and the type descriptor consists of a <b>msg_type_long_t</b>:</font></td></tr>

</table>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">typedef struct {</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">msg_type_t&nbsp; msg_type_header;</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">short&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; msg_type_long_name;</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">short&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; msg_type_long_size;</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; msg_type_long_number;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">} msg_type_long_t;</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">When <b>msg_type_deallocate</b> is nonzero, it indicates that Mach should deallocate this data item from the sender's address space after the message is queued.&nbsp; You can deallocate only port rights or out-of-line data.</font>

<p><font face="Times">A data item, an array of data items, or a pointer to data follows each type descriptor.</font></td></tr>

</table>

<p><br><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=6></td>

<td><font face="Helvetica" size="+2"><b>Creating Messages by Hand</b></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">This section shows how to create messages to be sent using <b>msg_send()</b> or <b>msg_rpc()</b>.&nbsp; You don't usually have to set up messages by hand.&nbsp; For example, although Mach servers call <b>msg_send()</b>, almost all the message fields are already set up in MiG-generated code.&nbsp; However, this section might be useful if you want to send messages without using MiG, or if you want to read through MiG-generated code.</font>

<p><br><br><br>

<p><font face="Helvetica" size="+1"><b>Setting Up a Simple Message</b></font>

<p><font face="Times">As described earlier, a message is <i>simple</i> if its body doesn't contain any ports or out-of-line data (pointers).&nbsp; The <b>msg_remote_port</b> field must contain the port the message is to be sent to.&nbsp; The <b>msg_local_port</b> field should be set to the port a reply message (if any) is expected on.</font>

<p><font face="Times">The following example shows the creation of a simple message.&nbsp; Because every item in the body of the message is of the same type (<b>int</b>), only one type descriptor is necessary, even though the items are in two different fields.</font></td></tr>

</table>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define BEGIN_MSG 0 /* Constants to identify the different messages */</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define END_MSG 1</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define REPLY_MSG 2</font>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define MAXDATA 3</font>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">struct simp_msg_struct {</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">msg_header_t&nbsp; h;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* message header */</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">msg_type_t&nbsp;&nbsp;&nbsp; t;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* type descriptor */</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inline_data1;&nbsp;&nbsp;&nbsp; /* start of data array */</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inline_data2[2];</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">};</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">struct simp_msg_struct&nbsp; msg_xmt;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">port_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; comm_port, reply_port;</font>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">/* Fill in the message header. */</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.h.msg_simple = TRUE;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.h.msg_size = sizeof(struct simp_msg_struct);</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.h.msg_type = MSG_TYPE_NORMAL;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.h.msg_local_port = reply_port;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.h.msg_remote_port = comm_port;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.h.msg_id = BEGIN_MSG;</font>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">/* Fill in the type descriptor. */</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.t.msg_type_name = MSG_TYPE_INTEGER_32;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.t.msg_type_size = 32;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.t.msg_type_number = MAXDATA;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.t.msg_type_inline = TRUE;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.t.msg_type_longform = FALSE;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.t.msg_type_deallocate = FALSE;</font>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">/* Fill in the array of data items. */</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.inline_data1 = value1;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.inline_data2[1] = value2;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.inline_data2[2] = value3;</font>

<p><br><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Helvetica" size="+1"><b>Setting Up a Nonsimple Message</b></font>

<p><font face="Times">A message is <i>nonsimple</i> if its body contains ports or out-of-line data.&nbsp; The most common reason for sending data out-of-line is that the data block is very large or of variable size.</font>

<p><font face="Times"><i>In-line data</i> is copied by the sender into the message structure and then often copied out of the message by the receiver. <i>Out-of-line data</i>, however, is mapped by the kernel from the address space of the sender to the address space of the receiver. No actual copying of out-of-line data is done unless one of the two tasks subsequently modifies the data.</font>

<p><font face="Times">This example shows how to construct a message containing out-of-line data:</font></td></tr>

</table>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define BEGIN_MSG 0 /* Constants to identify the different messages */</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define END_MSG 1</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define REPLY_MSG 2</font>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define MAXDATA 3</font>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">struct ool_msg_struct {</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">msg_header_t&nbsp; h;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* message header */</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">msg_type_t&nbsp;&nbsp;&nbsp; t;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* type descriptor */</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *out_of_line_data; /* address of data */</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">};</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">struct ool_msg_struct&nbsp;&nbsp; msg_xmt;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">port_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; comm_port, reply_port;</font>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">/* Fill in the message header. */</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.h.msg_simple = FALSE;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.h.msg_size = sizeof(struct ool_msg_struct);</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.h.msg_type = MSG_TYPE_NORMAL;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.h.msg_local_port = reply_port;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.h.msg_remote_port = comm_port;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.h.msg_id = BEGIN_MSG;</font>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">/* Fill in the type descriptor. */</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.t.msg_type_name = MSG_TYPE_INTEGER_32;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.t.msg_type_size = 32;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.t.msg_type_number = MAXDATA;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.t.msg_type_inline = FALSE;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.t.msg_type_longform = FALSE;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.t.msg_type_deallocate = FALSE;</font>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">/* Fill in the out-of-line data. */</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.out_of_line_data = (int *)&amp;mydata;</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The fields that change values from those in the simple message example are <b>msg_simple</b>, <b>msg_type_inline</b>, and possibly <b>msg_type_deallocate</b>.&nbsp; The <b>msg_type_name</b>, <b>msg_type_size</b>, and <b>msg_type_number</b> fields remain the same as before, so that Mach can determine how much memory to map.</font>

<p><font face="Times">The <b>msg_remote_port</b> field must contain the port the message is to be sent to.&nbsp; The <b>msg_local_port</b> field should be set to the port where a reply message (if any) is expected.</font>

<p><br><br><br>

<p><font face="Helvetica" size="+1"><b>Setting Up a Reply Message</b></font>

<p><font face="Times">Once a message has been received, a reply message may have to be sent to the sender of the received message.&nbsp; In the following example, the reply message, <b>msg_xmt</b>, is simply a <b>msg_header_t</b> since no data is required.&nbsp; The <b>msg_remote_port </b>field, which designates where to send the message, must be set to the remote port of the previously received message (which Mach set to the previous sender's <b>msg_local_port</b> field).&nbsp; The <b>msg_local_port</b> field of the outgoing message is set to PORT_NULL because no reply to this message is expected.</font></td></tr>

</table>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define BEGIN_MSG 0 /* Constants to identify the different messages */</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define END_MSG 1</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define REPLY_MSG 2</font>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">struct simp_msg_struct {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* format of received message */</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">msg_header_t&nbsp; h;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* message header */</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">msg_type_t&nbsp;&nbsp;&nbsp; t;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* type descriptor */</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inline_data1;&nbsp;&nbsp;&nbsp; /* start of data array */</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; inline_data2[2];</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">};</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_header_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; msg_xmt;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">struct simp_msg_struct&nbsp; *msg_rcv;</font>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.h.msg_remote_port = msg_rcv-&gt;h.msg_remote_port;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.h.msg_local_port = PORT_NULL;&nbsp; /* no reply expected */</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.h.msg_id = REPLY_MSG;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.h.msg_size = sizeof(msg_header_t);</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.h.msg_type = MSG_TYPE_NORMAL;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">msg_xmt.h.msg_simple = TRUE;</font>

<p><br><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=6></td>

<td><font face="Helvetica" size="+2"><b>Mach Interface Generator</b></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The Mach Interface Generator (known as MiG) is a program that generates remote procedure call (RPC) code for communication between a client and a server process.&nbsp; The operations of sending a message and receiving a reply are represented as a single remote procedure call.</font>

<p><font face="Times">For example, if a program makes a call to <b>host_info()</b>, it actually calls a library routine that sends a message to the Mach kernel and then waits to receive a reply message.&nbsp; After the Mach kernel sends a reply message containing the information, the library routine takes the data out of the reply message and returns it to the program in parameters to the <b>host_info()</b> call.&nbsp; However, the program sees none of this complexity--it merely makes the following function call:</font></td></tr>

</table>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">ret = host_info(host_self(), HOST_SCHED_INFO,</font><br>
<img src="../../../Images/sp.gif" width=236 height=1><font face="Courier" size="-1">(host_info_t)&amp;sched_info, &amp;sched_count);</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">A Mach server executes as a separate task and communicates with its clients by sending Mach messages.&nbsp; As you can see from the previous sections in this chapter, Mach messages are fairly complex.&nbsp; The MiG program is designed to automatically generate procedures in C to pack and send, or receive and unpack the messages used to communicate between processes.</font>

<p><font face="Times">Because of the complexity of sending and decoding messages, Mach remote procedure calls are an order of magnitude slower than real function calls, even if the server is on the local machine.&nbsp; Calls to servers on remote machines take longer.&nbsp; However, Mach RPC has the advantages of the separation of interface and implementation, and of network transparency.</font>

<p><font face="Times">Using MiG, you can create RPC interfaces for sending messages between tasks on the local machine, or between tasks on separate machines in a network.&nbsp; In the network environment, MiG both encodes messages to be transmitted and decodes them upon arrival at the destination node, taking into account dissimilarities in machine architecture.</font>

<p><font face="Times">MiG is especially useful if you're faced with a mixed network environment.&nbsp; Without MiG, you're responsible for providing routines to translate messages between two machines with different data representations.&nbsp; Using MiG, you need only specify the calling arguments of the procedure and the procedure's return variables.&nbsp; The low-level routines required to translate messages between these machines are then generated automatically.</font>

<p><font face="Times">MiG is flexible enough to describe most data structures that might be sent as messages between processes.&nbsp; MiG supports the data types boolean, character, signed and unsigned integers, integer subranges, strings, reals, and communication port types. MiG also supports the limited creation of new data types through the use of enumerations, fixed-size and variable-size arrays, records, pointers to these types, and unions.</font>

<p><br><br><br>

<p><font face="Helvetica" size="+1"><b>Creating Mach Servers with MiG</b></font>

<p><font face="Times">To create a Mach server, you must provide a specification file defining parameters of both the message-passing interface and the procedure-call interface.&nbsp; MiG then generates three files from the specification file:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">User interface file (<i>xxx</i><b>User.c</b>, where <i>xxx</i> is the subsystem name)--Should be compiled and linked into the client program. It implements and exports the procedures and functions for sending and receiving the appropriate messages to and from the server.</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">User header file (<i>xxx</i><b>.h</b>)--Defines the functions to be called by a client of the server.&nbsp; It's included in the user interface file (<i>xxx</i><b>User.c</b>) and defines the types and routines needed at compilation time.</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">Server interface file (<i>xxx</i><b>Server.c</b>)--Should be compiled and linked into the server process.&nbsp; It extracts the input parameters from an IPC message, and calls a server procedure to perform the operation.&nbsp; When the server procedure or function returns, the Server interface also gathers the output parameters and formats a reply message.</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">Besides the specification file, you must write at least two functions for the Mach server.&nbsp; One is the main routine of the server, which registers the server and then goes into a loop that receives a message, calls the MiG-generated code to process the request, and sends a reply message.&nbsp; You must also write one function for each remote procedure call, so that the MiG-generated server code can call the appropriate function for each request.</font>

<p><font face="Times">In addition, you should provide a library routine that clients can use to look up your server.&nbsp; For example, the kernel-server loader has a routine called <b>kern_loader_look_up()</b> that clients call to obtain the kernel-server loader's port.&nbsp; This port must be specified as the first argument in every RPC to the kernel-server loader.</font>

<p><font face="Times">You can register your server with either the Network Name Server or the Bootstrap Server, depending on whether you want your server to be available to other machines on a network.&nbsp; The Bootstrap Server allows only processes that are on the local machine (or a subset of local processes) to get your server's port.&nbsp; For example, the sound driver registers its port with the Bootstrap Server so that only processes descended from the local machine's Login Window can control sound.&nbsp; The Network Name Server allows tasks on remote machines to get the server's port.&nbsp; See Chapter 4, &quot;Mach Functions,&quot; for more information on Network Name Server and Bootstrap Server functions.</font>

<p><br><br><br>

<p><font face="Helvetica" size="+1"><b>Client's View</b></font>

<p><font face="Times">This section describes how clients use servers, so that you can better create and document your own server.</font>

<p><font face="Times">Before a client can make remote procedure calls to the server, it must find the server's port.&nbsp; If the server doesn't provide a library function to do this lookup, then the client must call either <b>netname_look_up()</b> or <b>bootstrap_look_up()</b> and supply the name of the server.</font>

<p><font face="Times">When a client makes a remote procedure call, it appears to be a simple function call.&nbsp; The return type depends on whether the RPC is defined in the server's MiG specification file to be a routine, procedure, or function (as described later in this chapter).</font>

<p><font face="Times">The most convenient interfaces are to routines, which return a value of type <b>kern_return_t</b>.&nbsp; The returned value is either KERN_SUCCESS or a MiG, Mach, or server-specific error code.&nbsp; MiG and Mach error codes can be interpreted by <b>mach_error()</b> and <b>mach_error_string()</b>.</font>

<p><font face="Times">Procedure and function RPCs are less convenient than routines because they don't directly return error codes.&nbsp; Instead, the client must provide an error-handling routine named either <b>MsgError()</b> or whatever name the server developer specified in the server's MiG specification file.&nbsp; The error-handling routine must be defined as follows:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=125></td>

<td><font face="Times">void <i>error_proc</i><b>(</b>kern_return_t <i>error_code</i><b>)</b></font></td></tr>

</table>

<p><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Helvetica" size="+1"><b>Common Error Codes</b></font>

<p><font face="Times">The most common system error that an RPC returns to a client is an invalid port.&nbsp; This can mean several things:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">The request port (usually the first parameter in the RPC) is an invalid port, or the client doesn't have send rights for it.</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">The reply port is invalid or lacks receive rights.&nbsp; (This problem can't occur unless the client provides the reply port; usually the system provides it.)</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">Another port that the client is passing in the message is invalid.</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">A port that's being passed back to the client is invalid.</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">Another system error a client might receive is a timeout.&nbsp; This can happen only if a timeout is specified in an argument or in the server's specification file, and usually doesn't happen unless the server is on a different machine from the client.</font>

<p><font face="Times">MiG errors, which are defined in the header file <b>mach/mig_errors.h</b>, usually occur only if the client is using a different version of the interface than the server.</font>

<p><br><br>

<p><font face="Helvetica" size="+1"><b>Out-of-Line Data</b></font>

<p><font face="Times">When making specific interface calls, the client should be aware if any out-of-line data is being returned to it.&nbsp; If so, it might want to deallocate the space with a call to <b>vm_deallocate()</b>.</font>

<p><br><br>

<p><font face="Helvetica" size="+1"><b>Compiling the Client</b></font>

<p><font face="Times">The client must be compiled and linked with the <i>xxx</i><b>User.c</b> and <i>xxx</i><b>.h</b> files that MiG produced from the server's specification file.&nbsp; The client should also include or be linked with any files that are necessary to communicate with the server (such as the file containing the routine that looks up the server).&nbsp; For example, clients of the kernel-server loader must be linked against the kernload library, which supplies all non-RPC kernel-server loader functions.</font>

<p><br><br><br>

<p><font face="Helvetica" size="+1"><b>Programming Example</b></font>

<p><font face="Times">This example shows the implementation of a simple server that adds two or three integers and returns the answer.&nbsp; The files used to produce this server and a sample client program are under the <b>MiG</b> directory of <b>/NextLibrary/Documentation/NextDev/Examples</b>.</font>

<p><font face="Times">The user-written files required for the server are the following:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">MiG specification file (<b>Server/add.defs</b>)</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">Type definition file, which is included by both the server and the client (<b>Library/add_types.h</b>)</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">Implementation file, which contains the server's main loop and the function that does the addition (<b>Server/add_server_main.c</b>)</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">Once the server has been generated, any client programs need to have the following files:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">MiG-generated user interface file, in a form that can be compiled or linked into the client program (<b>Library/addUser.o</b>)</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">MiG-generated user header file (<b>Library/add.h</b>)</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">Type definition file (<b>Library/add_types.h</b>)</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">One or more files containing the main parts of the client program (<b>Client/add.c</b>)</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">In the following example, a simple MiG specification file called <b>add.defs</b> is shown.&nbsp; It declares the remote routines <b>add2nums() </b>and <b>add3nums()</b>, which take as arguments the request port (the default first argument to every MiG operation), two or three integers, and a pointer to another integer.&nbsp; Because all types mentioned in <b>add.defs</b> are already defined in the included header file <b>mach/std_types.defs</b>, it isn't necessary to define any types directly in <b>add.defs</b>.</font></td></tr>

</table>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">/* add.defs:&nbsp; MiG definition file for add server */</font>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">subsystem add 0;</font>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">/* Get standard definitions of int and port_t. */</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#include &lt;mach/std_types.defs&gt;</font>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">routine add2nums(server: port_t; a:int; b:int; out c:int);</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">routine add3nums(server: port_t; a:int; b:int; c:int; out d:int);</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The header file <b>mach/std_types.defs</b> defines <b>int</b> and <b>port_t</b> as the following:</font></td></tr>

</table>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">type int = MSG_TYPE_INTEGER_32;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">type port_t = MSG_TYPE_PORT;</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The header file <b>add_types.h</b> contains definitions needed by both the client and the server:</font></td></tr>

</table>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">/* add_types.h:&nbsp; Definitions for add server */</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#import &lt;mach/mach.h&gt;</font>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#define ADD_SERVER_NAME &#34;Addition-Server&#34;</font>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">extern port_t add_look_up(void);</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The code that does the work for the server is in the file <b>add_server_main.c</b>.&nbsp; It contains a main loop and the functions that perform the addition.&nbsp; The main loop dynamically allocates the memory needed for incoming and outgoing messages, using the <b>addMaxRequestSize</b> and <b>addMaxReplySize</b> constants generated by MiG.</font></td></tr>

</table>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">/* add_server_main.c:&nbsp; Main loop and implementation of add server */</font>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#import &lt;mach/mach.h&gt;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#import &lt;mach/message.h&gt;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#import &lt;servers/netname.h&gt;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#import &lt;mach/mach_error.h&gt;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#import &lt;ansi/stdlib.h&gt;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#import &#34;../Library/add_types.h&#34;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#import &#34;addServer.h&#34;</font>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">void&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; server_loop(port_t port);</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">/* defined by MiG: */</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">boolean_t&nbsp;&nbsp;&nbsp; add_server(msg_header_t *in, msg_header_t *out);</font>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">void main(int argc, char *argv[])</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">{</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">port_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; server_port;</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">kern_return_t r;</font>

<p><img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">/* Register with the Network Name Server. */</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">r = port_allocate(task_self(), &amp;server_port);</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">if (r != KERN_SUCCESS) {</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">mach_error(&#34;port_allocate failed&#34;, r);</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">exit(1);</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">}</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">r = netname_check_in(name_server_port, ADD_SERVER_NAME,</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">PORT_NULL, server_port);</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">if (r != KERN_SUCCESS) {</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">mach_error(&#34;netname_check_in failed&#34;, r);</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">exit(1);</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">}</font>

<p><img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">/* Enter our main loop. */</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">server_loop(server_port);</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">}</font>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">void server_loop(port_t port)</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">{</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">kern_return_t ret;</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">msg_header_t *msg = (msg_header_t *)malloc(addMaxRequestSize);</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">msg_header_t *reply = (msg_header_t *)malloc(addMaxReplySize);</font>

<p><img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">while (TRUE)</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">{</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">/* Receive a request from a client. */</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">msg-&gt;msg_local_port = port;</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">msg-&gt;msg_size = addMaxRequestSize;</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">ret = msg_receive(msg, MSG_OPTION_NONE, 0);</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">if (ret != RCV_SUCCESS) /* ignore errors */;</font>

<p><img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">/* Feed the request into the server. */</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">(void)add_server(msg, reply);</font>

<p><img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">/* Send a reply to the client. */</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">reply-&gt;msg_local_port = port;</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">ret = msg_send(reply, MSG_OPTION_NONE, 0);</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">if (ret != SEND_SUCCESS) /* ignore errors */;</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">}</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">}</font>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">/*</font><br>
<img src="../../../Images/sp.gif" width=131 height=1><font face="Courier" size="-1">* This function is called by add_server, which was created by MiG.</font><br>
<img src="../../../Images/sp.gif" width=131 height=1><font face="Courier" size="-1">* It is NOT directly called by any client process.</font><br>
<img src="../../../Images/sp.gif" width=131 height=1><font face="Courier" size="-1">*/</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">kern_return_t add2nums(port_t server, int n1, int n2, int *n3)</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">{</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">*n3 = n1+n2;</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">return KERN_SUCCESS;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">}</font>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">/*</font><br>
<img src="../../../Images/sp.gif" width=131 height=1><font face="Courier" size="-1">* This function is called by add_server, which was created by MiG.</font><br>
<img src="../../../Images/sp.gif" width=131 height=1><font face="Courier" size="-1">* It is NOT directly called by any client process.</font><br>
<img src="../../../Images/sp.gif" width=131 height=1><font face="Courier" size="-1">*/</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">kern_return_t add3nums(port_t server, int n1, int n2, int n3, int *n4)</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">{</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">*n4 = n1+n2+n3;</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">return KERN_SUCCESS;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">}</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">In general, your message receive loop should return a reply for every message it receives unless the reply message returned from the MiG-generated server has MIG_NO_REPLY in its <b>RetCode</b> field.&nbsp; MIG_NO_REPLY is used only when the received message was part of an RPC that never expects a return message (a <b>simpleprocedure</b> or <b>simplefunction</b>, both of which are defined later in this chapter).&nbsp; For example:</font></td></tr>

</table>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">(void)add_server(msg, reply);</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">ret_code = reply.RetCode;</font>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">if (ret_code == MIG_NO_REPLY)</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">ret_code = KERN_SUCCESS;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">else</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">ret_code = msg_send(reply, MSG_OPTION_NONE, 0);</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">Finally, a typical client process, such as <b>Client/add.c</b>, makes the RPC as follows:</font></td></tr>

</table>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">. . .</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#import &#34;../Library/add_types.h&#34;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#import &#34;../Library/add.h&#34;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; n1, n2, n3, result;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">kern_return_t ret;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">port_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; server;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">. . .</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">/* Find the server. */</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">server = add_look_up();</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">if (server == PORT_NULL)</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">{</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">fprintf(stderr, &#34;Couldn't find the add server.\n&#34;);</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">exit(2);</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">}</font>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">/* Send a message to the server. */</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">if (argc == 3) {&nbsp; /* 2 numbers to add */</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">ret = add2nums(server, n1, n2, &amp;result);</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">if (ret != KERN_SUCCESS)</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">printf(&#34;Call to add2nums failed.\n&#34;);</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">else</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">printf(&#34;According to the server, %d + %d = %d.\n&#34;, n1, n2,</font><br>
<img src="../../../Images/sp.gif" width=208 height=1><font face="Courier" size="-1">result);</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">} else {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* 3 numbers to add */</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">ret = add3nums(server, n1, n2, n3, &amp;result);</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">if (ret != KERN_SUCCESS)</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">printf(&#34;Call to add3nums failed.\n&#34;);</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">else</font><br>
<img src="../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">printf(&#34;According to the server, %d + %d + %d= %d.\n&#34;, n1,</font><br>
<img src="../../../Images/sp.gif" width=208 height=1><font face="Courier" size="-1">n2, n3, result);</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">}</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">Note that although the RPC looks like it directly calls <b>add2nums()</b> and <b>add3nums()</b> in the server, it really doesn't.&nbsp; The client instead sends a message that's received in <b>server_loop()</b>, which calls <b>add_server()</b>.&nbsp; The <b>add_server()</b> function calls <b>add2nums()</b> or <b>add3nums()</b> and passes the result back to the client in a message.</font>

<p><font face="Times">Making a function such as <b>add2nums()</b> an RPC gives the advantages of network independence, interface independence, and automatic type checking, at the expense of some complexity in the server.</font>

<p><br><br><br>

<p><font face="Helvetica" size="+1"><b>MiG Specification File</b></font>

<p><font face="Times">You must first write a MiG specification file to specify the details of the procedure arguments and the messages to be used.&nbsp; A MiG specification file contains the following components, some of which may be omitted:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">Subsystem identification</font></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">Type declarations</font></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">Import declarations</font></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">Operation descriptions</font></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">Options declarations</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The subsystem identification should appear first for clarity.&nbsp; Types must be declared before they're used.&nbsp; Code is generated for the operations and import declarations in the order in which they appear in the specification files.&nbsp; Options affect the operations that follow them.</font>

<p><font face="Times">See the earlier section, &quot;Programming Example,&quot; for a complete subsystem definition.</font>

<p><br><br>

<p><font face="Helvetica" size="+1"><b>Subsystem Identification</b></font>

<p><font face="Times">The subsystem identification statement has the following form:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=125></td>

<td><font face="Times"><b>subsystem</b> <i>sys message_base_id</i> ;</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The <i>sys</i> is the name of the subsystem.&nbsp; It's used as the prefix for all generated file names.&nbsp; The user file name will be <i>sys</i><b>User.c</b>, the user header file will be <i>sys</i><b>.h</b>, and the server file will be <i>sys</i><b>Server.c</b>.</font>

<p><font face="Times">The <i>message_base_id</i> is a decimal integer that's used as the IPC message ID of the first operation in the specification file. Operations are numbered sequentially beginning with this base.&nbsp; The MiG-generated server function checks the message ID of an incoming message to make sure that it's no less than <i>message_base_id</i> and no greater than <i>message_base_id</i> + <i>num_messages</i></font> <img src="../../../Images/c2D.gif" width=8 height=4><font face="Times">1, where <i>num_messages</i> is the number of messages understood by the server.</font>

<p><font face="Times">Several servers can use just one message receive loop as long as they have different subsystem numbers (and they have few enough messages so that message IDs don't overlap).&nbsp; The message receive loop should call each MiG-generated server function in turn until one of them returns true (indicating the message ID is in the range understood by that server.)&nbsp; Once a MiG-generated server function has returned true or all the servers have returned false, the receive-serve-send loop should send a reply (unless the reply message returned by the server function has MIG_NO_REPLY in its <b>RetCode</b> field).</font>

<p><font face="Times">Example:</font></td></tr>

</table>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">subsystem random 500;</font>

<p><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Helvetica" size="+1"><b>Type Declarations</b></font>

<p><br><br>

<p><font face="Helvetica"><b>Simple Types</b></font>

<p><font face="Times">A simple type declaration has the following form:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=125></td>

<td><font face="Times"><b>type</b> <i>user_type_name</i> = <i>type_desc</i> [<i>translation_info</i>]</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">where a <i>type_desc</i> is either a previously defined <i>user_type_name</i> or an <i>ipc_type_desc,</i> which has one of the following forms:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=125></td>

<td><font face="Times"><i>ipc_type_name</i></font><br>
<font face="Times">(<i>ipc_type_name</i> [<i>, size</i> [, <b>dealloc</b> ]])</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The <i>user_type_name</i> is the name of a C type that will be used for some parameters of the calls exported by the user interface file.&nbsp; The <i>ipc_type_desc</i> of simple types are enclosed in parentheses and consist of an IPC type name, decimal integer, or integer expression that's the number of bits in the IPC type and, optionally, the <b>dealloc</b> keyword.</font>

<p><font face="Times">The standard system-defined IPC type names are:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=125></td>

<td><font face="Times">MSG_TYPE_BOOLEAN</font><br>
<font face="Times">MSG_TYPE_BIT</font><br>
<font face="Times">MSG_TYPE_BYTE</font><br>
<font face="Times">MSG_TYPE_CHAR</font><br>
<font face="Times">MSG_TYPE_INTEGER_8</font><br>
<font face="Times">MSG_TYPE_INTEGER_16</font><br>
<font face="Times">MSG_TYPE_INTEGER_32</font><br>
<font face="Times">MSG_TYPE_REAL</font><br>
<font face="Times">MSG_TYPE_STRING</font><br>
<font face="Times">MSG_TYPE_PORT</font><br>
<font face="Times">MSG_TYPE_PORT_ALL</font><br>
<font face="Times">MSG_TYPE_UNSTRUCTURED</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The current set of these type names is contained in the header file <b>mach/message.h</b>, which defines all the message-related types needed by a user of the Mach kernel.&nbsp; The programmer may define additional types.&nbsp; If the <i>ipc_type_name</i> is a system-defined one other than MSG_TYPE_STRING, MSG_TYPE_UNSTRUCTURED, or MSG_TYPE_REAL, <i>size</i> (the bit length) need not be specified and the parentheses can be omitted.</font>

<p><font face="Times">The <b>dealloc</b> keyword controls the treatment of ports and pointers after the messages they're associated with have been sent. The <b>dealloc</b> keyword causes the deallocation bit in the IPC message to be set on; otherwise, it's off.&nbsp; If <b>dealloc</b> is used with a port, the port is deallocated after the message is sent.&nbsp; If <b>dealloc</b> is used with a pointer, the memory that the pointer references will be deallocated after the message has been sent.&nbsp; An error results if <b>dealloc</b> is used with any argument other than a port or a pointer.</font>

<p><font face="Times">Some examples of simple type declarations are:</font></td></tr>

</table>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">type int = MSG_TYPE_INTEGER_32;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">type my_string = (MSG_TYPE_STRING,8*80);</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">type kern_return_t = int;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">type disposable_port = (MSG_TYPE_PORT_ALL,32,dealloc);</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The MiG-generated code assumes that the C types <b>my_string</b>, <b>kern_return_t</b>, and <b>disposable_port</b> are defined in a compatible way by a programmer-provided header file.&nbsp; The basic C and Mach types are defined in the header file <b>mach/std_types.defs</b>.</font>

<p><font face="Times">MiG assumes that any variable of type MSG_TYPE_STRING is declared as a C <b>char *</b> or <b>char</b> <i>array</i><b>[</b><i>n</i><b>]</b>.&nbsp; Thus it generates code for a parameter passed by reference and uses <b>strncpy()</b> for assignment statements.</font>

<p><font face="Times">Optional <i>translation_info</i> information describing procedures for translating or deallocating values of the type may appear after the type definition information:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">Translation functions, <b>intran</b> and <b>outtran</b>, allow the type as seen by the user process and the server process to be different.</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">Destructor functions allow the server code to automatically deallocate input types after they have been used.</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">For example:</font></td></tr>

</table>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">type task_t = (MSG_TYPE_PORT,32)</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">intran:&nbsp;&nbsp;&nbsp; i_task_t PortToTask(task_t)</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">outtran:&nbsp;&nbsp; task_t TaskToPort(i_task_t)</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">destructor: DeallocT(i_task_t)</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">;</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Helvetica"><b>Note:</b></font>&nbsp; <font face="Times">Because <i>translation_info</i> is part of the type declaration, the semicolon (<b>;</b>) doesn't appear until after the end of <i>translation_info</i>.</font>

<p><font face="Times">In this example, <b>task_t</b>, which is the type seen by the user code, is defined as a port in the message.&nbsp; The type seen by the server code is <b>i_task_t</b>, which is a data structure used by the server to store information about each task it's serving.&nbsp; The <b>intran </b>function <b>PortToTask()</b> translates values of type <b>task_t</b> to <b>i_task_t</b> on receipt by the server process.&nbsp; The <b>outtran</b> function <b>TaskToPort()</b> translates values of type <b>i_task_t</b> to type <b>task_t</b> before return.&nbsp; The destructor function <b>DeallocT()</b> is called on the translated input parameter, <b>i_task_type</b>, after the return from the server procedure and can be used to deallocate any or all parts of the internal variable.&nbsp; The destructor function won't be called if the parameter is also an <b>out</b> parameter (as described later in this chapter, in the section &quot;Operation Descriptions&quot;); this is because the correct time to deallocate an <b>out</b> parameter is after the reply message has been sent, which MiG doesn't do.&nbsp; A destructor function can also be used independently of the translation routines.&nbsp; For example, if a large out-of-line data segment is passed to the server, it could use a destructor function to deallocate the memory after the data was used.</font>

<p><font face="Times">Although calls to these functions are generated automatically by MiG, the function definitions must be hand-coded and imported using:</font></td></tr>

</table>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">i_task_t PortToTask(task_t x)</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">task_t TaskToPort(i_task_t y)</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">void DeallocT(i_task_t y)</font>

<p><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Helvetica"><b>Structured Types</b></font>

<p><font face="Times">Three kinds of structured types are recognized:&nbsp; arrays, structures, and pointers.&nbsp; Definitions of arrays and structures have the following syntax:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=125></td>

<td><font face="Times"><b>array</b> [<i>size</i>] <b>of</b> <i>comp_type_desc</i></font><br>
<font face="Times"><b>array</b> [ * : <i>maxsize</i>] <b>of</b> <i>comp_type_desc</i></font><br>
<font face="Times"><b>struct</b> [<i>size</i>] <b>of</b> <i>comp_type_desc</i></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">where <i>comp_type_desc</i> may be a simple <i>type_desc</i> or may be an <b>array</b> or <b>struct</b> type, and <i>size</i> may be a decimal integer constant or expression.&nbsp; The second array form specifies that a variable-length array is to be passed in-line in the message.&nbsp; In this form <i>maxsize</i> is the maximum length of the item.&nbsp; Currently, only one variable-length array may be passed per message.&nbsp; For variable-length arrays an additional count parameter is generated to specify how much of the array is actually being used.</font>

<p><font face="Times">If a type is declared as an <b>array</b>, the C type must also be an array, since the MiG RPC code will treat the user type as an array (that is, MiG will assume that the user type is passed by reference and it will generate special code for array assignments).&nbsp; A variable declared as a <b>struct</b> is assumed to be passed by value and treated as a C structure in assignment statements.&nbsp; There is no way to specify the fields of a C structure to MiG.&nbsp; The <i>size</i> and <i>type_desc</i> are used only to give the size of the structure.&nbsp; The following example shows how to declare a C structure as a <b>struct</b>.</font></td></tr>

</table>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">/* declaration in MiG .defs file */</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">type short = MSG_TYPE_INTEGER_16;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">type port_t = MSG_TYPE_PORT;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">type lock_struct = struct [9] of short;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">routine fl_message(server_port: port_t; inout arg: lock_struct);</font>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">/* declaration in C code */</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">typedef struct {</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">short l_type;</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">short l_whence;</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">long l_start;</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">long l_len;</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">short l_pid;</font><br>
<img src="../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">long l_hostid;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">} lock_struct;</font>

<p><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Helvetica"><b>Pointer Types</b></font>

<p><font face="Times">In the definition of pointer types, the symbol <b>^</b> precedes a simple, array, or structure definition.</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=125></td>

<td><font face="Times"><b>^</b> <i>comp_type_desc</i></font><br>
<font face="Times"><b>^ array</b> [<i>size</i>] <b>of</b> <i>comp_type_desc</i></font><br>
<font face="Times"><b>^ struct</b> [<i>size</i>] <b>of</b> <i>com_type_desc</i></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The <i>size</i> may be left blank or be <b>*</b>.&nbsp; In either case, the array or structure is of variable size, and a parameter is defined immediately following the array parameter to contain its size.&nbsp; Data types declared as pointers are sent out-of-line in the message.&nbsp; Since sending out-of-line data is considerably more expensive than sending in-line data, pointer types should be used only for large or variable amounts of data.&nbsp; A call that returns an out-of-line item allocates the necessary space in the user's virtual memory.&nbsp; It's up to the user to call <b>vm_deallocate()</b> on this memory when finished with the data.</font>

<p><font face="Times">Some examples of complex types are:</font></td></tr>

</table>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">type procids = array [10] of int;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">type procidinfo = struct [5*10] of (MSG_TYPE_INTEGER_32);</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">type vardata = array [ * : 1024 ] of int;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">type array_by_value = struct [1] of array [20] of (MSG_TYPE_CHAR);</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">type page_ptr = ^ array [4096] of (MSG_TYPE_INTEGER_32);</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">type var_array = ^ array [] of int;</font>

<p><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Helvetica" size="+1"><b>Import Declarations</b></font>

<p><font face="Times">If any of the <i>user_type_name</i>s or <i>server_type_name</i>s are other than the standard C types (such as <b>int</b> and <b>char</b>), C type specification files must be imported into the user interface and server interface files so that they'll compile.&nbsp; The import declarations specify files that are imported into the modules generated by MiG.</font>

<p><font face="Times">An import declaration has one of the following forms:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=125></td>

<td><font face="Times"><b>import</b> <i>file_name</i>;</font><br>
<font face="Times"><b>uimport</b> <i>file_name</i>;</font><br>
<font face="Times"><b>simport</b> <i>file_name</i>;</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">where <i>file_name</i> has the same form as file name specifications in <b>#include</b> statements (that is, <b>&lt;</b><i>file_name</i><b>&gt;</b> or <b>&#34;</b><i>file_name</i><b>&#34;</b>).</font>

<p><font face="Times">For example:</font></td></tr>

</table>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">import &#34;my_defs.h&#34;;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">import &#34;/usr/include/mach/cthreads.h&#34;;</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">import &lt;mach/cthreads.h&gt;;</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">Files included with <b>import</b> are included in both the user-side and server-side code.&nbsp; Those included with <b>uimport</b> are included in just the user side.&nbsp; Those included with <b>simport</b> are included in just the server side.</font>

<p><br><br>

<p><font face="Helvetica" size="+1"><b>Operation Descriptions</b></font>

<p><font face="Times">Any of five standard operations may be specified by using the following keywords:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=125></td>

<td><font face="Times"><b>function</b></font><br>
<font face="Times"><b>routine</b></font><br>
<font face="Times"><b>procedure</b></font><br>
<font face="Times"><b>simpleprocedure</b></font><br>
<font face="Times"><b>simpleroutine</b></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">One other keyword, <b>skip</b>, may be used in place of a standard operation.</font>

<p><font face="Times">Functions and routines have a return value; procedures don't.&nbsp; Routines are functions whose result is of type <b>kern_return_t</b>. This result indicates whether the requested operation was successfully completed.&nbsp; If a routine returns a value other than KERN_SUCCESS, the reply message won't include any of the reply parameters except the error code.&nbsp; Neither procedures nor functions return indications of errors directly; instead they call a hand-coded error function in the client.&nbsp; The name of the error function is <b>MsgError()</b>, by default; you can specify another name using the <b>error</b> declaration in the MiG specification file.</font>

<p><font face="Times">Simple procedures and simple routines send a message to the server but don't expect a reply.&nbsp; The return value of a simple routine is the value returned by the function <b>msg_send()</b>.&nbsp; Simple routines or simple procedures are used when asynchronous communication with a server is desired.&nbsp; The rest of the operations wait for a reply before returning to the caller.</font>

<p><font face="Times">The syntax of the <b>procedure</b>, <b>simpleprocedure</b>, <b>simpleroutine</b>, and <b>routine</b> statements are identical.&nbsp; The syntax of <b>function </b>is also the same except for the type name of the value of the function.&nbsp; The general syntax of an operation definition for everything except <b>function</b> has the following form:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=125></td>

<td><font face="Times"><i>operation_type operation_name</i> ( <i>parameter_list</i> ) ;</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">For <b>function</b> the form is:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=125></td>

<td><font face="Times"><b>function</b> <i>operation_name</i> ( <i>parameter_list</i> ) : <i>function_value_type</i> ;</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The <i>parameter_list</i> is a list of parameter names and types separated by a semicolon.&nbsp; The form of each parameter is:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=125></td>

<td><font face="Times">[ <i>specification</i> ] <i>var_name</i> : <i>type_description</i> [ , <b>dealloc</b> ]</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">If not omitted, <i>specification</i> must be one of the following:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=125></td>

<td><font face="Times"><b>in</b></font><br>
<font face="Times"><b>out</b></font><br>
<font face="Times"><b>inout</b></font><br>
<font face="Times"><b>requestport</b></font><br>
<font face="Times"><b>replyport</b></font><br>
<font face="Times"><b>waittime</b></font><br>
<font face="Times"><b>sendtime</b></font><br>
<font face="Times"><b>msgtype</b></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The <i>type_description</i> can be any <i>user_type_name</i> or a complete type description (see the earlier section in this chapter, &quot;Type Declarations&quot;).</font>

<p><font face="Times">The first unspecified parameter in any operation statement is assumed be the <b>requestport</b> unless a <b>requestport</b> parameter was already specified.&nbsp; This is the port that the message is to be sent to.&nbsp; If a <b>replyport</b> parameter is specified, it will be used as the port that the reply message is sent to.&nbsp; If no <b>replyport</b> parameter is specified, a per-thread global port is used for the reply message.</font>

<p><font face="Times">The keywords <b>in</b>, <b>out</b>, and <b>inout</b> are optional and indicate the direction of the parameter.&nbsp; The keyword <b>in</b> is used with parameters that are to be sent to the server.&nbsp; The keyword <b>out</b> is used with parameters to be returned by the server.&nbsp; The keyword <b>inout</b> is used with parameters to be both sent and returned.&nbsp; If no such keyword is given, the default is <b>in</b>.</font>

<p><font face="Times">The keywords <b>waittime</b>, <b>replyport</b>, and <b>msgtype</b> can be used to specify dynamic values for the wait time, the reply port, or the message type for this message.&nbsp; These parameters aren't passed to the server code, but are used when generating the send and receive calls.&nbsp; The <b>requestport</b> and <b>replyport</b> parameters must be of types that resolve to MSG_TYPE_PORT.&nbsp; The <b>waittime </b>and <b>msgtype</b> parameters must resolve to MSG_TYPE_INTEGER_32.</font>

<p><font face="Times">The keyword <b>skip</b> is provided to allow a procedure to be removed from a subsystem without causing all the subsequent message interfaces to be renumbered.&nbsp; It causes no code to be generated, but uses up a <b>msg_id</b> number.</font>

<p><font face="Times">Here are some examples:</font></td></tr>

</table>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">procedure init_seed (&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; server_port : port_t;</font><br>
<img src="../../../Images/sp.gif" width=320 height=1><font face="Courier" size="-1">seed&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : dbl);</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">routine get_random (&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; server_port : port_t;</font><br>
<img src="../../../Images/sp.gif" width=320 height=1><font face="Courier" size="-1">out num&nbsp;&nbsp;&nbsp;&nbsp; : int);</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">simpleroutine use_random (&nbsp; server_port : port_t;</font><br>
<img src="../../../Images/sp.gif" width=320 height=1><font face="Courier" size="-1">info_seed&nbsp;&nbsp; : string80;</font><br>
<img src="../../../Images/sp.gif" width=320 height=1><font face="Courier" size="-1">info&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : comp_arr;</font><br>
<img src="../../../Images/sp.gif" width=320 height=1><font face="Courier" size="-1">info_1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; : words);</font><br>
<img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">simpleprocedure exit (&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; server_port : port_t);</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">See the earlier section in this chapter, &quot;Programming Example,&quot; for an example of a complete subsystem definition.</font>

<p><br><br>

<p><font face="Helvetica" size="+1"><b>Options Declarations</b></font>

<p><font face="Times">Several special-purpose options about the generated code may be specified.&nbsp; Defaults are available for each, and simple interfaces don't usually need to change them.&nbsp; First-time readers may want to skip this section.&nbsp; These options may occur more than once in the specification file.&nbsp; Each time an option declaration appears, it sets that option for all the following operations.</font>

<p><br><br>

<p><font face="Helvetica"><b>The waittime Specification</b></font>

<p><font face="Times">The <b>waittime</b> specification has one of the following two forms:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=125></td>

<td><font face="Times"><b>waittime</b> <i>time</i> <b>;</b></font><br>
<font face="Times"><b>nowaittime ;</b></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The word <b>waittime</b> is followed by an integer or an identifier that specifies the maximum time in milliseconds that the user code will wait for a reply from the server.&nbsp; If an identifier is used, it should be declared as an <b>extern</b> variable by some module in the user code.&nbsp; If the <b>waittime</b> option is omitted, or if the <b>nowaittime</b> statement is seen, the RPC doesn't return until a message is received.</font>

<p><font face="Times">The timeout value for the <b>msg_receive()</b> can alternatively be controlled by using a <b>waittime</b> parameter to the RPC.</font>

<p><br><br>

<p><font face="Helvetica"><b>The sendtime Specification</b></font>

<p><font face="Times">The <b>sendtime</b> specification has one of the following two forms:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=125></td>

<td><font face="Times"><b>sendtime</b> <i>time</i> <b>;</b></font><br>
<font face="Times"><b>nosendtime ;</b></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The word <b>sendtime</b> is followed by an integer or an identifier that specifies the maximum time in milliseconds that the user code will wait for the number of messages queued on the server's port to fall below the port's backlog.&nbsp; If an identifier is used, it should be declared as an <b>extern</b> variable by some module in the user code.&nbsp; If the <b>sendtime</b> option is omitted, or if the <b>nosendtime</b> statement is seen, the RPC doesn't return until the message has been enqueued on the server's port.</font>

<p><font face="Times">The timeout value for the <b>msg_send()</b> can be controlled alternatively by using a <b>sendtime</b> parameter to the RPC.</font>

<p><br><br>

<p><font face="Helvetica"><b>The msgtype Specification</b></font>

<p><font face="Times">The <b>msgtype</b> specification has the following form:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=125></td>

<td><font face="Times"><b>msgtype</b> <i>msgtype_value</i> <b>;</b></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times"><i>msgtype_value</i> may be one of the values from the header file <b>mach/msg_type.h</b>.&nbsp; The available types are MSG_TYPE_RPC and MSG_TYPE_NORMAL.&nbsp; The MSG_TYPE_RPC is set to a correct value by default; this value normally shouldn't be changed.&nbsp; The value MSG_TYPE_NORMAL can be used to reset the <b>msgtype</b> option.</font>

<p><font face="Times">The <b>msgtype</b> value for the <b>msg_send()</b> can be controlled alternatively by using a <b>msgtype</b> parameter to the RPC.</font>

<p><br><br>

<p><font face="Helvetica"><b>The error Specification</b></font>

<p><font face="Times">The <b>error</b> specification has the following form:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=125></td>

<td><font face="Times"><b>error</b> <i>error_proc</i> <b>;</b></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The <b>error</b> specification is used to specify how message-passing errors are to be handled for operations other than routines or simple routines.&nbsp; In all types of routines, any message errors are returned in the return value of the routine.&nbsp; For operations of types other than routines, the procedure <i>error_proc</i> is called when a message error is detected.&nbsp; The procedure specified by <i>error_proc</i> has to be supplied by the user, and must be of the form:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=125></td>

<td><font face="Times">void <i>error_proc</i> (kern_return_t <i>error_code</i>)</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">If the <b>error</b> specification is omitted, <i>error_proc</i> is set to <b>MsgError()</b>.</font>

<p><br><br>

<p><font face="Helvetica"><b>The serverprefix Specification</b></font>

<p><font face="Times">The <b>serverprefix</b> specification has the following form:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=125></td>

<td><font face="Times"><b>serverprefix</b> <i>string</i> <b>;</b></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The word <b>serverprefix</b> is followed by an identifier string that will be prepended to the actual names of all the following server-side functions implementing the message operations.&nbsp; This is particularly useful when it's necessary for the user-side and server-side functions to have different names, as must be the case when a server is also a user of copies of itself.</font>

<p><br><br>

<p><font face="Helvetica"><b>The userprefix Specification</b></font>

<p><font face="Times">The <b>userprefix</b> specification has the following form:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=125></td>

<td><font face="Times"><b>userprefix</b> <i>string</i> <b>;</b></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The word <b>userprefix</b> is followed by an identifier string that will be prepended to the actual names of all the following user-side functions calling the message operations.&nbsp; <b>serverprefix</b> should usually be used when different names are needed for the user and server functions, but <b>userprefix</b> is also available for the sake of completeness.</font>

<p><br><br>

<p><font face="Helvetica"><b>The rcsid Specification</b></font>

<p><font face="Times">The <b>rcsid</b> specification has the following form:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=125></td>

<td><font face="Times"><b>rcsid</b> <i>string</i> <b>;</b></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">This specification causes a string variable <i>sys</i><b>_user_rscid</b> in the user module and <i>sys</i><b>_server_rcsid</b> in the server module to be set equal to the input string.&nbsp; The subsystem name <i>sys</i> was described earlier in this chapter, in the section &quot;Subsystem Identification.&quot;</font>

<p><br><br>

<p><font face="Helvetica" size="+1"><b>Syntax Summary</b></font>

<p><font face="Times">This section summarizes the syntax of MiG specification files.&nbsp; Note the following conventions:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">Terminal symbols (literals) are shown in boldface type.</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">Nonterminal symbols are shown in italic type.</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">Alternatives are listed on separate lines.</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">Brackets indicate zero or one occurrence of the bracketed item.&nbsp; An ellipsis (...) indicates one or more repetitions of the preceding item.&nbsp; Brackets and ellipsis combined, as in [ <i>item</i> ... ] indicate zero, one, or more repetitions of the item.</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">Types must be declared before they're used.</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">Comments may be included in a &quot;.defs&quot; file if surrounded by <b>/*</b> and <b>*/</b>.&nbsp; Comments are parsed and removed by the C preprocessor.</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times"><i>specification_file</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><i>subsystem_description</i> [ <i>waittime_description</i> ] [ <i>sendtime_description</i> ]</font><br>
<img src="../../../Images/sp.gif" width=37 height=1><font face="Times">[ <i>msgtype_description</i> ] [ <i>error_description</i> ] [ <i>server_prefix_description</i> ]</font><br>
<img src="../../../Images/sp.gif" width=37 height=1><font face="Times">[ <i>user_prefix_description</i> ] [ <i>rscid_description</i> ] [ <i>type_description</i> ...&nbsp; ]</font><br>
<img src="../../../Images/sp.gif" width=37 height=1><font face="Times">[ <i>import_declaration</i> ...&nbsp; ] <i>operation_description</i> ...</font>

<p><font face="Times"><i>subsystem_description</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>subsystem</b> <i>identifier decimal_integer</i> <b>;</b></font>

<p><font face="Times"><i>waittime_description</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>waittime</b> <i>time_value</i> <b>;</b></font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>nowaittime ;</b></font>

<p><font face="Times"><i>sendtime_description</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>sendtime</b> <i>time_value</i> <b>;</b></font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>nosendtime ;</b></font>

<p><font face="Times"><i>time_value</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>MSG_TYPE_INTEGER_32</b></font>

<p><font face="Times"><i>msgtype_description</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>msgtype</b> <i>msgtype_value</i> <b>;</b></font>

<p><font face="Times"><i>msgtype_value</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>MSG_TYPE_RPC</b></font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>MSG_TYPE_NORMAL</b></font>

<p><font face="Times"><i>error_description</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>error</b> <i>error_procedure</i> <b>;</b></font>

<p><font face="Times"><i>server_prefix_description</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>serverprefix</b> <i>identifier_string</i> <b>;</b></font>

<p><font face="Times"><i>user_prefix_description</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>userprefix</b> <i>identifier_string</i> <b>;</b></font>

<p><font face="Times"><i>rcsid_description</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>rcsid</b> <i>identifier_string</i> <b>;</b></font>

<p><font face="Times"><i>type_description</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>type</b> <i>type_definition</i> <b>;</b></font>

<p><font face="Times"><i>import_declaration</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><i>import_keyword include_name</i> <b>;</b></font>

<p><font face="Times"><i>import_keyword</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>import</b></font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>uimport</b></font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>simport</b></font>

<p><font face="Times"><i>include_name</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>&#34;</b><i>file_name</i><b>&#34;</b></font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>&lt;</b><i>file_name</i><b>&gt;</b></font>

<p><font face="Times"><i>operation_description</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><i>routine_description</i></font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><i>simpleroutine_description</i></font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><i>procedure_description</i></font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><i>simpleprocedure_description</i></font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><i>function_description</i></font>

<p><font face="Times"><i>routine_description</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>routine</b> <i>argument_list</i> <b>;</b></font>

<p><font face="Times"><i>simpleroutine_description</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>simpleroutine</b> <i>argument_list</i> <b>;</b></font>

<p><font face="Times"><i>procedure_description</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>procedure</b> <i>argument_list</i> <b>;</b></font>

<p><font face="Times"><i>simpleprocedure_description</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>simpleprocedure</b> <i>argument_list</i> <b>;</b></font>

<p><font face="Times"><i>function_description</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>function</b> <i>argument_list</i> <b>:</b> <i>type_definition</i> <b>;</b></font>

<p><font face="Times"><i>argument_list</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>(</b> [ <i>argument_definition</i> ] [ <b>;</b> <i>argument_definition</i> ] ...&nbsp; <b>)</b></font>

<p><font face="Times"><i>argument_definition</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times">[ <i>specification</i> ] <i>identifier</i> <b>:</b> <i>type_definition</i> [ <b>, dealloc</b> ]</font>

<p><font face="Times"><i>specification</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>in</b></font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>out</b></font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>inout</b></font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>requestport</b></font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>replyport</b></font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>waittime</b></font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>msgtype</b></font>

<p><font face="Times"><i>type_definition</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><i>identifier</i> <b>=</b> [ <i>^</i> ] [ <i>repetition</i> ...&nbsp; ] <i>ipc_info</i> [ <i>translation</i> ]</font>

<p><font face="Times"><i>repetition</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>array [</b> [ <i>size</i> ] <b>] of</b></font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>struct [</b> [ <i>size</i> ] <b>] of</b></font>

<p><font face="Times"><i>size</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><i>integer_expression</i></font>

<p><font face="Times"><i>integer_expression</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><i>integer_expression</i> <b>+</b> <i>integer_expression</i></font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><i>integer_expression</i></font> <img src="../../../Images/c2D.gif" width=8 height=4> <font face="Times"><i>integer_expression</i></font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><i>integer_expression</i> <b>*</b> <i>integer_expression</i></font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><i>integer_expression</i> <b>/</b> <i>integer_expression</i></font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>(</b> <i>integer_expression</i> <b>)</b></font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><i>integer</i></font>

<p><font face="Times"><i>ipc_info</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>(</b> <i>ipc_type_name</i> <b>,</b> <i>size_in_bits</i> [ <b>, dealloc</b> ] <b>)</b></font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><i>ipc_type_name</i></font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><i>identifier</i></font>

<p><font face="Times"><i>translation</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times">[ <i>input_function</i> ] [ <i>output_function</i> ] [ <i>destructor_function</i> ]</font>

<p><font face="Times"><i>input_function</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>intran :</b> <i>identifier</i></font>

<p><font face="Times"><i>output_function</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>outtran :</b> <i>identifier</i></font>

<p><font face="Times"><i>destructor_function</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><b>destructor :</b> <i>identifier</i></font>

<p><font face="Times"><i>ipc_type_name</i>:</font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><i>integer</i></font><br>
<img src="../../../Images/sp.gif" width=18 height=1><font face="Times"><i>manifest_constant</i></font>

<p><br><br><br>

<p><font face="Helvetica" size="+1"><b>Compiling MiG Specification Files</b></font>

<p><font face="Times">To compile a MiG specification file, specify the name of your &quot;.defs&quot; file (or files) and any switches as arguments to the <b>mig </b>command.&nbsp; For example:</font></td></tr>

</table>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">mig -v random.defs</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">MiG recognizes the following switches:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=124></td>

<td><font face="Times">[<b>handler</b> <i>name</i>]</font></td></tr>

</table>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=207></td>

<td><font face="Times">Specifies a name for the file that's usually called <i>sys</i><b>Server.c</b>, and specifies that it should provide a handler interface instead of the usual server interface.&nbsp; An additional header file called <i>sys</i><b>_handler.h</b> is also produced, as if the <b>sheader</b> option were specified.&nbsp; Handler interfaces are used mainly in loadable kernel servers; they're discussed in Chapter 6, &quot;Designing Loadable Kernel Servers.&quot;</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=124></td>

<td><font face="Times">[<b>header</b> <i>name</i>]</font></td></tr>

</table>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=207></td>

<td><font face="Times">Specifies a name for the file that's usually called <i>sys</i><b>.h</b>.</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=124></td>

<td nowrap><font face="Times">[<b>p</b>,<b>P</b>]</font></td>

<td><font face="Times">If <b>p</b>, use 2-byte message padding.&nbsp; You should use this option only if your server or client might be exchanging messages containing fields shorter than 4 bytes with a client or server that was built using NeXT Software Release 1.&nbsp; If <b>P</b>, use 4-byte message padding.&nbsp; The default value is <b>P</b>.&nbsp; For example, a 1-byte message element would be padded to 2 bytes if you specify <b>p</b>, or 4 bytes by default.</font></td></tr>

<tr valign=top>

<td width=124 height=12></td></tr>

<tr valign=top>

<td width=124></td>

<td nowrap><font face="Times">[<b>q</b>,<b>Q</b>]</font></td>

<td><font face="Times">If <b>q</b>, suppress warning statements.&nbsp; If <b>Q</b>, print warning statements.&nbsp; The default value is <b>Q</b>.</font></td></tr>

<tr valign=top>

<td width=124 height=12></td></tr>

<tr valign=top>

<td width=124></td>

<td nowrap><font face="Times">[<b>r</b>,<b>R</b>]</font></td>

<td><font face="Times">If <b>r</b>, use <b>msg_rpc()</b>; if <b>R</b>, use <b>msg_send()</b>, <b>msg_receive()</b> pairs.&nbsp; The default value is <b>r</b>.</font></td></tr>

<tr valign=top>

<td width=124 height=12></td></tr>

<tr valign=top>

<td width=124></td>

<td nowrap><font face="Times">[<b>s</b>,<b>S</b>]</font></td>

<td><font face="Times">If <b>s</b>, generate symbol table with <i>sys</i><b>Server.c</b> code.&nbsp; The layout of a symbol table (<b>mig_symtab_t</b>) is defined in the header file <b>mach/mig_errors.h</b>.&nbsp; If <b>S</b>, suppress the symbol table.&nbsp; The default value is <b>S</b>.&nbsp; This is useful for protection systems where access to the server's operations is dynamically specifiable or for providing a run-time indirected server call interface with <b>syscall()</b> (server-to-server calls made on behalf of a client).</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=124></td>

<td><font face="Times">[<b>server</b> <i>name</i>]</font></td></tr>

</table>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=207></td>

<td><font face="Times">Specifies a name for the file that's usually called <i>sys</i><b>Server.c</b>.</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=124></td>

<td><font face="Times">[<b>sheader</b> <i>name</i>]</font></td></tr>

</table>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=207></td>

<td><font face="Times">Specifies that MiG create an additional header file, called <i>name</i>, that's suitable for inclusion in the server defined by the &quot;.defs&quot; file.</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=124></td>

<td><font face="Times">[<b>user</b> <i>name</i>]</font></td></tr>

</table>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=207></td>

<td><font face="Times">Specifies a name for the file that's usually called <i>sys</i><b>User.c</b>.</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=124></td>

<td nowrap><font face="Times">[<b>v</b>,<b>V</b>]</font></td>

<td><font face="Times">If <b>v</b> (verbose), print routines and types as they're processed.&nbsp; If <b>V</b>, compile silently.&nbsp; The default value is <b>V</b>.</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">Any switches MiG doesn't recognize are passed to the C preprocessor.&nbsp; MiG also notices if the <b>-MD</b> option is being passed to the C preprocessor.&nbsp; If it is, MiG fixes up the resulting &quot;.d&quot; file to show the dependencies of the &quot;.h,&quot; and &quot;.c&quot; files on the &quot;.defs&quot; file and any included &quot;.defs&quot; files.&nbsp; For this feature to work correctly, the name of the subsystem must be the same as the name of the &quot;.defs&quot; file.</font>

<p><font face="Times">MiG runs the C preprocessor to process comments and preprocessor macros such as <b>#include</b> or <b>#define</b>.&nbsp; For example, the following statement can be used to include the type definitions for standard Mach and C types:</font></td></tr>

</table>

<p><img src="../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">#include &lt;mach/std_types.defs&gt;</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">The output from the C preprocessor is then passed to the program <b>migcom</b>, which generates the C files.</font></td></tr>

</table>



<p>

</body>
</html>
