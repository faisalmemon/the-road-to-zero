<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<html>
<!-- Created with LatinByrd III -->
<!-- File: /Apps/NextDev/OperatingSystem/Part3_DriverKit/Reference/Protocols/IOSCSIControllerExported.rtf -->
<!-- Date: Sun Jun 28 20:11:54 1998 -->
<head>
<title>IOSCSIControllerExported</title>
</head>

<body bgcolor="#FFFFFF" text="#000000" link="#0000FF" alink="#FF00FF" vlink="#FF0000">

<basefont size=3>

<p><font face="Times" size="-1">Copyright</font> <font size="-1">&copy;</font><font face="Times" size="-1">1995 by NeXT Computer, Inc.&nbsp; All Rights Reserved.</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Helvetica" size="+2"><b>IOSCSIControllerExported</b></font></td></tr>

</table>

<p><br><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Helvetica"><b>Adopted By:</b></font></td>

<td><font face="Times">IOSCSIController class</font></td></tr>

<tr valign=top>

<td width=105 height=12></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Helvetica"><b>Declared In:</b></font></td>

<td><font face="Times">driverkit/scsiTypes.h</font></td></tr>

</table>

<p><br><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=69></td>

<td><font face="Helvetica" size="+1"><b>Protocol Description</b></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">Indirect device drivers for devices attached to SCSI controllers use the methods in this protocol to communicate with IOSCSIController.</font></td></tr>

</table>

<p><br><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=69></td>

<td><font face="Helvetica" size="+1"><b>Method Types</b></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times">Allocating well-aligned buffers</font></td>

<td><img src="../../../../Images/c2D.gif" width=8 height=4> <font face="Times">allocateBufferOfLength:actualStart:actualLength:</font></td></tr>

</table>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=306></td>

<td><img src="../../../../Images/c2D.gif" width=8 height=4> <font face="Times">getDMAAlignment:</font></td></tr>

</table>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times">Requesting I/O</font></td>

<td><img src="../../../../Images/c2D.gif" width=8 height=4> <font face="Times">executeRequest:buffer:client:</font></td></tr>

</table>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=306></td>

<td><img src="../../../../Images/c2D.gif" width=8 height=4> <font face="Times">maxTransfer</font></td></tr>

</table>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times">Reserving SCSI targets</font></td>

<td><img src="../../../../Images/c2D.gif" width=8 height=4> <font face="Times">reserveTarget:lun:forOwner:</font></td></tr>

</table>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=306></td>

<td><img src="../../../../Images/c2D.gif" width=8 height=4> <font face="Times">releaseTarget:lun:forOwner:</font></td></tr>

</table>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times">Resetting the SCSI bus</font></td>

<td><img src="../../../../Images/c2D.gif" width=8 height=4> <font face="Times">resetSCSIBus</font></td></tr>

</table>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td><font face="Times">Getting the IOReturn equivalent of a <b>sc_status_t</b> value</font></td></tr>

</table>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=306></td>

<td><img src="../../../../Images/c2D.gif" width=8 height=4> <font face="Times">returnFromScStatus:</font></td></tr>

</table>

<p><br><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=69></td>

<td><font face="Helvetica" size="+1"><b>Instance Methods</b></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td><font face="Helvetica"><b>allocateBufferOfLength:actualStart:actualLength:</b></font></td></tr>

</table>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=124></td>

<td><img src="../../../../Images/c2D.gif" width=8 height=4> <font face="Times">(void *)<b>allocateBufferOfLength:</b>(unsigned)<i>length</i></font></td></tr>

</table>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=163></td>

<td><font face="Times"><b>actualStart:</b>(void **)<i>actualStart</i></font><br>
<font face="Times"><b>actualLength:</b>(unsigned *)<i>actualLength</i></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">Allocates and returns a pointer to some well-aligned memory. Well-aligned memory is necessary for calls to <b>executeRequest:buffer:client:</b>. You should use <i>actualStart</i> and <i>actualLength</i> when freeing the memory, as follows (italicized text delineated in angle brackets, that is &lt;&lt; &gt;&gt;, is to be filled in with device-specific code):</font></td></tr>

</table>

<p><img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">dataBuffer = [_controller allocateBufferOfLength:block_size</font><br>
<img src="../../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">actualStart:&amp;freePtr, actualLength:&amp;freeLength];</font><br>
<img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">&lt;&lt; <i>Use the buffer...</i> &gt;&gt;</font><br>
<img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">IOFree(freePtr, freeLength);</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">Here's a typical use of this method:</font></td></tr>

</table>

<p><img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">IODMAAlignment&nbsp;&nbsp;&nbsp; dmaAlign;</font><br>
<img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">unsigned int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; alignment, alignedLength, freeLength;</font><br>
<img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">void&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *alignedPtr = NULL;</font><br>
<img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">unsigned int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; maxLength; /* Max length of the current transfer */</font><br>
<img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">/* . . . */</font><br>
<img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">[_controller getDMAAlignment:&amp;dmaAlign];</font><br>
<img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">if(&lt;&lt; <i>we're doing a write</i> &gt;&gt;)</font><br>
<img src="../../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">alignment = dmaAlign.writeLength;</font><br>
<img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">else</font><br>
<img src="../../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">alignment = dmaAlign.readLength;</font>

<p><img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">if(alignment &gt; 1)</font><br>
<img src="../../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">alignedLength = IOAlign(unsigned int, maxLength, alignment);</font><br>
<img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">else</font><br>
<img src="../../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">alignedLength = maxLength;</font>

<p><img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">alignedPtr = [_controller allocateBufferOfLength:alignedLength</font><br>
<img src="../../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">actualStart:&amp;freePtr</font><br>
<img src="../../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">actualLength:&amp;freeLength];</font>

<p><img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">&lt;&lt; <i>If we're going to do a write, copy the data to alignedPtr.</i></font><br>
<img src="../../../../Images/sp.gif" width=145 height=1><font face="Courier" size="-1"><i>Set up the request and submit it, as described in the</i></font><br>
<img src="../../../../Images/sp.gif" width=145 height=1><font face="Courier" size="-1"><i>executeRequest:buffer:client: description.</i> &gt;&gt;</font><br>
<img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">&lt;&lt; <i>Do any post-I/O processing that's necessary.</i> &gt;&gt;</font>

<p><img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">IOFree(freePtr, freeLength);</font>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Helvetica"><b>See also:</b></font>&nbsp; <img src="../../../../Images/c2D.gif" width=8 height=4> <font face="Times"><b>getDMAAlignment:</b></font></td></tr>

</table>

<p><br><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td><font face="Helvetica"><b>executeRequest:buffer:client:</b></font></td></tr>

</table>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=124></td>

<td><img src="../../../../Images/c2D.gif" width=8 height=4> <font face="Times">(sc_status_t)<b>executeRequest:</b>(IOSCSIRequest *)<i>scsiRequest</i></font></td></tr>

</table>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=163></td>

<td><font face="Times"><b>buffer:</b>(void *)<i>buffer</i></font><br>
<font face="Times"><b>client:</b>(vm_task_t)<i>client</i></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">Executes the specified request. Indirect devices invoke this method whenever they need the IOSCSIController to perform I/O.</font>

<p><font face="Times">Subclasses of IOSCSIController must implement this method. A typical implementation of this method consists of the following:</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">Using <b>IOScheduleFunc()</b> to schedule a timeout function to be called after <i>scsiRequest</i><b>-&gt;timeoutLength</b> time has elapsed without I/O completion</font></td></tr>

<tr valign=top>

<td width=105 height=9></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">Sending the command descriptor block (CDB) specified in <i>scsiRequest</i> to the controller</font></td></tr>

<tr valign=top>

<td width=105 height=9></td></tr>

<tr valign=top>

<td width=105></td>

<td nowrap><font face="Times"><img src="../../../../Images/bullet1.gif" width=4 height=8 vspace=3></font></td>

<td><font face="Times">When the I/O has completed, unscheduling the timeout function</font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">This method should return <i>scsiRequest</i><b>-&gt;driverStatus</b>, which should be set by the part of the driver that detected I/O completion or timeout.</font>

<p><font face="Times">Indirect devices use this method as shown below (italicized text delineated in angle brackets, that is &lt;&lt; &gt;&gt;, is to be filled in with device-specific code):</font></td></tr>

</table>

<p><img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">void&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *alignedPtr = NULL;</font><br>
<img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">unsigned int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; alignedLength;</font><br>
<img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">IOSCSIRequest&nbsp;&nbsp;&nbsp;&nbsp; request;</font><br>
<img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">cdb_t&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cdb;</font>

<p><img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1"><i>/* . . . */</i></font><br>
<img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">if (&lt;&lt; <i>we're going to be doing DMA</i> &gt;&gt;) {</font><br>
<img src="../../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">&lt;&lt; <i>Ensure we have a well-aligned buffer that starts at alignedPtr</i></font><br>
<img src="../../../../Images/sp.gif" width=173 height=1><font face="Courier" size="-1"><i>and continues for alignedLength bytes.&nbsp; See the</i></font><br>
<img src="../../../../Images/sp.gif" width=173 height=1><font face="Courier" size="-1"><i>allocateBuffer: description for one way of doing this.</i> &gt;&gt;</font><br>
<img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">} else {</font><br>
<img src="../../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">alignedLength = 0;</font><br>
<img src="../../../../Images/sp.gif" width=152 height=1><font face="Courier" size="-1">alignedPtr = 0;</font><br>
<img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">}</font>

<p><img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">bzero(&amp;request, sizeof(request));</font><br>
<img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">request.target = [self target];</font><br>
<img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">request.lun&nbsp;&nbsp;&nbsp; = [self lun];</font><br>
<img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">request.read = &lt;&lt; <i>YES if this is a read; NO otherwise</i> &gt;&gt;;</font><br>
<img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">request.maxTransfer = alignedLength;</font><br>
<img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">request.timeoutLength = &lt;&lt; <i>some timeout length, in seconds</i> &gt;&gt;;</font><br>
<img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">request.disconnect = &lt;&lt; <i>1 if allowed to disconnect; otherwise 0</i> &gt;&gt;;</font><br>
<img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">request.cdb = cdb;</font><br>
<img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">&lt;&lt; <i>Set up the cdb (command descriptor block) field. The type of this</i></font><br>
<img src="../../../../Images/sp.gif" width=145 height=1><font face="Courier" size="-1"><i>field, cdb_t, is defined and described in the header file</i></font><br>
<img src="../../../../Images/sp.gif" width=145 height=1><font face="Courier" size="-1"><i>bsd/dev/scsireg.h.</i> &gt;&gt;</font>

<p><img src="../../../../Images/sp.gif" width=124 height=1><font face="Courier" size="-1">rtn = [_controller executeRequest:&amp;request</font><br>
<img src="../../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">buffer:alignedPtr</font><br>
<img src="../../../../Images/sp.gif" width=180 height=1><font face="Courier" size="-1">client:IOVmTaskSelf()];</font>

<p><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td><font face="Helvetica"><b>getDMAAlignment:</b></font></td></tr>

</table>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=124></td>

<td><img src="../../../../Images/c2D.gif" width=8 height=4> <font face="Times">(void)<b>getDMAAlignment:</b>(IODMAAlignment *)<i>alignment</i></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">Returns the DMA alignment requirements for the current architecture. IOSCSIController subclasses can override this method to specify any device-specific alignment requirements. See the description of <b>allocateBufferOfLength:actualStart:actualLength:</b> for an example of using this method.</font>

<p><font face="Helvetica"><b>See also:</b></font>&nbsp; <img src="../../../../Images/c2D.gif" width=8 height=4> <font face="Times"><b>allocateBufferOfLength:actualStart:actualLength:</b></font></td></tr>

</table>

<p><br><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td><font face="Helvetica"><b>maxTransfer</b></font></td></tr>

</table>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=124></td>

<td><img src="../../../../Images/c2D.gif" width=8 height=4> <font face="Times">(unsigned)<b>maxTransfer</b></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">Returns the maximum number of bytes per DMA transfer. This is the maximum transfer that can be requested in a call to <b>executeRequest:buffer:client:</b>.</font></td></tr>

</table>

<p><br><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td><font face="Helvetica"><b>releaseTarget:lun:forOwner:</b></font></td></tr>

</table>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=124></td>

<td><img src="../../../../Images/c2D.gif" width=8 height=4> <font face="Times">(void)<b>releaseTarget:</b>(unsigned char)<i>target</i></font></td></tr>

</table>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=163></td>

<td><font face="Times"><b>lun:</b>(unsigned char)<i>lun</i></font><br>
<font face="Times"><b>forOwner:</b><i>owner</i></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">Releases the specified target/lun pair. If <i>owner</i> hasn't reserved the pair, this method uses IOLog to print an error message.</font>

<p><font face="Helvetica"><b>See also:</b></font>&nbsp; <img src="../../../../Images/c2D.gif" width=8 height=4> <font face="Times"><b>reserveTarget:lun:forOwner:</b></font></td></tr>

</table>

<p><br><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td><font face="Helvetica"><b>reserveTarget:lun:forOwner:</b></font></td></tr>

</table>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=124></td>

<td><img src="../../../../Images/c2D.gif" width=8 height=4> <font face="Times">(int)<b>reserveTarget:</b>(unsigned char)<i>target</i></font></td></tr>

</table>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=163></td>

<td><font face="Times"><b>lun:</b>(unsigned char)<i>lun</i></font><br>
<font face="Times"><b>forOwner:</b><i>owner</i></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">Reserves the specified target/lun pair, if it isn't already reserved. This method is invoked by a client (for example, a SCSIDisk instance) to mark a particular target/lun as being in use by that client. Usually, this happens at <b>probe:</b> time; however, the SCSIGeneric driver uses this method at other times.</font>

<p><font face="Times">This method returns a nonzero value if the target/lun pair is already reserved. Otherwise, it returns zero.</font>

<p><font face="Helvetica"><b>See also:</b></font>&nbsp; <img src="../../../../Images/c2D.gif" width=8 height=4> <font face="Times"><b>releaseTarget:lun:forOwner:</b></font></td></tr>

</table>

<p><br><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td><font face="Helvetica"><b>resetSCSIBus</b></font></td></tr>

</table>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=124></td>

<td><img src="../../../../Images/c2D.gif" width=8 height=4> <font face="Times">(sc_status_t)<b>resetSCSIBus</b></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">Resets the SCSI bus. Subclasses of IOSCSIController must implement this method so that it resets the SCSI bus. The <b>sc_status_t</b> enumerated type is defined and described in the header file <b>bsd/dev/scsireg.h</b>.</font></td></tr>

</table>

<p><br><br>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=105></td>

<td><font face="Helvetica"><b>returnFromScStatus:</b></font></td></tr>

</table>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=124></td>

<td><img src="../../../../Images/c2D.gif" width=8 height=4> <font face="Times">(IOReturn)<b>returnFromScStatus:</b>(sc_status_t)<i>sc_status</i></font></td></tr>

</table>

<p>

<table cellspacing=0 cellpadding=0>

<tr valign=top>

<td width=106></td>

<td><font face="Times">Returns the IOReturn value corresponding to the specified <b>sc_status_t</b> value. The <b>sc_status_t</b> enumerated type is defined and described in the header file <b>bsd/dev/scsireg.h</b>.</font></td></tr>

</table>



<p>

</body>
</html>
